var P=(o,r,i)=>new Promise((u,l)=>{var g=s=>{try{a(i.next(s))}catch(d){l(d)}},m=s=>{try{a(i.throw(s))}catch(d){l(d)}},a=s=>s.done?u(s.value):Promise.resolve(s.value).then(g,m);a((i=i.apply(o,r)).next())});import{W as U,l as y,ac as z,aW as O,ad as k,q as M,o as c,j as p,u as _,A as f,Z as n,a9 as D,n as T,aG as J,h as w,X as A,V as S,H as W,aX as Z,B as H,x as X,a8 as V,w as C,Y,ai as j,J as F,m as $,t as B}from"./main-Dpl-JOF2.js";import{l as Q}from"./stripe.esm-D4yu_pm0.js";import{R as ee,S as te}from"./StripeLogo-De_iztuU.js";(function(){try{var o=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},r=new Error().stack;r&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[r]="c6ae9c48-c50f-4f48-98d0-44793cbf7f07",o._sentryDebugIdIdentifier="sentry-dbid-c6ae9c48-c50f-4f48-98d0-44793cbf7f07")}catch(i){}})();{var N=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};N._sentryModuleMetadata=N._sentryModuleMetadata||{},N._sentryModuleMetadata[new Error().stack]=Object.assign({},N._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const ae={key:0,class:"mt-8 flex justify-center"},se={class:"mt-8"},ne={__name:"BuyCreditsStripe",props:{amount:{type:Number,default:0},minimumAmount:{type:Number,default:0}},emits:["success"],setup(o,{emit:r}){const i=o,u=r,l=U("team"),g=y("Get Amount"),m=y(null),a=y(null),s=y(null),d=y(!1),x=y(null),h=y(null),R=y(null),t=y(!1),e=y(null),v=z({url:"press.api.billing.create_payment_intent_for_buying_credits",params:{amount:i.amount},validate(){if(i.amount<i.minimumAmount&&!l.doc.erpnext_partner)throw new k(`Amount must be greater than or equal to ${i.minimumAmount}`)},onSuccess(E){return P(this,null,function*(){g.value="Setting up Stripe";let{publishable_key:I,client_secret:q}=E;m.value=q,x.value=yield Q(I),R.value=x.value.elements();const L={base:{color:"#171717",fontFamily:["ui-sans-serif","system-ui","-apple-system","BlinkMacSystemFont",'"Segoe UI"',"Roboto",'"Helvetica Neue"',"Arial",'"Noto Sans"',"sans-serif",'"Apple Color Emoji"','"Segoe UI Emoji"','"Segoe UI Symbol"','"Noto Color Emoji"'].join(", "),fontSmoothing:"antialiased",fontSize:"13px","::placeholder":{color:"#C7C7C7"}},invalid:{color:"#7C7C7C",iconColor:"#7C7C7C"}};h.value=R.value.create("card",{hidePostalCode:!0,style:L,classes:{complete:"",focus:"bg-gray-100"}}),g.value="Add Card Details",O(()=>{h.value.mount(e.value)}),h.value.addEventListener("change",G=>{var K;a.value=((K=G.error)==null?void 0:K.message)||null}),h.value.addEventListener("ready",()=>{t.value=!0})})}});function b(){return P(this,null,function*(){d.value=!0;let E=yield x.value.confirmCardPayment(m.value,{payment_method:{card:h.value}});E.error?(s.value=E.error.message,d.value=!1):(S.success("Payment processed successfully, we will update your account shortly on confirmation from Stripe"),d.value=!1,u("success"),s.value=null)})}return(E,I)=>(c(),M("div",null,[p("label",{class:T(["block",{"pointer-events-none h-0.5 opacity-0":g.value!="Add Card Details","mt-4":g.value=="Add Card Details"}])},[I[1]||(I[1]=p("span",{class:"text-sm leading-4 text-gray-700"}," Credit or Debit Card ",-1)),p("div",{class:"form-input mt-2 block w-full pl-3",ref_key:"cardElementRef",ref:e},null,512),f(n(D),{class:"mt-1",message:a.value},null,8,["message"])],2),g.value=="Setting up Stripe"?(c(),M("div",ae,[f(n(J),{class:"h-4 w-4 text-gray-700"})])):_("",!0),f(n(D),{class:"mt-2",message:n(v).error||s.value},null,8,["message"]),p("div",se,[g.value=="Get Amount"?(c(),w(n(A),{key:0,class:"w-full",size:"md",variant:"solid",label:"Proceed to payment using Stripe",loading:n(v).loading,onClick:I[0]||(I[0]=q=>n(v).submit())},null,8,["loading"])):g.value=="Add Card Details"?(c(),w(n(A),{key:1,class:"w-full",size:"md",variant:"solid",label:"Make payment via Stripe",loading:d.value,onClick:b},null,8,["loading"])):_("",!0)])]))}},oe={key:0,class:"mt-2.5 inline-flex gap-2 text-base text-gray-700"},re={class:"mt-8"},le={__name:"BuyCreditsRazorpay",props:{amount:{type:Number,default:0},minimumAmount:{type:Number,default:0}},emits:["success"],setup(o,{emit:r}){const i=o,u=r,l=U("team"),g=y(!1),m=y(!1),a=y(null);W(()=>{a.value=document.createElement("script"),a.value.setAttribute("src","https://checkout.razorpay.com/v1/checkout.js"),a.value.async=!0,document.head.appendChild(a.value)}),Z(()=>{var t;(t=a.value)==null||t.remove()});const s=z({url:"press.api.billing.create_razorpay_order",params:{amount:i.amount},onSuccess:t=>x(t),validate:()=>{if(i.amount<i.minimumAmount)throw new k("Amount less than minimum amount required")}}),d=z({url:"press.api.billing.handle_razorpay_payment_failed",onSuccess:()=>{console.log("Payment Failed.")}});function x(t){var b;const e={key:t.key_id,order_id:t.order_id,name:"Easytouch Cloud",image:"https://frappe.io/files/cloud.png",prefill:{email:(b=l.doc)==null?void 0:b.user},handler:R,theme:{color:"#171717"}},v=new Razorpay(e);v.open(),v.on("payment.failed",h)}function h(t){d.submit({response:t}),S.error("Payment failed")}function R(){g.value=!0,u("success"),S.success("Payment successful")}return(t,e)=>(c(),M("div",null,[n(l).doc.currency==="INR"?(c(),M("span",oe,[f(n(H),{name:"info",class:"my-1 h-4"}),e[1]||(e[1]=p("span",{class:"leading-5"}," If you select Razorpay, you can pay using Credit Card, Debit Card, Net Banking, UPI, Wallets, etc. If you are using Net Banking, it may take upto 5 days for balance to reflect. ",-1))])):_("",!0),f(n(D),{class:"mt-3",message:n(s).error},null,8,["message"]),p("div",re,[g.value?(c(),w(n(A),{key:1,class:"w-full",size:"md",label:"Confirming payment",variant:"solid",loading:m.value},null,8,["loading"])):(c(),w(n(A),{key:0,class:"w-full",size:"md",variant:"solid",label:"Proceed to payment using Razorpay",loading:n(s).loading,onClick:e[0]||(e[0]=v=>n(s).submit())},null,8,["loading"]))])]))}},ue={name:"BuyPrepaidCreditsMpesa",props:{amount:{type:Number,required:!0},amountKES:{type:Number,required:!0,default:1},minimumAmount:{type:Number,required:!0,default:10},exchangeRate:{type:Number,required:!0,default:129}},data(){return{paymentErrorMessage:null,errorMessage:null,paymentInProgress:!1,partnerInput:"",phoneNumberInput:this.$team.doc.mpesa_phone_number||"",taxIdInput:this.$team.doc.mpesa_tax_id||"",teams:[],taxPercentage:1,amountWithTax:0,showTaxInfo:!1,maximumAmount:15e4}},resources:{requestForPayment(){return{url:"press.api.billing.request_for_payment",params:{request_amount:this.amountKES,sender:this.phoneNumberInput,partner:this.partnerInput.value,tax_id:this.taxIdInput,amount_with_tax:this.amountWithTax,phone_number:this.phoneNumberInput,amount_usd:this.amount,exchange_rate:this.exchangeRate},validate(){const r=/^[A-Z]\d{9}[A-Z]$/;if(this.amount<this.minimumAmount)throw new k(`Amount is less than the minimum allowed: ${this.minimumAmount}`);if(this.amount>this.maximumAmount)throw new k(`Amount is more than the maximum allowed: ${this.maximumAmount}`);if(!this.partnerInput.value||!this.phoneNumberInput)throw new k("Both partner and phone number are required for payment.");if(!this.taxIdInput)throw new k("Tax ID is required for payment.");if(this.taxIdInput&&!r.test(this.taxIdInput))throw new k("Invalid Tax Id")},onSuccess(r){return P(this,null,function*(){(r==null?void 0:r.ResponseCode)==="0"?S.success(r.ResponseDescription||"Please follow the instructions on your phone"):S.error(r.ResponseDescription||"Something went wrong. Please try again.")})}}}},methods:{onPayClick(){return P(this,null,function*(){this.paymentInProgress=!0;try{const o=yield this.$resources.requestForPayment.submit();if(o.ResponseCode==="0")S.success(o.Success||"Payment Initiated successfully, check your phone for instructions"),this.$emit("success");else throw new Error(o.ResponseDescription||"Payment failed")}catch(o){this.paymentErrorMessage=o.message||"Payment failed. Please try again.",S.error(this.paymentErrorMessage)}finally{this.paymentInProgress=!1}})},fetchTeams(){return P(this,null,function*(){try{const o=yield j({url:"/api/method/press.api.regional_payments.mpesa.utils.display_mpesa_payment_partners",method:"GET"});Array.isArray(o)?this.teams=o:console.log("No Data")}catch(o){this.errorMessage=`Failed to fetch teams ${o.message}`}})},totalAmountWithTax(){const o=this.amountKES+this.amountKES*this.taxPercentage/100;this.amountWithTax=Math.round(o)},fetchTaxPercentage(){return P(this,null,function*(){try{const o=yield j({url:"/api/method/press.api.regional_payments.mpesa.utils.get_tax_percentage",method:"GET",params:{payment_partner:this.partnerInput.value}});this.taxPercentage=o}catch(o){this.errorMessage=`Failed to fetch tax percentage ${o.message}`}})}},watch:{partnerInput(){this.fetchTaxPercentage(),this.totalAmountWithTax(),this.showTaxInfo=!0},amountKES(){this.totalAmountWithTax()},taxPercentage(){this.totalAmountWithTax()}},mounted(){this.fetchTeams()}},ie={class:"block mt-4"},me={class:"flex gap-5 col-2"},ce={key:0,class:"flex col-2 gap-5"},de={class:"mt-4 flex w-full justify-end"};function pe(o,r,i,u,l,g){const m=D,a=V,s=A;return c(),M("div",null,[p("label",ie,[r[3]||(r[3]=p("span",{class:"text-sm leading-4 text-gray-700"},null,-1)),f(m,{class:"mt-1",message:l.paymentErrorMessage},null,8,["message"])]),f(m,{class:"mt-2",message:l.errorMessage},null,8,["message"]),f(a,{type:"autocomplete",options:l.teams,size:"sm",variant:"subtle",placeholder:"Payment Partner",disabled:!1,label:"Select Payment Partner",modelValue:l.partnerInput,"onUpdate:modelValue":r[0]||(r[0]=d=>l.partnerInput=d),class:"mb-5"},null,8,["options","modelValue"]),p("div",me,[f(a,{label:"M-Pesa Phone Number",modelValue:this.phoneNumberInput,"onUpdate:modelValue":r[1]||(r[1]=d=>this.phoneNumberInput=d),name:"phone_number",autocomplete:"off",class:"mb-5",type:"number",placeholder:"e.g 123456789"},null,8,["modelValue"]),f(a,{label:"Tax ID",modelValue:this.taxIdInput,"onUpdate:modelValue":r[2]||(r[2]=d=>this.taxIdInput=d),name:"tax_id",autocomplete:"off",class:"mb-5",type:"string",placeholder:"e.g A123456789A"},null,8,["modelValue"])]),l.showTaxInfo?(c(),M("div",ce,[f(a,{label:"Tax(%)",disabled:"",modelValue:l.taxPercentage,type:"number"},null,8,["modelValue"]),f(a,{label:"Total Amount With Tax",disabled:"",modelValue:l.amountWithTax.toFixed(2),type:"number"},null,8,["modelValue"])])):_("",!0),p("div",de,[f(s,{variant:"solid",onClick:g.onPayClick,loading:l.paymentInProgress},{default:C(()=>r[4]||(r[4]=[Y(" Make payment via M-Pesa ")])),_:1},8,["onClick","loading"])]),l.errorMessage?(c(),w(m,{key:1,message:l.errorMessage},null,8,["message"])):_("",!0)])}const ye=X(ue,[["render",pe]]),fe={class:"grid w-4 place-items-center text-sm text-gray-700"},ge={class:"grid w-4 place-items-center text-sm text-gray-700"},he={class:"mt-4"},ve={class:"mt-1.5 grid grid-cols-1 gap-2 sm:grid-cols-2"},Pe={__name:"PrepaidCreditsForm",props:{minimumAmount:Number},emits:["success"],setup(o,{emit:r}){const i=r,u=U("team"),l=o,g=z({url:"press.api.billing.total_unpaid_amount",cache:"totalUnpaidAmount",auto:!0}),m=F(()=>{var v;if(l.minimumAmount)return l.minimumAmount;if(!u.doc)return 0;const t=g.data||0,e=((v=u.doc)==null?void 0:v.currency)=="INR"?410:5;return Math.ceil(t&&t>0?t:e)}),a=y(m.value),s=y("");$(m,()=>{a.value=m.value});const d=F(()=>{var e;const t=a.value||0;return((e=u.doc)==null?void 0:e.currency)==="INR"?(t+t*(u.doc.billing_info.gst_percentage||0)).toFixed(2):t}),x=y(),h=y(0);$(a,()=>{let t=a.value*h.value;s.value==="M-Pesa"&&t!==a.value&&(x.value=t)}),$(x,()=>{let t=x.value/h.value;s.value==="M-Pesa"&&t!==a.value&&(a.value=t)}),$(s,()=>{s.value==="M-Pesa"&&(x.value=a.value*h.value)});const R=()=>P(this,null,function*(){try{const t="usd",e="kes",b=`https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${t}.json`;let I=(yield(yield fetch(b)).json())[t][e];h.value=Math.round(I)}catch(t){console.error(t)}});return W(()=>{R()}),(t,e)=>{var v;return c(),M("div",null,[p("div",null,[f(n(V),{label:`Amount (Minimum Amount: ${m.value})`,class:"mb-3",modelValue:a.value,"onUpdate:modelValue":e[0]||(e[0]=b=>a.value=b),modelModifiers:{number:!0},name:"amount",type:"number",min:m.value},{prefix:C(()=>[p("div",fe,B(n(u).doc.currency==="INR"?"₹":"$"),1)]),_:1},8,["label","modelValue","min"]),n(u).doc.currency==="INR"?(c(),w(n(V),{key:0,label:`Total Amount + GST (${((v=n(u).doc)==null?void 0:v.billing_info.gst_percentage)*100}%)`,disabled:"",modelValue:d.value,name:"total",type:"number"},{prefix:C(()=>[p("div",ge,B(n(u).doc.currency==="INR"?"₹":"$"),1)]),_:1},8,["label","modelValue"])):_("",!0),n(u).doc.country==="Kenya"&&s.value==="M-Pesa"?(c(),w(n(V),{key:1,label:`Amount in KES (Exchange Rate: ${Math.round(h.value)} against 1 USD)`,disabled:"",modelValue:x.value,name:"amount_in_kes",type:"number"},{prefix:C(()=>e[10]||(e[10]=[p("div",{class:"-ml-1 grid w-4 place-items-center text-sm text-gray-700"},B("Ksh"),-1)])),_:1},8,["label","modelValue"])):_("",!0)]),p("div",he,[e[12]||(e[12]=p("div",{class:"text-xs text-gray-600"},"Select Payment Gateway",-1)),p("div",ve,[n(u).doc.currency==="INR"||n(u).doc.razorpay_enabled?(c(),w(n(A),{key:0,size:"lg",class:T({"border-[1.5px] border-gray-700":s.value==="Razorpay"}),onClick:e[1]||(e[1]=b=>s.value="Razorpay")},{default:C(()=>[f(ee,{class:"w-24"})]),_:1},8,["class"])):_("",!0),f(n(A),{size:"lg",class:T({"border-[1.5px] border-gray-700":s.value==="Stripe"}),onClick:e[2]||(e[2]=b=>s.value="Stripe")},{default:C(()=>[f(te,{class:"h-7 w-24"})]),_:1},8,["class"]),n(u).doc.country==="Kenya"&&n(u).doc.mpesa_enabled?(c(),w(n(A),{key:1,size:"lg",class:T({"border-[1.5px] border-gray-700":s.value==="M-Pesa"}),onClick:e[3]||(e[3]=b=>s.value="M-Pesa")},{default:C(()=>e[11]||(e[11]=[p("img",{class:"h-14 w-24",src:"/assets/press/images/mpesa-logo.svg",alt:"M-pesa Logo"},null,-1)])),_:1},8,["class"])):_("",!0)])]),s.value==="Stripe"?(c(),w(ne,{key:0,amount:a.value,minimumAmount:m.value,onSuccess:e[4]||(e[4]=()=>i("success")),onCancel:e[5]||(e[5]=b=>t.show=!1)},null,8,["amount","minimumAmount"])):_("",!0),s.value==="Razorpay"?(c(),w(le,{key:1,amount:a.value,minimumAmount:m.value,onSuccess:e[6]||(e[6]=()=>i("success")),onCancel:e[7]||(e[7]=b=>t.show=!1)},null,8,["amount","minimumAmount"])):_("",!0),s.value==="M-Pesa"?(c(),w(ye,{key:2,amount:a.value,amountKES:x.value,minimumAmount:m.value,exchangeRate:h.value,onSuccess:e[8]||(e[8]=()=>i("success")),onCancel:e[9]||(e[9]=b=>t.show=!1)},null,8,["amount","amountKES","minimumAmount","exchangeRate"])):_("",!0)])}}};export{Pe as _};
//# sourceMappingURL=PrepaidCreditsForm-DIaFhUMJ.js.map
