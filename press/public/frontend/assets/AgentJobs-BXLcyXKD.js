import _ from"./CardWithDetails-8Q6clK2F.js";import{x as h,r as c,h as u,o,w as a,j as m,q as p,u as g,F as D,v as N,n as $,A as d,a5 as A,X as v,Y as S}from"./main-Dpl-JOF2.js";import{_ as C}from"./ListItem-CkkFcC1t.js";import{S as B}from"./StepsDetail-844EGZPD.js";(function(){try{var e=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},t=new Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="4103b612-b76e-4c8e-b1b6-579893a6d6d6",e._sentryDebugIdIdentifier="sentry-dbid-4103b612-b76e-4c8e-b1b6-579893a6d6d6")}catch(s){}})();{var b=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};b._sentryModuleMetadata=b._sentryModuleMetadata||{},b._sentryModuleMetadata[new Error().stack]=Object.assign({},b._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const U={name:"JobsDetail",props:["jobName"],components:{StepsDetail:B},inject:["viewportWidth"],resources:{job(){return{url:"press.api.site.job",params:{job:this.jobName},auto:!!this.jobName}}},data(){return{runningJob:null}},computed:{job(){return this.$resources.job.data},subtitle(){if(this.job){if(this.job.status=="Success")return`Completed ${this.formatDate(this.job.creation,"relative")} in ${this.$formatDuration(this.job.duration,"hh:mm:ss")}`;if(this.job.status=="Undelivered")return"Job failed to start"}},steps(){if(this.job)return this.job.steps.map((e,t)=>({name:e.step_name,status:e.status,output:e.output,running:this.isStepRunning(e),completed:this.isStepCompleted(e,t)}))}},mounted(){this.$socket.emit("doc_subscribe","Agent Job",this.jobName),this.$socket.on("agent_job_update",this.onAgentJobUpdate)},unmounted(){this.$socket.emit("doc_unsubscribe","Agent Job",this.jobName),this.$socket.off("agent_job_update",this.onAgentJobUpdate),this.runningJob=null},methods:{onAgentJobUpdate(e){e.id===this.jobName&&(this.runningJob=e)},isStepRunning(e){if(!this.runningJob)return!1;let t=this.runningJob.steps.find(s=>s.name==e.step_name);return(t==null?void 0:t.status)==="Running"},isStepCompleted(e,t){return this.runningJob?this.runningJob.current.index>t:e.status==="Success"}}};function x(e,t,s,f,r,i){const l=c("StepsDetail");return o(),u(l,{showDetails:i.job,loading:e.$resources.job.loading,title:i.job?i.job.job_type:"",subtitle:i.subtitle,steps:i.steps},null,8,["showDetails","loading","title","subtitle","steps"])}const I=h(U,[["render",x]]),R={name:"AgentJobs",props:["title","subtitle","resource","jobName","jobRoute"],components:{JobsDetail:I,CardWithDetails:_},data(){return{runningJob:null}},resources:{jobs(){return this.resource()}},mounted(){this.$socket.on("agent_job_update",this.onAgentJobUpdate)},unmounted(){this.$socket.off("agent_job_update",this.onAgentJobUpdate)},methods:{onAgentJobUpdate(e){e.id===this.jobName&&(this.runningJob=e,this.runningJob.status==="Success"&&setTimeout(()=>{this.$resources.jobs.reset(),this.$resources.jobs.reload()},1e3))}}},E={key:0,class:"py-3"};function L(e,t,s,f,r,i){const l=A,j=C,J=c("router-link"),w=v,y=c("JobsDetail"),k=_;return o(),u(k,{title:s.title,subtitle:s.subtitle,showDetails:s.jobName},{details:a(()=>[d(y,{jobName:s.jobName},null,8,["jobName"])]),default:a(()=>[m("div",null,[(o(!0),p(D,null,N(e.$resources.jobs.data,n=>(o(),u(J,{class:$(["block cursor-pointer rounded-md px-2.5",s.jobName===n.name?"bg-gray-100":"hover:bg-gray-50"]),key:n.name,to:s.jobRoute(n)},{default:a(()=>[d(j,{title:n.job_type,description:e.formatDate(n.creation)},{actions:a(()=>[r.runningJob&&r.runningJob.id==n.name&&r.runningJob.status!=="Success"?(o(),u(l,{key:0,class:"whitespace-nowrap",label:r.runningJob.status},null,8,["label"])):n.status!="Success"?(o(),u(l,{key:1,class:"whitespace-nowrap",label:n.status},null,8,["label"])):g("",!0)]),_:2},1032,["title","description"]),t[1]||(t[1]=m("div",{class:"border-b"},null,-1))]),_:2},1032,["class","to"]))),128)),e.$resources.jobs.hasNextPage?(o(),p("div",E,[d(w,{loading:e.$resources.jobs.list.loading,loadingText:"Loading...",onClick:t[0]||(t[0]=n=>e.$resources.jobs.next())},{default:a(()=>t[2]||(t[2]=[S(" Load more ")])),_:1},8,["loading"])])):g("",!0)])]),_:1},8,["title","subtitle","showDetails"])}const M=h(R,[["render",L]]);export{M as A};
//# sourceMappingURL=AgentJobs-BXLcyXKD.js.map
