import{_ as F}from"./Card-BCzTSeNK.js";import{x as E,h as m,o as a,w as p,j as l,q as o,A as i,ae as O,F as y,v as P,t as c,y as R,B as z,a5 as L,u as h,X as U,Y as g,C as M,aA as j,a8 as q,n as K,af as X,a9 as Y}from"./main-Dpl-JOF2.js";import{_ as k}from"./ChangeAppPlanSelector-B7RAZX-J.js";import{_ as v}from"./CommitTag-C7m6nG0N.js";import{F as H}from"./fuse.basic.esm-KoNXVm3X.js";import{n as J}from"./toast-Dk0nDfLL.js";import"./AppPlanCard-CuGgjNKV.js";import"./FeatureList-DXsHFT_A.js";(function(){try{var e=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},n=new Error().stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="33669714-6325-4723-9bce-72b6e26980a6",e._sentryDebugIdIdentifier="sentry-dbid-33669714-6325-4723-9bce-72b6e26980a6")}catch(d){}})();{var f=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};f._sentryModuleMetadata=f._sentryModuleMetadata||{},f._sentryModuleMetadata[new Error().stack]=Object.assign({},f._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const Q={name:"SiteAppsAndSubscriptions",props:["site","siteName"],data(){return{showInstallAppsDialog:!1,showPlanSelectionDialog:!1,showAppPlanChangeDialog:!1,appToChangePlan:null,newAppPlan:"",appToInstall:null,selectedPlan:null,selectedPlanIsFree:null,searchTerm:"",filteredOptions:[]}},components:{ChangeAppPlanSelector:k,CommitTag:v},resources:{marketplaceSubscriptions(){return{url:"press.api.marketplace.get_marketplace_subscriptions_for_site",params:{site:this.siteName},auto:!0}},changePlan(){return{url:"press.api.marketplace.change_app_plan",onSuccess(){this.showAppPlanChangeDialog=!1,this.$resources.marketplaceSubscriptions.fetch()},onError(e){this.showAppPlanChangeDialog=!1,J({title:e,color:"red",icon:"x"})}}},installedApps(){return{url:"press.api.site.installed_apps",params:{name:this.siteName},auto:!0}},availableApps(){return{url:"press.api.site.available_apps",params:{name:this.siteName}}},installApp(){return{url:"press.api.site.install_app",makeParams(){var e;return{name:this.siteName,app:(e=this.appToInstall)==null?void 0:e.app,plan:this.selectedPlan}},validate(){if(this.showPlanSelectionDialog&&!this.selectedPlan)return"Please aaa select a plan to continue"},onSuccess(){this.showPlanSelectionDialog=!1,this.showInstallAppsDialog=!1,this.$emit("app-installed")}}},uninstallApp:{url:"press.api.site.uninstall_app",onSuccess(){this.$emit("app-uninstalled")}}},computed:{availableApps(){return this.$resources.availableApps.data&&(this.fuse=new H(this.$resources.availableApps.data,{limit:20,keys:["title"]}),this.filteredOptions=this.$resources.availableApps.data),this.$resources.availableApps},marketplaceSubscriptions(){return this.$resources.marketplaceSubscriptions.data&&!this.$resources.marketplaceSubscriptions.loading?this.$resources.marketplaceSubscriptions.data:[]}},methods:{updateSearchTerm(e){e?this.filteredOptions=this.fuse.search(e).map(n=>n.item):this.filteredOptions=this.$resources.availableApps.data},subscribe(e){this.showPlanSelectionDialog=!0},changeAppPlan(e){this.currentSubscription=e.subscription.name,this.currentAppPlan=e.subscription.marketplace_app_plan,this.newAppPlan=this.currentAppPlan,this.appToChangePlan={name:e.subscription.document_name,title:e.app_title,image:e.app_image,plan:e.subscription.plan,subscription:e.subscription.name,billing_type:e.billing_type},this.showAppPlanChangeDialog=!0},switchToNewPlan(){this.$account.hasBillingInfo||(window.location="/dashboard-old/billing"),this.currentAppPlan!==this.newAppPlan?this.$resources.changePlan.submit({subscription:this.appToChangePlan.subscription,new_plan:this.newAppPlan}):this.showAppPlanChangeDialog=!1},installApp(e){var n;if(this.appToInstall=e,e.has_plans_available){this.showInstallAppsDialog=!1,this.showPlanSelectionDialog=!0;return}this.$resources.installApp.submit({name:this.siteName,app:(n=this.appToInstall)==null?void 0:n.app,plan:this.selectedPlan})},handlePlanSelection(){this.$resources.installApp.submit()},dropdownItems(e){return[{label:"View in Desk",onClick:()=>window.open(`${window.location.protocol}//${window.location.host}/app/app/${e.name}`,"_blank"),condition:()=>this.$account.user.user_type=="System User"},{label:"Remove App",onClick:()=>this.confirmRemoveApp(e),condition:()=>e.app!="frappe"},{label:"Visit Repo",onClick:()=>window.open(`${e.repository_url}/tree/${e.branch}`,"_blank")}].filter(Boolean)},confirmRemoveApp(e){this.$confirm({title:"Remove App",message:`Are you sure you want to uninstall app ${e.title} from <b>site</b>?<br><br>
				<b>All doctypes and modules pertaining to this app will be removed.</b>`,actionLabel:"Remove App",actionColor:"red",action:n=>{n(),this.$resources.uninstallApp.submit({name:this.site.name,app:e.app})}})}}},W={key:1,class:"divide-y"},Z={class:"w-2/6"},G={class:"flex flex-row items-center"},ee={class:"font-medium text-gray-900"},se={class:"mt-1 flex items-center space-x-2"},ne={class:"truncate text-base text-gray-600 hover:text-clip"},te={class:"w-1/6"},ae={key:0},le={key:1},oe={class:"w-1/6"},ie={key:0},re={key:1},pe={class:"w-1/6"},ce={key:0},ue={key:1},de={class:"ml-auto flex items-center space-x-2"},me={class:"flex flex-col"},_e={class:"w-2/4 text-base font-semibold"},he={class:"w-1/4 text-base text-gray-700"},ge={key:1,class:"text-base text-gray-600"},fe={key:2},be={class:"mt-4 text-sm text-gray-700"};function we(e,n,d,Ae,t,u){const _=U,C=O,S=v,x=R,D=z,I=L,T=M,V=q,$=X,b=j,A=k,N=Y,B=F;return a(),m(B,{title:"Apps",subtitle:"Apps installed on your site"},{actions:p(()=>{var s;return[i(_,{onClick:n[0]||(n[0]=()=>{t.showInstallAppsDialog=!0,e.$resources.availableApps.fetch()}),disabled:((s=d.site)==null?void 0:s.status)==="Suspended"},{default:p(()=>n[7]||(n[7]=[g(" Add App ")])),_:1},8,["disabled"])]}),default:p(()=>[n[12]||(n[12]=l("div",{class:"flex text-base text-gray-600"},[l("span",{class:"w-2/6"},"App"),l("span",{class:"hidden w-1/6 md:inline"},"Plan"),l("span",{class:"w-1/6"},"Status"),l("span",{class:"hidden w-1/6 md:inline"},"Price"),l("span")],-1)),e.$resources.installedApps.loading?(a(),m(C,{key:0,class:"m-2 mt-4"})):(a(),o("div",W,[(a(!0),o(y,null,P(e.$resources.installedApps.data,s=>(a(),o("div",{class:"flex items-center py-4 text-base text-gray-600",key:s.name},[l("div",Z,[l("div",G,[l("div",ee,c(s.title),1),i(x,{text:s.commit_message},{default:p(()=>[i(S,{class:"ml-2",tag:s.tag||s.hash.substr(0,7),link:`${s.repository_url}/commit/${s.hash}`},null,8,["tag","link"])]),_:2},1032,["text"])]),l("div",se,[i(D,{name:"git-branch",class:"h-4 w-4"}),l("div",ne,c(s.repository_owner)+"/"+c(s.repository)+":"+c(s.branch),1)])]),l("div",te,[s.subscription.plan?(a(),o("span",ae,c(s.plan_info.plan),1)):(a(),o("span",le,"-"))]),l("div",oe,[s.subscription.enabled?(a(),o("span",ie,[i(I,{label:"Enabled"})])):(a(),o("span",re,"-"))]),l("div",pe,[s.plan_info?(a(),o("span",ce,c(s.is_free?"Free":e.$planTitle(s.plan_info)),1)):(a(),o("span",ue,"-"))]),l("div",de,[s.plan_info?(a(),m(_,{key:0,onClick:r=>u.changeAppPlan(s)},{default:p(()=>n[8]||(n[8]=[g("Change Plan")])),_:2},1032,["onClick"])):h("",!0),!s.plan_info&&s.subscription_available?(a(),m(_,{key:1,onClick:()=>{t.showPlanSelectionDialog=!0,t.appToInstall=s}},{default:p(()=>n[9]||(n[9]=[g("Subscribe")])),_:2},1032,["onClick"])):h("",!0),i(T,{options:u.dropdownItems(s),right:""},{default:p(({open:r})=>[i(_,{icon:"more-horizontal"})]),_:2},1032,["options"])])]))),128))])),i(b,{options:{title:"Install an app on your site",position:"top",size:"lg"},modelValue:t.showInstallAppsDialog,"onUpdate:modelValue":n[2]||(n[2]=s=>t.showInstallAppsDialog=s)},{"body-content":p(()=>{var s;return[i(V,{class:"mb-2",placeholder:"Search for Apps",onInput:n[1]||(n[1]=r=>u.updateSearchTerm(r.target.value))}),u.availableApps.data&&u.availableApps.data.length?(a(),o("div",{key:0,class:K(["max-h-96 space-y-3 divide-y overflow-auto p-1",t.filteredOptions.length>7?"pr-2":""])},[(a(!0),o(y,null,P(t.filteredOptions,r=>(a(),o("div",{class:"flex items-center rounded-md border px-4 py-3 shadow ring-1 ring-gray-300",key:r.name},[l("div",me,[l("div",_e,c(r.title),1),l("div",he,c(r.repository_owner)+":"+c(r.branch),1)]),i(_,{class:"ml-auto",onClick:w=>u.installApp(r),loading:e.$resources.installApp.loading&&t.appToInstall.name==r.name},{default:p(()=>n[10]||(n[10]=[g(" Install ")])),_:2},1032,["onClick","loading"])]))),128))],2)):(a(),o("div",ge," No apps available to install ")),(s=d.site)!=null&&s.group?(a(),o("div",fe,[l("p",be,[i($,{to:`/groups/${d.site.group}/apps`,class:"font-medium"},{default:p(()=>n[11]||(n[11]=[g(" Add more apps to your bench ")])),_:1},8,["to"])])])):h("",!0)]}),_:1},8,["modelValue"]),i(b,{modelValue:t.showPlanSelectionDialog,"onUpdate:modelValue":n[4]||(n[4]=s=>t.showPlanSelectionDialog=s),options:{title:"Select app plan",size:"2xl",actions:[{label:"Proceed",variant:"solid",onClick:e.$resources.installApp.submit}]}},{"body-content":p(()=>{var s,r;return[(s=t.appToInstall)!=null&&s.app?(a(),m(A,{key:0,app:t.appToInstall.app,frappeVersion:(r=d.site)==null?void 0:r.frappe_version,class:"mb-9",onChange:n[3]||(n[3]=w=>{t.selectedPlan=w.name,t.selectedPlanIsFree=w.price_usd===0})},null,8,["app","frappeVersion"])):h("",!0),i(N,{message:e.$resources.installApp.error},null,8,["message"])]}),_:1},8,["modelValue","options"]),i(b,{options:{title:"Select Plan",size:"2xl",actions:[{label:"Change Plan",variant:"solid",onClick:u.switchToNewPlan,loading:e.$resources.changePlan.loading}]},modelValue:t.showAppPlanChangeDialog,"onUpdate:modelValue":n[6]||(n[6]=s=>t.showAppPlanChangeDialog=s)},{"body-content":p(()=>[t.appToChangePlan?(a(),m(A,{key:0,onChange:n[5]||(n[5]=s=>{t.newAppPlan=s.name,e.newAppPlanIsFree=s.is_free}),app:t.appToChangePlan.name,currentPlan:t.appToChangePlan.plan,frappeVersion:d.site.frappe_version},null,8,["app","currentPlan","frappeVersion"])):h("",!0)]),_:1},8,["options","modelValue"])]),_:1})}const Ie=E(Q,[["render",we]]);export{Ie as default};
//# sourceMappingURL=SiteAppsAndSubscriptions-Drm13qdN.js.map
