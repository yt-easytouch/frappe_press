{"version":3,"file":"SiteVersionUpgradeDialog-CbZTr466.js","sources":["../../../../dashboard/src2/components/site/SiteVersionUpgradeDialog.vue"],"sourcesContent":["<template>\n\t<Dialog\n\t\tv-model=\"show\"\n\t\t@close=\"resetValues\"\n\t\t:options=\"{ title: 'Upgrade Site Version' }\"\n\t>\n\t\t<template #body-content>\n\t\t\t<div class=\"space-y-4\">\n\t\t\t\t<p v-if=\"$site.doc?.group_public && nextVersion\" class=\"text-base\">\n\t\t\t\t\tThe site <b>{{ $site.doc.host_name }}</b> will be upgraded to\n\t\t\t\t\t<b>{{ nextVersion }}</b>\n\t\t\t\t</p>\n\t\t\t\t<FormControl\n\t\t\t\t\tv-else-if=\"privateReleaseGroups.length > 0 && nextVersion\"\n\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t:label=\"`Please select a ${nextVersion} bench group to upgrade your site from ${$site.doc.version}`\"\n\t\t\t\t\tclass=\"w-full\"\n\t\t\t\t\ttype=\"autocomplete\"\n\t\t\t\t\t:options=\"privateReleaseGroups\"\n\t\t\t\t\tv-model=\"privateReleaseGroup\"\n\t\t\t\t/>\n\t\t\t\t<DateTimeControl\n\t\t\t\t\tv-if=\"($site.doc.group_public && nextVersion) || benchHasCommonServer\"\n\t\t\t\t\tv-model=\"targetDateTime\"\n\t\t\t\t\tlabel=\"Schedule Time\"\n\t\t\t\t/>\n\t\t\t\t<FormControl\n\t\t\t\t\tv-if=\"($site.doc.group_public && nextVersion) || benchHasCommonServer\"\n\t\t\t\t\tlabel=\"Skip failing patches if any\"\n\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\tv-model=\"skipFailingPatches\"\n\t\t\t\t/>\n\t\t\t\t<FormControl\n\t\t\t\t\tv-if=\"($site.doc.group_public && nextVersion) || benchHasCommonServer\"\n\t\t\t\t\tlabel=\"Skip backups\"\n\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\tv-model=\"skipBackups\"\n\t\t\t\t\tclass=\"ml-4\"\n\t\t\t\t/>\n\t\t\t\t<div\n\t\t\t\t\tv-if=\"skipBackups\"\n\t\t\t\t\tclass=\"flex items-center rounded bg-gray-50 p-4 text-sm text-gray-700\"\n\t\t\t\t>\n\t\t\t\t\t<i-lucide-info class=\"mr-2 h-4 w-8\" />\n\t\t\t\t\tBackups will not be taken during the upgrade process and incase of any\n\t\t\t\t\tfailure rollback will not be possible.\n\t\t\t\t</div>\n\t\t\t\t<p v-if=\"message && !errorMessage\" class=\"text-sm text-gray-700\">\n\t\t\t\t\t{{ message }}\n\t\t\t\t</p>\n\t\t\t\t<ErrorMessage :message=\"errorMessage\" />\n\t\t\t</div>\n\t\t</template>\n\t\t<template\n\t\t\tv-if=\"$site.doc?.group_public || privateReleaseGroups.length\"\n\t\t\t#actions\n\t\t>\n\t\t\t<Button\n\t\t\t\tv-if=\"!$site.doc.group_public\"\n\t\t\t\tclass=\"mb-2 w-full\"\n\t\t\t\t:disabled=\"\n\t\t\t\t\tbenchHasCommonServer || !privateReleaseGroup.value || !nextVersion\n\t\t\t\t\"\n\t\t\t\tlabel=\"Add Server to Bench Group\"\n\t\t\t\t@click=\"$resources.addServerToReleaseGroup.submit()\"\n\t\t\t\t:loading=\"\n\t\t\t\t\t$resources.addServerToReleaseGroup.loading ||\n\t\t\t\t\t$resources.validateGroupforUpgrade.loading\n\t\t\t\t\"\n\t\t\t/>\n\t\t\t<Button\n\t\t\t\tclass=\"w-full\"\n\t\t\t\tvariant=\"solid\"\n\t\t\t\tlabel=\"Upgrade\"\n\t\t\t\t:disabled=\"\n\t\t\t\t\t((!benchHasCommonServer || !privateReleaseGroup.value) &&\n\t\t\t\t\t\t!$site.doc.group_public) ||\n\t\t\t\t\t!nextVersion\n\t\t\t\t\"\n\t\t\t\t:loading=\"\n\t\t\t\t\t$resources.versionUpgrade.loading ||\n\t\t\t\t\t$resources.validateGroupforUpgrade.loading\n\t\t\t\t\"\n\t\t\t\t@click=\"$resources.versionUpgrade.submit()\"\n\t\t\t/>\n\t\t</template>\n\t</Dialog>\n</template>\n\n<script>\nimport { getCachedDocumentResource } from 'frappe-ui';\nimport { toast } from 'vue-sonner';\nimport DateTimeControl from '../DateTimeControl.vue';\n\nexport default {\n\tname: 'SiteVersionUpgradeDialog',\n\tprops: ['site'],\n\tcomponents: { DateTimeControl },\n\tdata() {\n\t\treturn {\n\t\t\tshow: true,\n\t\t\ttargetDateTime: null,\n\t\t\tprivateReleaseGroup: {\n\t\t\t\tvalue: '',\n\t\t\t\tlabel: ''\n\t\t\t},\n\t\t\tskipBackups: false,\n\t\t\tskipFailingPatches: false,\n\t\t\tbenchHasCommonServer: false\n\t\t};\n\t},\n\twatch: {\n\t\tprivateReleaseGroup: {\n\t\t\thandler(privateReleaseGroup) {\n\t\t\t\tif (privateReleaseGroup?.value) {\n\t\t\t\t\tthis.$resources.validateGroupforUpgrade.submit({\n\t\t\t\t\t\tname: this.site,\n\t\t\t\t\t\tgroup_name: privateReleaseGroup.value\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\tcomputed: {\n\t\tnextVersion() {\n\t\t\tconst nextNumber = Number(this.$site.doc?.version.split(' ')[1]);\n\t\t\tif (\n\t\t\t\tisNaN(nextNumber) ||\n\t\t\t\tthis.$site.doc?.version === this.$site.doc?.latest_frappe_version\n\t\t\t)\n\t\t\t\treturn null;\n\n\t\t\treturn `Version ${nextNumber + 1}`;\n\t\t},\n\t\tprivateReleaseGroups() {\n\t\t\treturn this.$resources.getPrivateGroups.data;\n\t\t},\n\t\tmessage() {\n\t\t\tif (this.$site.doc?.version === this.$site.doc?.latest_frappe_version) {\n\t\t\t\treturn 'This site is already on the latest version.';\n\t\t\t} else if (this.$site.doc?.version === 'Nightly') {\n\t\t\t\treturn \"This site is on a nightly version and doesn't need to be upgraded.\";\n\t\t\t} else if (\n\t\t\t\t!this.$site.doc?.group_public &&\n\t\t\t\tthis.privateReleaseGroups.length === 0\n\t\t\t)\n\t\t\t\treturn `Your team doesn't own any private bench groups available to upgrade this site to ${this.nextVersion}.`;\n\t\t\telse if (!this.privateReleaseGroup?.value) {\n\t\t\t\treturn '';\n\t\t\t} else if (!this.$site.doc?.group_public && !this.benchHasCommonServer)\n\t\t\t\treturn `The selected bench group and your site doesn't have a common server. Please add site's server to the bench.`;\n\t\t\telse if (!this.$site.doc?.group_public && this.benchHasCommonServer)\n\t\t\t\treturn `The selected bench group and your site have a common server. You can proceed with the upgrade to ${this.nextVersion}.`;\n\t\t\telse return '';\n\t\t},\n\t\tdatetimeInIST() {\n\t\t\tif (!this.targetDateTime) return null;\n\t\t\tconst datetimeInIST = this.$dayjs(this.targetDateTime).format(\n\t\t\t\t'YYYY-MM-DDTHH:mm'\n\t\t\t);\n\n\t\t\treturn datetimeInIST;\n\t\t},\n\t\terrorMessage() {\n\t\t\treturn (\n\t\t\t\tthis.$resources.versionUpgrade.error ||\n\t\t\t\tthis.$resources.validateGroupforUpgrade.error ||\n\t\t\t\tthis.$resources.addServerToReleaseGroup.error ||\n\t\t\t\tthis.$resources.getPrivateGroups.error\n\t\t\t);\n\t\t},\n\t\t$site() {\n\t\t\treturn getCachedDocumentResource('Site', this.site);\n\t\t}\n\t},\n\tresources: {\n\t\tversionUpgrade() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.version_upgrade',\n\t\t\t\tparams: {\n\t\t\t\t\tname: this.site,\n\t\t\t\t\tdestination_group: this.privateReleaseGroup.value,\n\t\t\t\t\tskip_failing_patches: this.skipFailingPatches,\n\t\t\t\t\tskip_backups: this.skipBackups,\n\t\t\t\t\tscheduled_datetime: this.datetimeInIST\n\t\t\t\t},\n\t\t\t\tonSuccess() {\n\t\t\t\t\ttoast.success(\"Site's version upgrade has been scheduled.\");\n\t\t\t\t\tthis.show = false;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\t\tgetPrivateGroups() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.get_private_groups_for_upgrade',\n\t\t\t\tparams: {\n\t\t\t\t\tname: this.site,\n\t\t\t\t\tversion: this.$site.doc?.version\n\t\t\t\t},\n\t\t\t\tauto:\n\t\t\t\t\tthis.$site.doc?.version &&\n\t\t\t\t\t!this.$site.doc?.group_public &&\n\t\t\t\t\tthis.$site.doc?.version !== 'Nightly',\n\t\t\t\ttransform(data) {\n\t\t\t\t\treturn data.map(group => ({\n\t\t\t\t\t\tlabel: group.title || group.name,\n\t\t\t\t\t\tdescription: group.name,\n\t\t\t\t\t\tvalue: group.name\n\t\t\t\t\t}));\n\t\t\t\t},\n\t\t\t\tinitialData: []\n\t\t\t};\n\t\t},\n\t\taddServerToReleaseGroup() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.add_server_to_release_group',\n\t\t\t\tparams: {\n\t\t\t\t\tname: this.site,\n\t\t\t\t\tgroup_name: this.privateReleaseGroup.value\n\t\t\t\t},\n\t\t\t\tonSuccess(data) {\n\t\t\t\t\ttoast.success('Server Added to the Bench Group', {\n\t\t\t\t\t\tdescription: `Added a server to ${this.privateReleaseGroup.value} bench. Please wait for the deploy to be completed.`\n\t\t\t\t\t});\n\t\t\t\t\tthis.$router.push({\n\t\t\t\t\t\tname: 'Release Group Job',\n\t\t\t\t\t\tparams: {\n\t\t\t\t\t\t\tname: this.privateReleaseGroup.value,\n\t\t\t\t\t\t\tid: data\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tthis.resetValues();\n\t\t\t\t\tthis.show = false;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\t\tvalidateGroupforUpgrade() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.validate_group_for_upgrade',\n\t\t\t\tonSuccess(data) {\n\t\t\t\t\tthis.benchHasCommonServer = data;\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t},\n\tmethods: {\n\t\tresetValues() {\n\t\t\tthis.targetDateTime = null;\n\t\t\tthis.privateReleaseGroup = {\n\t\t\t\tlabel: '',\n\t\t\t\tvalue: ''\n\t\t\t};\n\t\t\tthis.benchHasCommonServer = false;\n\t\t\tthis.$resources.getPrivateGroups.reset();\n\t\t}\n\t}\n};\n</script>\n"],"names":["_sfc_main","privateReleaseGroup","nextNumber","_b","_c","_a","_d","_e","_f","_g","data","group","toast","_hoisted_1","$data","_cache","$event","$options","_createSlots","_withCtx","_createElementVNode","_openBlock","_createElementBlock","_hoisted_2","_createTextVNode","_toDisplayString","_createCommentVNode","_hoisted_3","_ctx"],"mappings":"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"}