import{_ as q}from"./Card-BCzTSeNK.js";import{x as k,h as i,o as r,w as c,q as l,u,j as a,a8 as C,A as g,F as L,v as j,t as y,a5 as D,X as F,Y as h,aA as M}from"./main-Dpl-JOF2.js";import{_ as v}from"./CommitTag-C7m6nG0N.js";import{n as b}from"./toast-Dk0nDfLL.js";(function(){try{var e=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},t=new Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="357f3f2d-be11-47a7-8859-4810626e109e",e._sentryDebugIdIdentifier="sentry-dbid-357f3f2d-be11-47a7-8859-4810626e109e")}catch(n){}})();{var m=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};m._sentryModuleMetadata=m._sentryModuleMetadata||{},m._sentryModuleMetadata[new Error().stack]=Object.assign({},m._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const U={props:{app:{type:Object}},data(){return{showRejectionFeedbackDialog:!1,rejectionFeedback:"",selectedSource:null}},mounted(){this.$socket.emit("doctype_subscribe","App Release"),this.$socket.on("list_update",this.releaseStateUpdate),this.sources.length>0&&(this.selectedSource=this.sources[0].source)},beforeMount(){this.$socket.emit("doctype_unsubscribe","App Release"),this.$socket.off("list_update",this.releaseStateUpdate)},resources:{releases(){return{type:"list",doctype:"App Release",url:"press.api.marketplace.releases",filters:{app:this.app.app,source:this.selectedSource},start:0,pageLength:15,auto:!0}},appSource(){return{url:"press.api.marketplace.get_app_source",params:{name:this.selectedSource}}},latestApproved(){return{url:"press.api.marketplace.latest_approved_release",params:{source:this.selectedSource},auto:!0}},createApprovalRequest(){return{url:"press.api.marketplace.create_approval_request",onSuccess(){this.resetReleaseListState()},onError(e){e.messages.some(n=>n.includes("already awaiting approval"))?b({title:"Request already exists",message:e.messages.join(`
`),color:"red",icon:"x"}):b({title:"Error",message:e.messages.join(`
`),color:"red",icon:"x"})}}},cancelApprovalRequest(){return{url:"press.api.marketplace.cancel_approval_request",onSuccess(){this.resetReleaseListState()}}}},methods:{isPublishable(e){return e.status=="Draft"&&(!this.latestApprovedOn||this.$date(e.creation)>this.latestApprovedOn)},createApprovalRequest(e){let{app:t}=this.app;this.$resources.createApprovalRequest.submit({name:t,app_release:e})},cancelApprovalRequest(e){let{app:t}=this.app;this.$resources.cancelApprovalRequest.submit({marketplace_app:t,app_release:e})},resetReleaseListState(){this.$resources.releases.reload(),this.$resources.latestApproved.reload()},showFeedback(e){this.showRejectionFeedbackDialog=!0,this.rejectionFeedback=e.reason_for_rejection},confirmApprovalRequest(e){this.$confirm({title:"Publish Release",message:"Are you sure you want to publish this release to marketplace? Upon confirmation, the release will be sent for approval by the review team.",actionLabel:"Publish",action:t=>{t(),this.createApprovalRequest(e)}})},confirmCancelRequest(e){this.$confirm({title:"Cancel Release Approval Request",message:"Are you sure you want to <strong>cancel</strong> the publish request for this release?",actionLabel:"Proceed",actionColor:"red",action:t=>{t(),this.cancelApprovalRequest(e)}})},getCommitUrl(e){return this.repoUrl?`${this.repoUrl}/commit/${e}`:""},releaseStateUpdate(e){this.selectedSource&&e.source==this.selectedSource&&this.resetReleaseListState()}},computed:{releasesList(){return this.$resources.releases.data?this.$resources.releases.data:[]},latestApprovedOn(){if(this.$resources.latestApproved.data&&!this.$resources.latestApproved.loading)return this.$date(this.$resources.latestApproved.data.creation)},sources(){let e=[];for(let t of this.app.sources)e.find(n=>n.source===t.source)||e.push(t);return e},repoUrl(){var e,t;return(t=(e=this.$resources.appSource)==null?void 0:e.data)==null?void 0:t.repository_url}},watch:{selectedSource(e){e&&(this.resetReleaseListState(),this.$resources.appSource.submit({name:e}))}},components:{CommitTag:v}},V={key:0},P={class:"flex flex-row items-baseline"},E={key:1},B={key:2},N={key:3},T={class:"divide-y"},O={class:"max-w-md truncate text-base font-medium text-gray-700 md:col-span-2"},I={class:"hidden text-gray-600 md:inline"},H={class:"text-right"},K=["innerHTML"],X={class:"py-3"};function Y(e,t,n,R,p,o){const _=C,x=v,$=D,d=F,w=M,S=q;return r(),i(S,{title:"App Releases"},{default:c(()=>[o.sources.length?(r(),l("div",V,[a("div",P,[o.sources.length>1?(r(),i(_,{key:0,type:"select",modelValue:p.selectedSource,"onUpdate:modelValue":t[0]||(t[0]=s=>p.selectedSource=s),options:o.sources.map(s=>({label:`${s.source_information.repository}:${s.source_information.branch}`,value:s.source}))},null,8,["modelValue","options"])):u("",!0)])])):u("",!0),o.sources.length?o.releasesList.length===0&&!e.$resources.releases.list.loading?(r(),l("div",B,t[4]||(t[4]=[a("p",{class:"mt-3 text-center text-lg text-gray-600"}," No app releases have been created for this version. ",-1)]))):(r(),l("div",N,[a("div",T,[t[9]||(t[9]=a("div",{class:"grid grid-cols-3 items-center gap-x-8 py-4 text-base text-gray-600 md:grid-cols-6"},[a("span",{class:"md:col-span-2"},"Commit Message"),a("span",{class:"hidden md:inline"},"Tag"),a("span",{class:"hidden md:inline"},"Author"),a("span",null,"Status"),a("span")],-1)),(r(!0),l(L,null,j(o.releasesList,s=>(r(),l("div",{key:s.name,class:"grid grid-cols-3 items-center gap-x-8 py-4 text-base text-gray-900 md:grid-cols-6"},[a("p",O,y(s.message),1),g(x,{class:"hidden md:flex",tag:s.tag||s.hash.slice(0,6),link:o.getCommitUrl(s.hash)},null,8,["tag","link"]),a("span",I,y(s.author),1),a("span",null,[s.status!="Draft"?(r(),i($,{key:0,label:s.status},null,8,["label"])):u("",!0)]),a("span",H,[o.isPublishable(s)?(r(),i(d,{key:0,loading:e.$resources.createApprovalRequest.loading||e.$resources.latestApproved.loading,onClick:f=>o.confirmApprovalRequest(s.name)},{default:c(()=>t[5]||(t[5]=[h(" Publish ")])),_:2},1032,["loading","onClick"])):s.status=="Awaiting Approval"?(r(),i(d,{key:1,onClick:f=>o.confirmCancelRequest(s.name)},{default:c(()=>t[6]||(t[6]=[h("Cancel")])),_:2},1032,["onClick"])):s.status=="Rejected"?(r(),i(d,{key:2,onClick:f=>o.showFeedback(s)},{default:c(()=>t[7]||(t[7]=[h("View Feedback")])),_:2},1032,["onClick"])):u("",!0)])]))),128)),g(w,{options:{title:"Reason for Rejection"},modelValue:p.showRejectionFeedbackDialog,"onUpdate:modelValue":t[1]||(t[1]=s=>p.showRejectionFeedbackDialog=s)},{"body-content":c(()=>[a("div",{class:"prose text-lg",innerHTML:p.rejectionFeedback},null,8,K)]),_:1},8,["modelValue"]),a("div",X,[e.$resources.releases.hasNextPage?(r(),i(d,{key:0,onClick:t[2]||(t[2]=s=>e.$resources.releases.next()),loading:e.$resources.releases.list.loading,loadingText:"Loading..."},{default:c(()=>t[8]||(t[8]=[h("Load More")])),_:1},8,["loading"])):u("",!0)])])])):(r(),l("div",E,t[3]||(t[3]=[a("p",{class:"mt-3 text-center text-lg text-gray-600"}," No published source exist for this app. Please contact support to publish a version of this app. ",-1)])))]),_:1})}const A=k(U,[["render",Y]]),z={name:"MarketplaceAppDeployment",props:{app:Object},components:{MarketplaceAppReleaseList:A}},J={key:0};function Q(e,t,n,R,p,o){const _=A;return n.app?(r(),l("div",J,[g(_,{app:n.app},null,8,["app"])])):u("",!0)}const te=k(z,[["render",Q]]);export{te as default};
//# sourceMappingURL=MarketplaceAppDeployment-BZQr0V1S.js.map
