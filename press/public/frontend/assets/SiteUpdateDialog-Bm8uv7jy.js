import{x as U,r as p,h as r,o as l,w as h,X as x,q as m,A as n,F as T,j as _,a8 as V,a9 as S,aA as D,bg as f,V as $,av as v,c0 as I}from"./main-Dpl-JOF2.js";import{D as B}from"./DateTimeControl-DSJ0TMcX.js";import{G as C}from"./GenericList-TeL894c5.js";(function(){try{var t=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},e=new Error().stack;e&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[e]="c958b8ca-1041-4ab2-93fd-ee1d4ca347ba",t._sentryDebugIdIdentifier="sentry-dbid-c958b8ca-1041-4ab2-93fd-ee1d4ca347ba")}catch(u){}})();{var d=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};d._sentryModuleMetadata=d._sentryModuleMetadata||{},d._sentryModuleMetadata[new Error().stack]=Object.assign({},d._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const F={name:"SiteUpdateDialog",props:{site:{type:String,required:!0},existingUpdate:String},components:{GenericList:C,DateTimeControl:B},data(){return{show:!0,skipFailingPatches:!1,scheduledTime:"",skipBackups:!1}},resources:{siteUpdate(){return{url:"press.api.client.get",params:{doctype:"Site Update",name:this.existingUpdate},auto:!!this.existingUpdate,onSuccess:t=>{this.initializeValues(t)}}}},computed:{scheduledTimeInIST(){if(this.scheduledTime)return I(this.scheduledTime).format("YYYY-MM-DDTHH:mm")},scheduledTimeInLocal(){return f(this.scheduledTime).format("lll")},listOptions(){return{data:this.updatableApps.filter(t=>t.current_hash!==t.next_hash),columns:[{label:"App",fieldname:"app",format(t,e){return e.title||t}},{label:"Current Version",type:"Badge",format(t,e){return e.will_branch_change?e.current_branch:e.current_tag||e.current_hash.slice(0,7)},link(t,e){if(e.will_branch_change)return`${e.repository_url}/tree/${e.current_branch}`;if(e.current_tag)return`${e.repository_url}/releases/tag/${e.current_tag}`;if(e.current_hash)return`${e.repository_url}/commit/${e.current_hash}`}},{label:"Next Version",type:"Badge",format(t,e){return e.will_branch_change?e.branch:e.next_tag||e.next_hash.slice(0,7)},link(t,e){if(e.will_branch_change)return`${e.repository_url}/tree/${e.branch}`;if(e.next_tag)return`${e.repository_url}/releases/tag/${e.next_tag}`;if(e.next_hash)return`${e.repository_url}/commit/${e.next_hash}`}}]}},updatableApps(){if(!this.$site.doc.update_information.update_available)return[];let t=this.$site.doc.update_information.installed_apps.map(e=>e.app);return this.$site.doc.update_information.apps.filter(e=>t.includes(e.app))},$site(){return v("Site",this.site)},siteUpdate(){return this.$resources.siteUpdate},dialogTitle(){return this.existingUpdate?"Edit Scheduled Update":"Updates Available"}},methods:{scheduleUpdate(){this.$site.scheduleUpdate.submit({skip_failing_patches:this.skipFailingPatches,skip_backups:this.skipBackups,scheduled_time:this.scheduledTimeInIST},{onSuccess:()=>{this.$site.reload(),this.show=!1,this.$router.push({name:"Site Detail Updates"})}})},editUpdate(){$.promise(this.$site.editScheduledUpdate.submit({name:this.existingUpdate,skip_failing_patches:this.skipFailingPatches,skip_backups:this.skipBackups,scheduled_time:this.scheduledTimeInIST}),{loading:"Editing scheduled update...",success:()=>(this.show=!1,this.$site.reload(),this.siteUpdate.reload(),"Scheduled update edited successfully"),error:t=>t.messages.length?t.messages[0]:t.message||"Failed to edit scheduled update"})},initializeValues(t){this.skipFailingPatches=t.skipped_failing_patches,this.skipBackups=t.skipped_backups,this.scheduledTime=f(t.scheduled_time).format("YYYY-MM-DDTHH:mm")}}},A={class:"mt-4 flex flex-col space-y-4"},E={class:"flex flex-col space-y-2"},Y={key:1,class:"text-center text-base text-gray-600"};function M(t,e,u,P,s,i){const g=p("GenericList"),k=p("DateTimeControl"),c=V,b=S,o=x,y=D;return l(),r(y,{modelValue:s.show,"onUpdate:modelValue":e[3]||(e[3]=a=>s.show=a),options:{title:i.dialogTitle,size:"2xl"}},{"body-content":h(()=>[i.updatableApps.length>0?(l(),m(T,{key:0},[n(g,{options:i.listOptions},null,8,["options"]),_("div",A,[n(k,{modelValue:s.scheduledTime,"onUpdate:modelValue":e[0]||(e[0]=a=>s.scheduledTime=a),label:"Schedule Time"},null,8,["modelValue"]),_("div",E,[n(c,{label:"Skip failing patches if any",type:"checkbox",modelValue:s.skipFailingPatches,"onUpdate:modelValue":e[1]||(e[1]=a=>s.skipFailingPatches=a)},null,8,["modelValue"]),n(c,{label:"Skip taking backup for this update (If the update fails, rollback will not occur)",type:"checkbox",modelValue:s.skipBackups,"onUpdate:modelValue":e[2]||(e[2]=a=>s.skipBackups=a)},null,8,["modelValue"])])])],64)):(l(),m("div",Y," No apps to update ")),n(b,{class:"mt-4",message:i.$site.scheduleUpdate.error},null,8,["message"])]),actions:h(()=>[u.existingUpdate?(l(),r(o,{key:0,class:"w-full",variant:"solid",label:"Edit Update",onClick:i.editUpdate},null,8,["onClick"])):(l(),r(o,{key:1,class:"w-full",variant:"solid",loading:i.$site.scheduleUpdate.loading,label:`Update ${s.scheduledTime?`at ${i.scheduledTimeInLocal}`:"Now"}`,onClick:i.scheduleUpdate},null,8,["loading","label","onClick"]))]),_:1},8,["modelValue","options"])}const w=U(F,[["render",M]]);export{w as default};
//# sourceMappingURL=SiteUpdateDialog-Bm8uv7jy.js.map
