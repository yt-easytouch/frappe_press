{"version":3,"file":"PrepaidCreditsForm-DIaFhUMJ.js","sources":["../../../../dashboard/src2/components/billing/BuyCreditsStripe.vue","../../../../dashboard/src2/components/billing/BuyCreditsRazorpay.vue","../../../../dashboard/src2/components/billing/mpesa/BuyPrepaidCreditsMpesa.vue","../../../../dashboard/src2/components/billing/PrepaidCreditsForm.vue"],"sourcesContent":["<template>\n\t<div>\n\t\t<label\n\t\t\tclass=\"block\"\n\t\t\t:class=\"{\n\t\t\t\t'pointer-events-none h-0.5 opacity-0': step != 'Add Card Details',\n\t\t\t\t'mt-4': step == 'Add Card Details'\n\t\t\t}\"\n\t\t>\n\t\t\t<span class=\"text-sm leading-4 text-gray-700\">\n\t\t\t\tCredit or Debit Card\n\t\t\t</span>\n\t\t\t<div class=\"form-input mt-2 block w-full pl-3\" ref=\"cardElementRef\"></div>\n\t\t\t<ErrorMessage class=\"mt-1\" :message=\"cardErrorMessage\" />\n\t\t</label>\n\n\t\t<div v-if=\"step == 'Setting up Stripe'\" class=\"mt-8 flex justify-center\">\n\t\t\t<Spinner class=\"h-4 w-4 text-gray-700\" />\n\t\t</div>\n\t\t<ErrorMessage\n\t\t\tclass=\"mt-2\"\n\t\t\t:message=\"createPaymentIntent.error || errorMessage\"\n\t\t/>\n\t\t<div class=\"mt-8\">\n\t\t\t<Button\n\t\t\t\tv-if=\"step == 'Get Amount'\"\n\t\t\t\tclass=\"w-full\"\n\t\t\t\tsize=\"md\"\n\t\t\t\tvariant=\"solid\"\n\t\t\t\tlabel=\"Proceed to payment using Stripe\"\n\t\t\t\t:loading=\"createPaymentIntent.loading\"\n\t\t\t\t@click=\"createPaymentIntent.submit()\"\n\t\t\t/>\n\t\t\t<Button\n\t\t\t\tv-else-if=\"step == 'Add Card Details'\"\n\t\t\t\tclass=\"w-full\"\n\t\t\t\tsize=\"md\"\n\t\t\t\tvariant=\"solid\"\n\t\t\t\tlabel=\"Make payment via Stripe\"\n\t\t\t\t:loading=\"paymentInProgress\"\n\t\t\t\t@click=\"onBuyClick\"\n\t\t\t/>\n\t\t</div>\n\t</div>\n</template>\n<script setup>\nimport { Button, ErrorMessage, Spinner, createResource } from 'frappe-ui';\nimport { loadStripe } from '@stripe/stripe-js';\nimport { ref, nextTick, inject } from 'vue';\nimport { toast } from 'vue-sonner';\nimport { DashboardError } from '../../utils/error';\n\nconst props = defineProps({\n\tamount: {\n\t\ttype: Number,\n\t\tdefault: 0\n\t},\n\tminimumAmount: {\n\t\ttype: Number,\n\t\tdefault: 0\n\t}\n});\n\nconst emit = defineEmits(['success']);\n\nconst team = inject('team');\n\nconst step = ref('Get Amount');\nconst clientSecret = ref(null);\nconst cardErrorMessage = ref(null);\nconst errorMessage = ref(null);\nconst paymentInProgress = ref(false);\n\nconst stripe = ref(null);\nconst card = ref(null);\nconst elements = ref(null);\nconst ready = ref(false);\n\nconst cardElementRef = ref(null);\n\nconst createPaymentIntent = createResource({\n\turl: 'press.api.billing.create_payment_intent_for_buying_credits',\n\tparams: { amount: props.amount },\n\tvalidate() {\n\t\tif (props.amount < props.minimumAmount && !team.doc.erpnext_partner) {\n\t\t\tthrow new DashboardError(\n\t\t\t\t`Amount must be greater than or equal to ${props.minimumAmount}`\n\t\t\t);\n\t\t}\n\t},\n\tasync onSuccess(data) {\n\t\tstep.value = 'Setting up Stripe';\n\t\tlet { publishable_key, client_secret } = data;\n\t\tclientSecret.value = client_secret;\n\t\tstripe.value = await loadStripe(publishable_key);\n\t\telements.value = stripe.value.elements();\n\t\tconst style = {\n\t\t\tbase: {\n\t\t\t\tcolor: '#171717',\n\t\t\t\tfontFamily: [\n\t\t\t\t\t'ui-sans-serif',\n\t\t\t\t\t'system-ui',\n\t\t\t\t\t'-apple-system',\n\t\t\t\t\t'BlinkMacSystemFont',\n\t\t\t\t\t'\"Segoe UI\"',\n\t\t\t\t\t'Roboto',\n\t\t\t\t\t'\"Helvetica Neue\"',\n\t\t\t\t\t'Arial',\n\t\t\t\t\t'\"Noto Sans\"',\n\t\t\t\t\t'sans-serif',\n\t\t\t\t\t'\"Apple Color Emoji\"',\n\t\t\t\t\t'\"Segoe UI Emoji\"',\n\t\t\t\t\t'\"Segoe UI Symbol\"',\n\t\t\t\t\t'\"Noto Color Emoji\"'\n\t\t\t\t].join(', '),\n\t\t\t\tfontSmoothing: 'antialiased',\n\t\t\t\tfontSize: '13px',\n\t\t\t\t'::placeholder': {\n\t\t\t\t\tcolor: '#C7C7C7'\n\t\t\t\t}\n\t\t\t},\n\t\t\tinvalid: {\n\t\t\t\tcolor: '#7C7C7C',\n\t\t\t\ticonColor: '#7C7C7C'\n\t\t\t}\n\t\t};\n\t\tcard.value = elements.value.create('card', {\n\t\t\thidePostalCode: true,\n\t\t\tstyle: style,\n\t\t\tclasses: {\n\t\t\t\tcomplete: '',\n\t\t\t\tfocus: 'bg-gray-100'\n\t\t\t}\n\t\t});\n\n\t\tstep.value = 'Add Card Details';\n\t\tnextTick(() => {\n\t\t\tcard.value.mount(cardElementRef.value);\n\t\t});\n\n\t\tcard.value.addEventListener('change', event => {\n\t\t\tcardErrorMessage.value = event.error?.message || null;\n\t\t});\n\t\tcard.value.addEventListener('ready', () => {\n\t\t\tready.value = true;\n\t\t});\n\t}\n});\n\nasync function onBuyClick() {\n\tpaymentInProgress.value = true;\n\tlet payload = await stripe.value.confirmCardPayment(clientSecret.value, {\n\t\tpayment_method: { card: card.value }\n\t});\n\n\tif (payload.error) {\n\t\terrorMessage.value = payload.error.message;\n\t\tpaymentInProgress.value = false;\n\t} else {\n\t\ttoast.success(\n\t\t\t'Payment processed successfully, we will update your account shortly on confirmation from Stripe'\n\t\t);\n\t\tpaymentInProgress.value = false;\n\t\temit('success');\n\t\terrorMessage.value = null;\n\t}\n}\n</script>\n","<template>\n\t<div>\n\t\t<span\n\t\t\tv-if=\"team.doc.currency === 'INR'\"\n\t\t\tclass=\"mt-2.5 inline-flex gap-2 text-base text-gray-700\"\n\t\t>\n\t\t\t<FeatherIcon name=\"info\" class=\"my-1 h-4\" />\n\t\t\t<span class=\"leading-5\">\n\t\t\t\tIf you select Razorpay, you can pay using Credit Card, Debit Card, Net\n\t\t\t\tBanking, UPI, Wallets, etc. If you are using Net Banking, it may take\n\t\t\t\tupto 5 days for balance to reflect.\n\t\t\t</span>\n\t\t</span>\n\t\t<ErrorMessage class=\"mt-3\" :message=\"createRazorpayOrder.error\" />\n\t\t<div class=\"mt-8\">\n\t\t\t<Button\n\t\t\t\tv-if=\"!isPaymentComplete\"\n\t\t\t\tclass=\"w-full\"\n\t\t\t\tsize=\"md\"\n\t\t\t\tvariant=\"solid\"\n\t\t\t\tlabel=\"Proceed to payment using Razorpay\"\n\t\t\t\t:loading=\"createRazorpayOrder.loading\"\n\t\t\t\t@click=\"createRazorpayOrder.submit()\"\n\t\t\t/>\n\t\t\t<Button\n\t\t\t\tv-else\n\t\t\t\tclass=\"w-full\"\n\t\t\t\tsize=\"md\"\n\t\t\t\tlabel=\"Confirming payment\"\n\t\t\t\tvariant=\"solid\"\n\t\t\t\t:loading=\"isVerifyingPayment\"\n\t\t\t/>\n\t\t</div>\n\t</div>\n</template>\n<script setup>\nimport { Button, ErrorMessage, FeatherIcon, createResource } from 'frappe-ui';\nimport { ref, onMounted, onBeforeUnmount, inject } from 'vue';\nimport { toast } from 'vue-sonner';\nimport { DashboardError } from '../../utils/error';\n\nconst props = defineProps({\n\tamount: {\n\t\ttype: Number,\n\t\tdefault: 0\n\t},\n\tminimumAmount: {\n\t\ttype: Number,\n\t\tdefault: 0\n\t}\n});\n\nconst emit = defineEmits(['success']);\nconst team = inject('team');\n\nconst isPaymentComplete = ref(false);\nconst isVerifyingPayment = ref(false);\n\nconst razorpayCheckoutJS = ref(null);\n\nonMounted(() => {\n\trazorpayCheckoutJS.value = document.createElement('script');\n\trazorpayCheckoutJS.value.setAttribute(\n\t\t'src',\n\t\t'https://checkout.razorpay.com/v1/checkout.js'\n\t);\n\trazorpayCheckoutJS.value.async = true;\n\tdocument.head.appendChild(razorpayCheckoutJS.value);\n});\n\nonBeforeUnmount(() => {\n\trazorpayCheckoutJS.value?.remove();\n});\n\nconst createRazorpayOrder = createResource({\n\turl: 'press.api.billing.create_razorpay_order',\n\tparams: {\n\t\tamount: props.amount\n\t},\n\tonSuccess: data => processOrder(data),\n\tvalidate: () => {\n\t\tif (props.amount < props.minimumAmount) {\n\t\t\tthrow new DashboardError('Amount less than minimum amount required');\n\t\t}\n\t}\n});\n\nconst handlePaymentFailed = createResource({\n\turl: 'press.api.billing.handle_razorpay_payment_failed',\n\tonSuccess: () => {\n\t\tconsole.log('Payment Failed.');\n\t}\n});\n\nfunction processOrder(data) {\n\tconst options = {\n\t\tkey: data.key_id,\n\t\torder_id: data.order_id,\n\t\tname: 'Easytouch Cloud',\n\t\timage: 'https://frappe.io/files/cloud.png',\n\t\tprefill: { email: team.doc?.user },\n\t\thandler: handlePaymentSuccess,\n\t\ttheme: { color: '#171717' }\n\t};\n\n\tconst rzp = new Razorpay(options);\n\n\t// Opens the payment checkout frame\n\trzp.open();\n\n\t// Attach failure handler\n\trzp.on('payment.failed', handlePaymentFailure);\n\t// rzp.on('payment.success', this.handlePaymentSuccess);\n}\n\nfunction handlePaymentFailure(response) {\n\thandlePaymentFailed.submit({ response });\n\ttoast.error('Payment failed');\n}\n\nfunction handlePaymentSuccess() {\n\tisPaymentComplete.value = true;\n\temit('success');\n\ttoast.success('Payment successful');\n}\n</script>\n","<template>\n\t<div>\n\t\t<label class=\"block mt-4\">\n\t\t\t<span class=\"text-sm leading-4 text-gray-700\"> </span>\n\t\t\t<ErrorMessage class=\"mt-1\" :message=\"paymentErrorMessage\" />\n\t\t</label>\n\n\t\t<ErrorMessage class=\"mt-2\" :message=\"errorMessage\" />\n\n\t\t<FormControl\n\t\t\ttype=\"autocomplete\"\n\t\t\t:options=\"teams\"\n\t\t\tsize=\"sm\"\n\t\t\tvariant=\"subtle\"\n\t\t\tplaceholder=\"Payment Partner\"\n\t\t\t:disabled=\"false\"\n\t\t\tlabel=\"Select Payment Partner\"\n\t\t\tv-model=\"partnerInput\"\n\t\t\tclass=\"mb-5\"\n\t\t/>\n\n\t\t<div class=\"flex gap-5 col-2\">\n\t\t\t<FormControl\n\t\t\t\tlabel=\"M-Pesa Phone Number\"\n\t\t\t\tv-model=\"this.phoneNumberInput\"\n\t\t\t\tname=\"phone_number\"\n\t\t\t\tautocomplete=\"off\"\n\t\t\t\tclass=\"mb-5\"\n\t\t\t\ttype=\"number\"\n\t\t\t\tplaceholder=\"e.g 123456789\"\n\t\t\t/>\n\n\t\t\t<FormControl\n\t\t\t\tlabel=\"Tax ID\"\n\t\t\t\tv-model=\"this.taxIdInput\"\n\t\t\t\tname=\"tax_id\"\n\t\t\t\tautocomplete=\"off\"\n\t\t\t\tclass=\"mb-5\"\n\t\t\t\ttype=\"string\"\n\t\t\t\tplaceholder=\"e.g A123456789A\"\n\t\t\t/>\n\t\t</div>\n\t\t<!-- Show amount after tax -->\n\t\t<div v-if=\"showTaxInfo\" class=\"flex col-2 gap-5\">\n\t\t\t<FormControl\n\t\t\t\tlabel=\"Tax(%)\"\n\t\t\t\tdisabled\n\t\t\t\t:modelValue=\"taxPercentage\"\n\t\t\t\ttype=\"number\"\n\t\t\t/>\n\n\t\t\t<FormControl\n\t\t\t\tlabel=\"Total Amount With Tax\"\n\t\t\t\tdisabled\n\t\t\t\t:modelValue=\"amountWithTax.toFixed(2)\"\n\t\t\t\ttype=\"number\"\n\t\t\t/>\n\t\t</div>\n\n\t\t<div class=\"mt-4 flex w-full justify-end\">\n\t\t\t<Button variant=\"solid\" @click=\"onPayClick\" :loading=\"paymentInProgress\">\n\t\t\t\tMake payment via M-Pesa\n\t\t\t</Button>\n\t\t</div>\n\n\t\t<ErrorMessage v-if=\"errorMessage\" :message=\"errorMessage\" />\n\t</div>\n</template>\n\n<script>\nimport { toast } from 'vue-sonner';\nimport { DashboardError } from '../../../utils/error';\nimport { frappeRequest, ErrorMessage } from 'frappe-ui';\nexport default {\n\tname: 'BuyPrepaidCreditsMpesa',\n\tprops: {\n\t\tamount: {\n\t\t\ttype: Number,\n\t\t\trequired: true,\n\t\t},\n\t\tamountKES: {\n\t\t\ttype: Number,\n\t\t\trequired: true,\n\t\t\tdefault: 1,\n\t\t},\n\t\tminimumAmount: {\n\t\t\ttype: Number,\n\t\t\trequired: true,\n\t\t\tdefault: 10,\n\t\t},\n\t\texchangeRate: {\n\t\t\ttype: Number,\n\t\t\trequired: true,\n\t\t\tdefault: 129,\n\t\t},\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tpaymentErrorMessage: null,\n\t\t\terrorMessage: null,\n\t\t\tpaymentInProgress: false,\n\t\t\tpartnerInput: '',\n\t\t\tphoneNumberInput: this.$team.doc.mpesa_phone_number || '',\n\t\t\ttaxIdInput: this.$team.doc.mpesa_tax_id || '',\n\t\t\tteams: [],\n\t\t\ttaxPercentage: 1,\n\t\t\tamountWithTax: 0,\n\t\t\tshowTaxInfo: false,\n\t\t\tmaximumAmount: 150000,\n\t\t};\n\t},\n\tresources: {\n\t\trequestForPayment() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.billing.request_for_payment',\n\t\t\t\tparams: {\n\t\t\t\t\trequest_amount: this.amountKES,\n\t\t\t\t\tsender: this.phoneNumberInput,\n\t\t\t\t\tpartner: this.partnerInput.value,\n\t\t\t\t\ttax_id: this.taxIdInput,\n\t\t\t\t\tamount_with_tax: this.amountWithTax,\n\t\t\t\t\tphone_number: this.phoneNumberInput,\n\t\t\t\t\tamount_usd: this.amount,\n\t\t\t\t\texchange_rate: this.exchangeRate,\n\t\t\t\t},\n\t\t\t\tvalidate() {\n\t\t\t\t\tconst pattern = /^[A-Z]\\d{9}[A-Z]$/;\n\t\t\t\t\tif (this.amount < this.minimumAmount) {\n\t\t\t\t\t\tthrow new DashboardError(\n\t\t\t\t\t\t\t`Amount is less than the minimum allowed: ${this.minimumAmount}`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif (this.amount > this.maximumAmount) {\n\t\t\t\t\t\tthrow new DashboardError(\n\t\t\t\t\t\t\t`Amount is more than the maximum allowed: ${this.maximumAmount}`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif (!this.partnerInput.value || !this.phoneNumberInput) {\n\t\t\t\t\t\tthrow new DashboardError(\n\t\t\t\t\t\t\t'Both partner and phone number are required for payment.',\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif (!this.taxIdInput) {\n\t\t\t\t\t\tthrow new DashboardError('Tax ID is required for payment.');\n\t\t\t\t\t}\n\t\t\t\t\tif (this.taxIdInput && !pattern.test(this.taxIdInput)) {\n\t\t\t\t\t\tthrow new DashboardError('Invalid Tax Id');\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tasync onSuccess(data) {\n\t\t\t\t\tif (data?.ResponseCode === '0') {\n\t\t\t\t\t\ttoast.success(\n\t\t\t\t\t\t\tdata.ResponseDescription ||\n\t\t\t\t\t\t\t\t'Please follow the instructions on your phone',\n\t\t\t\t\t\t);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttoast.error(\n\t\t\t\t\t\t\tdata.ResponseDescription ||\n\t\t\t\t\t\t\t\t'Something went wrong. Please try again.',\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t},\n\tmethods: {\n\t\tasync onPayClick() {\n\t\t\tthis.paymentInProgress = true;\n\t\t\ttry {\n\t\t\t\tconst response = await this.$resources.requestForPayment.submit();\n\t\t\t\tif (response.ResponseCode === '0') {\n\t\t\t\t\ttoast.success(\n\t\t\t\t\t\tresponse.Success ||\n\t\t\t\t\t\t\t'Payment Initiated successfully, check your phone for instructions',\n\t\t\t\t\t);\n\t\t\t\t\tthis.$emit('success');\n\t\t\t\t} else {\n\t\t\t\t\tthrow new Error(response.ResponseDescription || 'Payment failed');\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tthis.paymentErrorMessage =\n\t\t\t\t\terror.message || 'Payment failed. Please try again.';\n\t\t\t\ttoast.error(this.paymentErrorMessage);\n\t\t\t} finally {\n\t\t\t\tthis.paymentInProgress = false;\n\t\t\t}\n\t\t},\n\t\tasync fetchTeams() {\n\t\t\ttry {\n\t\t\t\tconst response = await frappeRequest({\n\t\t\t\t\turl: '/api/method/press.api.regional_payments.mpesa.utils.display_mpesa_payment_partners',\n\t\t\t\t\tmethod: 'GET',\n\t\t\t\t});\n\t\t\t\tif (Array.isArray(response)) {\n\t\t\t\t\tthis.teams = response;\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log('No Data');\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tthis.errorMessage = `Failed to fetch teams ${error.message}`;\n\t\t\t}\n\t\t},\n\t\ttotalAmountWithTax() {\n\t\t\tconst amountWithTax =\n\t\t\t\tthis.amountKES + (this.amountKES * this.taxPercentage) / 100;\n\t\t\tthis.amountWithTax = Math.round(amountWithTax);\n\t\t},\n\t\tasync fetchTaxPercentage() {\n\t\t\ttry {\n\t\t\t\tconst taxPercentage = await frappeRequest({\n\t\t\t\t\turl: '/api/method/press.api.regional_payments.mpesa.utils.get_tax_percentage',\n\t\t\t\t\tmethod: 'GET',\n\t\t\t\t\tparams: {\n\t\t\t\t\t\tpayment_partner: this.partnerInput.value,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tthis.taxPercentage = taxPercentage;\n\t\t\t} catch (error) {\n\t\t\t\tthis.errorMessage = `Failed to fetch tax percentage ${error.message}`;\n\t\t\t}\n\t\t},\n\t},\n\twatch: {\n\t\tpartnerInput() {\n\t\t\tthis.fetchTaxPercentage();\n\t\t\tthis.totalAmountWithTax();\n\t\t\tthis.showTaxInfo = true;\n\t\t},\n\t\tamountKES() {\n\t\t\tthis.totalAmountWithTax();\n\t\t},\n\t\ttaxPercentage() {\n\t\t\tthis.totalAmountWithTax();\n\t\t},\n\t},\n\tmounted() {\n\t\tthis.fetchTeams();\n\t},\n};\n</script>\n","<template>\n\t<div>\n\t\t<!-- Amount -->\n\t\t<div>\n\t\t\t<FormControl\n\t\t\t\t:label=\"`Amount (Minimum Amount: ${minimumAmount})`\"\n\t\t\t\tclass=\"mb-3\"\n\t\t\t\tv-model.number=\"creditsToBuy\"\n\t\t\t\tname=\"amount\"\n\t\t\t\ttype=\"number\"\n\t\t\t\t:min=\"minimumAmount\"\n\t\t\t>\n\t\t\t\t<template #prefix>\n\t\t\t\t\t<div class=\"grid w-4 place-items-center text-sm text-gray-700\">\n\t\t\t\t\t\t{{ team.doc.currency === 'INR' ? '₹' : '$' }}\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</FormControl>\n\t\t\t<FormControl\n\t\t\t\tv-if=\"team.doc.currency === 'INR'\"\n\t\t\t\t:label=\"`Total Amount + GST (${\n\t\t\t\t\tteam.doc?.billing_info.gst_percentage * 100\n\t\t\t\t}%)`\"\n\t\t\t\tdisabled\n\t\t\t\t:modelValue=\"totalAmount\"\n\t\t\t\tname=\"total\"\n\t\t\t\ttype=\"number\"\n\t\t\t>\n\t\t\t\t<template #prefix>\n\t\t\t\t\t<div class=\"grid w-4 place-items-center text-sm text-gray-700\">\n\t\t\t\t\t\t{{ team.doc.currency === 'INR' ? '₹' : '$' }}\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</FormControl>\n\t\t\t<FormControl\n\t\t\t\tv-if=\"team.doc.country === 'Kenya' && paymentGateway === 'M-Pesa'\"\n\t\t\t\t:label=\"`Amount in KES (Exchange Rate: ${Math.round(\n\t\t\t\t\texchangeRate,\n\t\t\t\t)} against 1 USD)`\"\n\t\t\t\tdisabled\n\t\t\t\t:modelValue=\"amountInKES\"\n\t\t\t\tname=\"amount_in_kes\"\n\t\t\t\ttype=\"number\"\n\t\t\t>\n\t\t\t\t<template #prefix>\n\t\t\t\t\t<div class=\"-ml-1 grid w-4 place-items-center text-sm text-gray-700\">\n\t\t\t\t\t\t{{ 'Ksh' }}\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</FormControl>\n\t\t</div>\n\n\t\t<!-- Payment Gateway -->\n\t\t<div class=\"mt-4\">\n\t\t\t<div class=\"text-xs text-gray-600\">Select Payment Gateway</div>\n\t\t\t<div class=\"mt-1.5 grid grid-cols-1 gap-2 sm:grid-cols-2\">\n\t\t\t\t<Button\n\t\t\t\t\tv-if=\"team.doc.currency === 'INR' || team.doc.razorpay_enabled\"\n\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t:class=\"{\n\t\t\t\t\t\t'border-[1.5px] border-gray-700': paymentGateway === 'Razorpay',\n\t\t\t\t\t}\"\n\t\t\t\t\t@click=\"paymentGateway = 'Razorpay'\"\n\t\t\t\t>\n\t\t\t\t\t<RazorpayLogo class=\"w-24\" />\n\t\t\t\t</Button>\n\t\t\t\t<Button\n\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t:class=\"{\n\t\t\t\t\t\t'border-[1.5px] border-gray-700': paymentGateway === 'Stripe',\n\t\t\t\t\t}\"\n\t\t\t\t\t@click=\"paymentGateway = 'Stripe'\"\n\t\t\t\t>\n\t\t\t\t\t<StripeLogo class=\"h-7 w-24\" />\n\t\t\t\t</Button>\n\t\t\t\t<Button\n\t\t\t\t\tv-if=\"team.doc.country === 'Kenya' && team.doc.mpesa_enabled\"\n\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t:class=\"{\n\t\t\t\t\t\t'border-[1.5px] border-gray-700': paymentGateway === 'M-Pesa',\n\t\t\t\t\t}\"\n\t\t\t\t\t@click=\"paymentGateway = 'M-Pesa'\"\n\t\t\t\t>\n\t\t\t\t\t<img\n\t\t\t\t\t\tclass=\"h-14 w-24\"\n\t\t\t\t\t\t:src=\"`/assets/press/images/mpesa-logo.svg`\"\n\t\t\t\t\t\talt=\"M-pesa Logo\"\n\t\t\t\t\t/>\n\t\t\t\t</Button>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<!-- Payment Button -->\n\t\t<BuyCreditsStripe\n\t\t\tv-if=\"paymentGateway === 'Stripe'\"\n\t\t\t:amount=\"creditsToBuy\"\n\t\t\t:minimumAmount=\"minimumAmount\"\n\t\t\t@success=\"() => emit('success')\"\n\t\t\t@cancel=\"show = false\"\n\t\t/>\n\n\t\t<BuyCreditsRazorpay\n\t\t\tv-if=\"paymentGateway === 'Razorpay'\"\n\t\t\t:amount=\"creditsToBuy\"\n\t\t\t:minimumAmount=\"minimumAmount\"\n\t\t\t@success=\"() => emit('success')\"\n\t\t\t@cancel=\"show = false\"\n\t\t/>\n\n\t\t<BuyPrepaidCreditsMpesa\n\t\t\tv-if=\"paymentGateway === 'M-Pesa'\"\n\t\t\t:amount=\"creditsToBuy\"\n\t\t\t:amountKES=\"amountInKES\"\n\t\t\t:minimumAmount=\"minimumAmount\"\n\t\t\t:exchangeRate=\"exchangeRate\"\n\t\t\t@success=\"() => emit('success')\"\n\t\t\t@cancel=\"show = false\"\n\t\t/>\n\t</div>\n</template>\n<script setup>\nimport BuyCreditsStripe from './BuyCreditsStripe.vue';\nimport BuyCreditsRazorpay from './BuyCreditsRazorpay.vue';\nimport RazorpayLogo from '../../logo/RazorpayLogo.vue';\nimport StripeLogo from '../../logo/StripeLogo.vue';\nimport BuyPrepaidCreditsMpesa from './mpesa/BuyPrepaidCreditsMpesa.vue';\nimport { FormControl, Button, createResource } from 'frappe-ui';\nimport { ref, computed, inject, watch, onMounted } from 'vue';\n\nconst emit = defineEmits(['success']);\n\nconst team = inject('team');\nconst props = defineProps({\n\tminimumAmount: Number,\n});\n\nconst totalUnpaidAmount = createResource({\n\turl: 'press.api.billing.total_unpaid_amount',\n\tcache: 'totalUnpaidAmount',\n\tauto: true,\n});\n\nconst minimumAmount = computed(() => {\n\tif (props.minimumAmount) return props.minimumAmount;\n\tif (!team.doc) return 0;\n\tconst unpaidAmount = totalUnpaidAmount.data || 0;\n\tconst minimumDefault = team.doc?.currency == 'INR' ? 410 : 5;\n\n\treturn Math.ceil(\n\t\tunpaidAmount && unpaidAmount > 0 ? unpaidAmount : minimumDefault,\n\t);\n});\n\nconst creditsToBuy = ref(minimumAmount.value);\nconst paymentGateway = ref('');\n\nwatch(minimumAmount, () => {\n\tcreditsToBuy.value = minimumAmount.value;\n});\n\nconst totalAmount = computed(() => {\n\tconst _creditsToBuy = creditsToBuy.value || 0;\n\n\tif (team.doc?.currency === 'INR') {\n\t\treturn (\n\t\t\t_creditsToBuy +\n\t\t\t_creditsToBuy * (team.doc.billing_info.gst_percentage || 0)\n\t\t).toFixed(2);\n\t} else {\n\t\treturn _creditsToBuy;\n\t}\n});\n\nconst amountInKES = ref();\nconst exchangeRate = ref(0);\n\nwatch(creditsToBuy, () => {\n\tlet _amountInKES = creditsToBuy.value * exchangeRate.value;\n\tif (\n\t\tpaymentGateway.value === 'M-Pesa' &&\n\t\t_amountInKES !== creditsToBuy.value\n\t) {\n\t\tamountInKES.value = _amountInKES;\n\t}\n});\n\nwatch(amountInKES, () => {\n\tlet data = amountInKES.value / exchangeRate.value;\n\tif (paymentGateway.value === 'M-Pesa' && data !== creditsToBuy.value) {\n\t\tcreditsToBuy.value = data;\n\t}\n});\n\nwatch(paymentGateway, () => {\n\tif (paymentGateway.value === 'M-Pesa') {\n\t\tamountInKES.value = creditsToBuy.value * exchangeRate.value;\n\t}\n});\n\nconst fetchExchangeRate = async () => {\n\ttry {\n\t\tconst fromCurrency = 'usd';\n\t\tconst toCurrency = 'kes';\n\t\tconst baseURL = `https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies`;\n\t\tconst URL = `${baseURL}/${fromCurrency}.json`;\n\t\tlet response = await fetch(URL);\n\t\tlet responseJSON = await response.json();\n\t\tlet rate = responseJSON[fromCurrency][toCurrency];\n\t\texchangeRate.value = Math.round(rate);\n\t} catch (error) {\n\t\tconsole.error(error);\n\t}\n};\n\nonMounted(() => {\n\tfetchExchangeRate();\n});\n</script>\n"],"names":["props","__props","emit","__emit","team","inject","step","ref","clientSecret","cardErrorMessage","errorMessage","paymentInProgress","stripe","card","elements","ready","cardElementRef","createPaymentIntent","createResource","DashboardError","data","__async","publishable_key","client_secret","loadStripe","style","nextTick","event","_a","onBuyClick","payload","toast","isPaymentComplete","isVerifyingPayment","razorpayCheckoutJS","onMounted","onBeforeUnmount","createRazorpayOrder","processOrder","handlePaymentFailed","options","handlePaymentSuccess","rzp","handlePaymentFailure","response","_sfc_main","pattern","frappeRequest","amountWithTax","taxPercentage","error","_hoisted_1","_hoisted_2","_hoisted_4","_createElementVNode","$data","_cache","$event","_openBlock","_createElementBlock","_hoisted_3","_createCommentVNode","$options","_withCtx","_createTextVNode","totalUnpaidAmount","minimumAmount","computed","unpaidAmount","minimumDefault","creditsToBuy","paymentGateway","watch","totalAmount","_creditsToBuy","amountInKES","exchangeRate","_amountInKES","fetchExchangeRate","fromCurrency","toCurrency","URL","rate"],"mappings":"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"}