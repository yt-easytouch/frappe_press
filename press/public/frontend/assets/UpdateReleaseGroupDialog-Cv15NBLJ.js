import{x as C,an as R,r as v,h as m,o as r,w as k,j as p,q as h,u,X as I,A as f,at as B,n as w,a8 as P,y as V,a9 as E,aA as F,ad as L,av as N,g as O,a2 as b,c4 as S}from"./main-Dpl-JOF2.js";import{_ as A}from"./CommitChooser-R9zPknj3.js";import{_ as x}from"./CommitTag-C7m6nG0N.js";import{G as T}from"./GenericList-TeL894c5.js";(function(){try{var e=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},s=new Error().stack;s&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[s]="73a81bac-421c-4d58-afa8-015a5261093a",e._sentryDebugIdIdentifier="sentry-dbid-73a81bac-421c-4d58-afa8-015a5261093a")}catch(t){}})();{var g=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};g._sentryModuleMetadata=g._sentryModuleMetadata||{},g._sentryModuleMetadata[new Error().stack]=Object.assign({},g._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const W={name:"UpdateReleaseGroupDialog",props:["bench"],components:{GenericList:T,CommitChooser:A,CommitTag:x,AlertBanner:R},data(){return{show:!0,step:"",errorMessage:"",ignoreWillFailCheck:!1,useInPlaceUpdate:!1,restrictMessage:"",selectedApps:[],selectedSites:[]}},mounted(){this.hasUpdateAvailable?this.step="select-apps":this.hasRemovedApps?this.step="removed-apps":this.step="select-sites"},computed:{updatableAppOptions(){let e=this.benchDocResource.doc.deploy_information,s=e.apps.filter(t=>t.update_available===!0);return{data:s,selectable:!0,columns:[{label:"App",fieldname:"title",width:1.75},{label:"From",fieldname:"current_hash",type:"Component",component({row:t}){if(!t.current_hash)return null;let i=t.will_branch_change?t.current_branch:t.current_hash.slice(0,7);return b(x,{tag:i,link:`${t.repository_url}/commit/${i}`})}},{label:"To",fieldname:"next_release",type:"Component",component({row:t}){if(t.will_branch_change)return b(x,{tag:t.branch,link:`${t.repository_url}/commit/${t.branch}`});function i(o){return o.releases.map(l=>{let d=l.message.split(`
`)[0];return d=d.length>75?d.slice(0,75)+"...":d,{label:l.tag?l.tag:`${d} (${l.hash.slice(0,7)})`,value:l.name}})}function a(o){const l=o.releases.filter(c=>c.name===o.next_release)[0];if(o.will_branch_change)return o.branch;if(l)return l.tag||l.hash.slice(0,7)}if(!t.releases.length)return;let n={label:a(t),value:t.next_release};return b(A,{options:i(t),modelValue:n,"onUpdate:modelValue":o=>{s.find(l=>l.name===t.name).next_release=o.value}})}},{label:"Status",fieldname:"title",type:"Badge",format(t,i){return e.removed_apps.find(a=>a.name===i.name)?"Will be Uninstalled":!i.will_branch_change&&!i.current_hash?"First Deploy":"Update Available"}},{label:"Changes",type:"Button",width:.5,align:"right",Button({row:t}){var a;let i;if(t.current_hash&&t.next_release){let n=(a=t.releases.find(o=>o.name===t.next_release))==null?void 0:a.hash;n&&(i=`${t.repository_url}/compare/${t.current_hash}...${n}`)}else t.next_release&&(i=`${t.repository_url}/commit/${t.releases.find(n=>n.name===t.next_release).hash}`);return i?{label:"View",variant:"ghost",onClick(){window.open(i,"_blank")}}:null}}]}},removedAppOptions(){return{data:this.benchDocResource.doc.deploy_information.removed_apps,columns:[{label:"App",fieldname:"title"},{label:"Status",fieldname:"name",type:"Badge",format(){return"Will be Uninstalled"}}]}},siteOptions(){let s=this.benchDocResource.doc.deploy_information.sites,t=O();const i=this.useInPlaceUpdate;return{data:s,selectable:!0,columns:[{label:"Site",fieldname:"name"},{label:"Skip failed patches",fieldname:"skip_failing_patches",width:.5,type:"Component",component({row:a}){return b(S,{modelValue:a.skip_failing_patches,disabled:i})}},{label:"Skip backup",fieldname:"skip_backups",width:.3,type:"Component",condition(){return!!t.doc.skip_backups},component({row:a}){return b(S,{modelValue:a.skip_backups,disabled:i})}}]}},benchDocResource(){return N("Release Group",this.bench)},hasUpdateAvailable(){return this.benchDocResource.doc.deploy_information.apps.some(e=>e.update_available===!0)},hasRemovedApps(){return!!this.benchDocResource.doc.deploy_information.removed_apps.length},deployInformation(){var e;return(e=this.benchDocResource)==null?void 0:e.doc.deploy_information},canShowBack(){return this.step==="select-apps"?!1:this.hasUpdateAvailable||this.step==="restrict-build"},canShowNext(){return!(this.step==="restrict-build"||this.step==="select-sites"&&!this.restrictMessage)},canShowDeploy(){return!this.canShowNext},deployLabel(){if(this.selectedSites.length===0)return"Skip and Deploy";let e="site";return this.selectedSites.length>1&&(e=`${this.selectedSites.length} sites`),this.useInPlaceUpdate?`Update ${e} in place`:`Deploy and update ${e}`},canUpdateInPlace(){var i,a,n,o,l;if(!((a=(i=this.benchDocResource)==null?void 0:i.doc)!=null&&a.enable_inplace_updates)||this.hasRemovedApps)return!1;const e=new Set(this.selectedSites.map(c=>c.bench));if(e.size!==1)return!1;const s=(l=(o=(n=this.benchDocResource)==null?void 0:n.doc)==null?void 0:o.inplace_update_failed_benches)!=null?l:[];return this.siteOptions.data.filter(c=>e.has(c.bench)||s.includes(c.bench)).map(c=>c.name).length===this.selectedSites.length}},resources:{deployAndUpdate(){return{url:"press.api.bench.deploy_and_update",params:{name:this.bench,apps:this.selectedApps,sites:this.selectedSites,run_will_fail_check:!this.ignoreWillFailCheck},validate(){if(this.hasUpdateAvailable&&this.selectedApps.length===0&&this.deployInformation.removed_apps.length===0)throw new L("Please select an app to proceed")},onSuccess(e){this.$router.push({name:"Deploy Candidate",params:{id:e,name:this.bench}}),this.restrictMessage="",this.show=!1,this.$emit("success",e)},onError:this.setErrorMessage.bind(this)}},updateInPlace(){return{url:"press.api.bench.update_inplace",params:{name:this.bench,apps:this.selectedApps,sites:this.selectedSites},onSuccess(e){this.$router.push({name:"Release Group Job",params:{id:e}}),this.restrictMessage="",this.show=!1,this.$emit("success",null)},onError:this.setErrorMessage.bind(this)}}},methods:{back(){this.step!=="select-apps"&&(this.step==="removed-apps"?this.step="select-apps":this.step==="select-sites"&&this.hasRemovedApps?this.step="removed-apps":this.step==="select-sites"&&!this.hasRemovedApps?this.step="select-apps":this.step==="restrict-build"&&(this.step="select-sites"),this.step==="select-apps"&&(this.selectedApps=[]))},next(){if(this.errorMessage&&(this.errorMessage=""),this.step==="select-apps"&&this.selectedApps.length===0){this.errorMessage="Please select an app to proceed";return}else this.step==="select-apps"&&this.hasRemovedApps?this.step="removed-apps":this.step==="select-apps"&&!this.hasRemovedApps?this.step="select-sites":this.step==="removed-apps"?this.step="select-sites":this.step==="select-sites"&&this.restrictMessage&&(this.step="restrict-build")},handleAppSelection(e){e=Array.from(e);let s=this.benchDocResource.doc.deploy_information.apps;this.selectedApps=s.filter(t=>e.includes(t.name)).map(t=>({app:t.name,source:t.source,release:t.next_release,hash:t.releases.find(i=>i.name===t.next_release).hash}))},handleSiteSelection(e){e=Array.from(e);let s=this.benchDocResource.doc.deploy_information.sites;this.selectedSites=s.filter(t=>e.includes(t.name))},deployFrom(e){return e.will_branch_change?e.current_branch:e.current_hash?e.current_tag||e.current_hash.slice(0,7):null},initialDeployTo(e){return this.benchDocResource.doc.deploy_information.apps.find(s=>s.app===e.app).next_release},updateBench(){if(this.restrictMessage&&!this.ignoreWillFailCheck){this.errorMessage="Please check the <b>I understand</b> box to proceed";return}this.errorMessage="",this.canUpdateInPlace&&this.useInPlaceUpdate?(this.setSkipBackupsAndFailingPatches(),this.$resources.updateInPlace.submit()):this.$resources.deployAndUpdate.submit()},setSkipBackupsAndFailingPatches(){for(const e of this.selectedSites)e.skip_failing_patches=!0,e.skip_backups=!0},setErrorMessage(e){var s,t,i,a;if(this.ignoreWillFailCheck=!1,(e==null?void 0:e.exc_type)==="BuildValidationError"&&(this.restrictMessage=(t=(s=e==null?void 0:e.messages)==null?void 0:s[0])!=null?t:""),(e==null?void 0:e.exc_type)==="PermissionError"){this.errorMessage=(a=(i=e==null?void 0:e.messages)==null?void 0:i[0])!=null?a:"";return}if(this.restrictMessage){this.step="restrict-build";return}this.errorMessage="Internal Server Error: Deploy could not be initiated"}}},G={class:"space-y-4"},j={key:0},z={key:1,class:"text-center text-base text-gray-600"},H={key:1},q={key:2},J={key:1,class:"text-center text-base font-medium text-gray-600"},K={key:3,class:"flex flex-col gap-4"},X={class:"flex items-center gap-2"},$={href:"https://easytouch.cloud/docs/common-issues/build-might-fail",target:"_blank",class:"cursor-pointer rounded-full border border-gray-200 bg-gray-100 p-0.5 text-base text-gray-700"},Q=["innerHTML"],Y={class:"mt-4"},Z={key:4,class:"flex gap-2"},ee={href:"https://easytouch.cloud/docs/in-place-updates",target:"_blank"},te={class:"flex items-center justify-between space-y-2"},se={key:0};function ae(e,s,t,i,a,n){const o=v("AlertBanner"),l=v("GenericList"),c=B,d=P,D=V,U=E,y=I,M=F;return r(),m(M,{modelValue:a.show,"onUpdate:modelValue":s[2]||(s[2]=_=>a.show=_),options:{size:"4xl",title:"Update Bench Group"}},{"body-content":k(()=>[n.benchDocResource.doc.are_builds_suspended?(r(),m(o,{key:0,class:"mb-4",title:"<b>Builds Suspended:</b> updates will be scheduled to run when builds resume.",type:"warning"})):u("",!0),p("div",G,[a.step==="select-apps"?(r(),h("div",j,[s[3]||(s[3]=p("h2",{class:"mb-4 text-lg font-medium"},"Select apps to update",-1)),n.benchDocResource.doc.deploy_information.update_available?(r(),m(l,{key:0,class:"max-h-[500px]",options:n.updatableAppOptions,"onUpdate:selections":n.handleAppSelection},null,8,["options","onUpdate:selections"])):(r(),h("p",z," No apps to update "))])):a.step==="removed-apps"?(r(),h("div",H,[s[4]||(s[4]=p("h2",{class:"mb-4 text-lg font-medium"},"These apps will be removed",-1)),f(l,{class:"max-h-[500px]",options:n.removedAppOptions},null,8,["options"])])):a.step==="select-sites"?(r(),h("div",q,[s[5]||(s[5]=p("h2",{class:"mb-4 text-lg font-medium"},"Select sites to update",-1)),n.benchDocResource.doc.deploy_information.sites.length?(r(),m(l,{key:0,class:"max-h-[500px]",options:n.siteOptions,"onUpdate:selections":n.handleSiteSelection},null,8,["options","onUpdate:selections"])):n.benchDocResource.doc.deploy_information.sites.length?u("",!0):(r(),h("p",J," No active sites to update "))])):a.step==="restrict-build"&&a.restrictMessage?(r(),h("div",K,[p("div",X,[s[6]||(s[6]=p("h2",{class:"text-lg font-medium"},"Build might fail",-1)),p("a",$,[f(c,{class:w("h-4 w-4 text-red-600")})])]),p("p",{class:"text-base font-medium text-gray-800",innerHTML:a.restrictMessage},null,8,Q),p("div",Y,[f(d,{label:"I understand, run deploy anyway",type:"checkbox",modelValue:a.ignoreWillFailCheck,"onUpdate:modelValue":s[0]||(s[0]=_=>a.ignoreWillFailCheck=_)},null,8,["modelValue"])])])):u("",!0),n.canUpdateInPlace?(r(),h("div",Z,[f(d,{label:"Use in place update",type:"checkbox",modelValue:a.useInPlaceUpdate,"onUpdate:modelValue":s[1]||(s[1]=_=>a.useInPlaceUpdate=_)},null,8,["modelValue"]),f(D,{text:"View documentation"},{default:k(()=>[p("a",ee,[f(c,{class:w("h-4 w-4 text-gray-600")})])]),_:1})])):u("",!0),f(U,{message:a.errorMessage},null,8,["message"])])]),actions:k(()=>[p("div",te,[n.canShowBack?u("",!0):(r(),h("div",se)),n.canShowBack?(r(),m(y,{key:1,label:"Back",onClick:n.back},null,8,["onClick"])):u("",!0),n.canShowNext?(r(),m(y,{key:2,variant:"solid",label:"Next",onClick:n.next},null,8,["onClick"])):u("",!0),n.canShowDeploy?(r(),m(y,{key:3,variant:"solid",label:n.deployLabel,loading:e.$resources.deployAndUpdate.loading||e.$resources.updateInPlace.loading,onClick:n.updateBench},null,8,["label","loading","onClick"])):u("",!0)])]),_:1},8,["modelValue"])}const re=C(W,[["render",ae]]);export{re as default};
//# sourceMappingURL=UpdateReleaseGroupDialog-Cv15NBLJ.js.map
