import{x as R,an as j,r as h,q as b,u as m,o as d,h as u,A as l,j as o,w as c,Y as O,X as S,t as a,a5 as V,bZ as F,C as N,F as v,v as x,n as I,ac as M,V as J,bD as P,av as T}from"./main-Dpl-JOF2.js";import{J as z,_ as q}from"./JobStep-yl8qYLQg.js";import{_ as K}from"./arrow-left-DH4AOn6w.js";import{A as L}from"./AlertAddressableError-BvcXrI8s.js";import{d as k}from"./dayjs.min-BK4AnHlu.js";(function(){try{var s=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="69891415-6539-4afd-8072-b034a57ea364",s._sentryDebugIdIdentifier="sentry-dbid-69891415-6539-4afd-8072-b034a57ea364")}catch(r){}})();{var p=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};p._sentryModuleMetadata=p._sentryModuleMetadata||{},p._sentryModuleMetadata[new Error().stack]=Object.assign({},p._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const U={name:"DeployCandidate",props:["id","objectType"],components:{JobStep:z,AlertBanner:j,AlertAddressableError:L},resources:{deploy(){return{type:"document",doctype:"Deploy Candidate Build",name:this.id,transform:this.transformDeploy}},errors(){return{type:"list",cache:["Press Notification","Error","Deploy Candidate Build",this.id],doctype:"Press Notification",auto:!0,fields:["title","name"],filters:{document_type:"Deploy Candidate Build",document_name:this.id,is_actionable:!0,class:"Error"},limit:1}}},mounted(){this.$socket.emit("doc_subscribe","Deploy Candidate Build",this.id),this.$socket.on(`bench_deploy:${this.id}:steps`,s=>{var e;s.name===this.id&&this.$resources.deploy.doc&&(this.$resources.deploy.doc.build_steps=(e=this.transformDeploy({build_steps:s.steps}))==null?void 0:e.build_steps)}),this.$socket.on(`bench_deploy:${this.id}:finished`,()=>{var e;const s=T("Release Group",(e=this.$resources.deploy.doc)==null?void 0:e.group);s&&s.reload(),this.$resources.deploy.reload(),this.$resources.errors.reload()})},beforeUnmount(){this.$socket.emit("doc_unsubscribe","Deploy Candidate Build",this.id),this.$socket.off(`bench_deploy:${this.id}:steps`)},computed:{deploy(){return this.$resources.deploy.doc},object(){return P(this.objectType)},error(){var s,e,r;return(r=(e=(s=this.$resources.errors)==null?void 0:s.data)==null?void 0:e[0])!=null?r:null},alertMessage(){return this.deploy&&this.deploy.retry_count>0&&this.deploy.status==="Scheduled"?"Previous deploy failed, re-deploy will be attempted soon":null},dropdownOptions(){return[{label:"View in Desk",icon:"external-link",condition:()=>{var s,e;return(e=(s=this.$team)==null?void 0:s.doc)==null?void 0:e.is_desk_user},onClick:()=>{window.open(`${window.location.protocol}//${window.location.host}/app/deploy-candidate-build/${this.id}`,"_blank")}},{label:"Fail and Redeploy",icon:"repeat",condition:()=>this.showFailAndRedeploy,onClick:()=>this.failAndRedeploy()}].filter(s=>{var e,r;return(r=(e=s.condition)==null?void 0:e.call(s))!=null?r:!0})},showFailAndRedeploy(){if(!this.deploy||this.deploy.status!=="Running")return!1;const s=k(this.deploy.build_start);return k(new Date).diff(s,"hours")>2}},methods:{transformDeploy(s){var e,r,i,y;for(let t of s.build_steps)t.status==="Running"?t.isOpen=!0:t.isOpen=(y=(i=(r=(e=this.$resources.deploy)==null?void 0:e.doc)==null?void 0:r.build_steps)==null?void 0:i.find(_=>_.name===t.name))==null?void 0:y.isOpen,t.title=`${t.stage} - ${t.step}`,t.output=t.command||t.output?`${t.command||""}
${t.output||""}`.trim():"",t.duration=["Success","Failure"].includes(t.status)?t.cached?"Cached":`${t.duration}s`:null;return s},failAndRedeploy(){if(!this.deploy)return;const s=this.deploy.group,e=()=>J.error("Could not fail and redeploy"),r=this.$router;M({url:"press.api.bench.fail_and_redeploy",params:{name:s,dc_name:this.deploy.name},onSuccess(i){i?r.push(`/groups/${s}/deploys/${i}`):e()},onError:e}).fetch()}}},X={key:0,class:"p-5"},Y={class:"mt-3"},Z={class:"flex w-full items-center"},H={class:"text-lg font-medium text-gray-900"},Q={class:"ml-auto flex items-center space-x-2"},W={class:"mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-5"},G={class:"mt-2 text-sm text-gray-900"},ee={class:"mt-2 text-sm text-gray-900"},te={class:"mt-2 text-sm text-gray-900"},se={class:"mt-2 text-sm text-gray-900"},oe={class:"mt-2 text-sm text-gray-900"};function re(s,e,r,i,y,t){var w;const _=h("AlertAddressableError"),D=h("AlertBanner"),$=K,f=S,C=V,A=F,B=q,E=N,g=h("JobStep");return t.deploy?(d(),b("div",X,[t.error?(d(),u(_,{key:0,class:"mb-5",name:t.error.name,title:t.error.title,onDone:e[0]||(e[0]=n=>s.$resources.errors.reload())},null,8,["name","title"])):m("",!0),t.alertMessage&&!t.error?(d(),u(D,{key:1,title:t.alertMessage,type:"warning",class:"mb-5"},null,8,["title"])):m("",!0),l(f,{route:{name:`${t.object.doctype} Detail Deploys`}},{prefix:c(()=>[l($,{class:"inline-block h-4 w-4"})]),default:c(()=>[e[2]||(e[2]=O(" All deploys "))]),_:1},8,["route"]),o("div",Y,[o("div",Z,[o("h2",H,a(t.deploy.deploy_candidate),1),l(C,{class:"ml-2",label:t.deploy.status},null,8,["label"]),o("div",Q,[l(f,{onClick:e[1]||(e[1]=n=>s.$resources.deploy.reload()),loading:s.$resources.deploy.get.loading},{icon:c(()=>[l(A,{class:"h-4 w-4"})]),_:1},8,["loading"]),(w=t.dropdownOptions)!=null&&w.length?(d(),u(E,{key:0,options:t.dropdownOptions},{default:c(({open:n})=>[l(f,null,{icon:c(()=>[l(B,{class:"h-4 w-4"})]),_:1})]),_:1},8,["options"])):m("",!0)])]),o("div",null,[o("div",W,[o("div",null,[e[3]||(e[3]=o("div",{class:"text-sm font-medium text-gray-500"},"Creation",-1)),o("div",G,a(s.$format.date(t.deploy.creation,"lll")),1)]),o("div",null,[e[4]||(e[4]=o("div",{class:"text-sm font-medium text-gray-500"},"Creator",-1)),o("div",ee,a(t.deploy.owner),1)]),o("div",null,[e[5]||(e[5]=o("div",{class:"text-sm font-medium text-gray-500"},"Duration",-1)),o("div",te,a(t.deploy.build_end?s.$format.duration(t.deploy.build_duration):"-"),1)]),o("div",null,[e[6]||(e[6]=o("div",{class:"text-sm font-medium text-gray-500"},"Start",-1)),o("div",se,a(s.$format.date(t.deploy.build_start,"lll")),1)]),o("div",null,[e[7]||(e[7]=o("div",{class:"text-sm font-medium text-gray-500"},"End",-1)),o("div",oe,a(t.deploy.build_end?s.$format.date(t.deploy.build_end,"lll"):"-"),1)])])])]),o("div",{class:I([t.deploy.build_error?"mt-4":"mt-8","space-y-4"])},[(d(!0),b(v,null,x(t.deploy.build_steps,n=>(d(),u(g,{step:n,key:n.name},null,8,["step"]))),128)),(d(!0),b(v,null,x(t.deploy.jobs,n=>(d(),u(g,{step:n,key:n.name},null,8,["step"]))),128))],2)])):m("",!0)}const ue=R(U,[["render",re]]);export{ue as default};
//# sourceMappingURL=DeployCandidate-iMfQizRs.js.map
