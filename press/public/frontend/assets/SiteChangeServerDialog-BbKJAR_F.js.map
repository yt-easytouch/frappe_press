{"version":3,"file":"SiteChangeServerDialog-BbKJAR_F.js","sources":["../../../../dashboard/src2/components/site/SiteChangeServerDialog.vue"],"sourcesContent":["<template>\n\t<Dialog\n\t\tv-model=\"show\"\n\t\t@close=\"resetValues\"\n\t\t:options=\"{\n\t\t\ttitle: 'Move Site to another Server',\n\t\t\tactions: [\n\t\t\t\t{\n\t\t\t\t\tlabel: 'Add Server to Bench Group',\n\t\t\t\t\tloading: $resources.addServerToReleaseGroup.loading,\n\t\t\t\t\tdisabled: $resources.isServerAddedInGroup.data || !targetServer.value,\n\t\t\t\t\tonClick: () => $resources.addServerToReleaseGroup.submit()\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlabel: 'Change Server',\n\t\t\t\t\tloading: $resources.changeServer.loading,\n\t\t\t\t\tvariant: 'solid',\n\t\t\t\t\tdisabled:\n\t\t\t\t\t\t!$resources.changeServerOptions?.data?.length ||\n\t\t\t\t\t\t!targetServer.value ||\n\t\t\t\t\t\t!$resources.isServerAddedInGroup.data,\n\t\t\t\t\tonClick: () => {\n\t\t\t\t\t\t$resources.changeServer.submit({\n\t\t\t\t\t\t\tname: site,\n\t\t\t\t\t\t\tserver: targetServer.value,\n\t\t\t\t\t\t\tscheduled_datetime: datetimeInIST,\n\t\t\t\t\t\t\tskip_failing_patches: skipFailingPatches\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]\n\t\t}\"\n\t>\n\t\t<template #body-content>\n\t\t\t<LoadingIndicator\n\t\t\t\tclass=\"mx-auto h-4 w-4\"\n\t\t\t\tv-if=\"$resources.changeServerOptions.loading\"\n\t\t\t/>\n\t\t\t<FormControl\n\t\t\t\tv-else-if=\"$resources.changeServerOptions.data.length > 0\"\n\t\t\t\tlabel=\"Select Server\"\n\t\t\t\tvariant=\"outline\"\n\t\t\t\ttype=\"autocomplete\"\n\t\t\t\t:options=\"$resources.changeServerOptions.data\"\n\t\t\t\tv-model=\"targetServer\"\n\t\t\t/>\n\t\t\t<div v-if=\"$resources.isServerAddedInGroup.data\" class=\"mt-4 space-y-4\">\n\t\t\t\t<DateTimeControl v-model=\"targetDateTime\" label=\"Schedule Time\" />\n\t\t\t\t<FormControl\n\t\t\t\t\tlabel=\"Skip failing patches if any\"\n\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\tv-model=\"skipFailingPatches\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<p v-if=\"message && !errorMessage\" class=\"mt-4 text-sm text-gray-700\">\n\t\t\t\t{{ message }}\n\t\t\t</p>\n\t\t\t<ErrorMessage class=\"mt-4\" :message=\"errorMessage\" />\n\t\t</template>\n\t</Dialog>\n</template>\n\n<script>\nimport { getCachedDocumentResource } from 'frappe-ui';\nimport DateTimeControl from '../DateTimeControl.vue';\nimport { toast } from 'vue-sonner';\n\nexport default {\n\tprops: ['site'],\n\tcomponents: { DateTimeControl },\n\tdata() {\n\t\treturn {\n\t\t\tshow: true,\n\t\t\ttargetServer: {\n\t\t\t\tlabel: '',\n\t\t\t\tvalue: ''\n\t\t\t},\n\t\t\ttargetDateTime: null,\n\t\t\tskipFailingPatches: false\n\t\t};\n\t},\n\twatch: {\n\t\ttargetServer(targetServer) {\n\t\t\tthis.$resources.isServerAddedInGroup.fetch({\n\t\t\t\tname: this.site,\n\t\t\t\tserver: targetServer.value\n\t\t\t});\n\t\t}\n\t},\n\tcomputed: {\n\t\t$site() {\n\t\t\treturn getCachedDocumentResource('Site', this.site);\n\t\t},\n\t\tmessage() {\n\t\t\tif (this.$resources.changeServerOptions.data.length === 0) {\n\t\t\t\treturn 'No servers available for your team to move the site to. Please create a server first.';\n\t\t\t} else if (\n\t\t\t\tthis.targetServer.value &&\n\t\t\t\t!this.$resources.isServerAddedInGroup.data\n\t\t\t) {\n\t\t\t\treturn \"The chosen server isn't added to the bench group yet. Please add the server to the bench groupfirst.\";\n\t\t\t} else if (\n\t\t\t\tthis.targetServer.value &&\n\t\t\t\tthis.$resources.isServerAddedInGroup.data\n\t\t\t) {\n\t\t\t\treturn 'The chosen server is already added to the bench. You can now migrate the site to the server.';\n\t\t\t} else return '';\n\t\t},\n\t\terrorMessage() {\n\t\t\treturn (\n\t\t\t\tthis.$resources.addServerToReleaseGroup.error ||\n\t\t\t\tthis.$resources.isServerAddedInGroup.error ||\n\t\t\t\tthis.$resources.changeServerOptions.error ||\n\t\t\t\tthis.$resources.changeServer.error\n\t\t\t);\n\t\t},\n\t\tdatetimeInIST() {\n\t\t\tif (!this.targetDateTime) return null;\n\t\t\tconst datetimeInIST = this.$dayjs(this.targetDateTime).format(\n\t\t\t\t'YYYY-MM-DDTHH:mm'\n\t\t\t);\n\n\t\t\treturn datetimeInIST;\n\t\t}\n\t},\n\tresources: {\n\t\tchangeServerOptions() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.change_server_options',\n\t\t\t\tparams: {\n\t\t\t\t\tname: this.site\n\t\t\t\t},\n\t\t\t\tinitialData: [],\n\t\t\t\tauto: true,\n\t\t\t\ttransform(d) {\n\t\t\t\t\treturn d.map(s => ({\n\t\t\t\t\t\tlabel: s.title || s.name,\n\t\t\t\t\t\tdescription: s.name,\n\t\t\t\t\t\tvalue: s.name\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\t\tisServerAddedInGroup() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.is_server_added_in_group',\n\t\t\t\tinitialData: false\n\t\t\t};\n\t\t},\n\t\tchangeServer() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.change_server',\n\t\t\t\tonSuccess() {\n\t\t\t\t\ttoast.success('Site has been scheduled to move to another server.');\n\t\t\t\t\tthis.show = false;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\t\taddServerToReleaseGroup() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.add_server_to_release_group',\n\t\t\t\tparams: {\n\t\t\t\t\tname: this.site,\n\t\t\t\t\tgroup_name: this.$site.doc?.group,\n\t\t\t\t\tserver: this.targetServer.value\n\t\t\t\t},\n\t\t\t\tonSuccess(data) {\n\t\t\t\t\ttoast.success(\n\t\t\t\t\t\t`Server ${this.targetServer.value} added to the bench. Please wait for the deploy to be completed.`\n\t\t\t\t\t);\n\n\t\t\t\t\tthis.$router.push({\n\t\t\t\t\t\tname: 'Release Group Job',\n\t\t\t\t\t\tparams: {\n\t\t\t\t\t\t\tname: this.$site.doc?.group,\n\t\t\t\t\t\t\tid: data\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.show = false;\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t},\n\tmethods: {\n\t\tresetValues() {\n\t\t\tthis.targetServer = {\n\t\t\t\tlabel: '',\n\t\t\t\tvalue: ''\n\t\t\t};\n\t\t\tthis.targetDateTime = null;\n\t\t\tthis.$resources.isServerAddedInGroup.reset();\n\t\t}\n\t}\n};\n</script>\n"],"names":["_sfc_main","d","s","_a","data","$data","_cache","$event","$options","_ctx","_b","_withCtx","_createCommentVNode","_openBlock","_createElementBlock","_hoisted_1"],"mappings":"+0BAmEA,MAAAA,EAAA,CACC,MAAA,CAAA,MAAA,iCAEA,MAAA,CACC,MAAA,CACC,KAAA,iBAEC,MAAA,GACA,MAAA,IAED,eAAA,6BAIF,MAAA,iBAEE,KAAA,WAAA,qBAAA,MAAA,CACC,KAAA,KAAA,mBAED,CAAA,CACD,GAED,SAAA,CACC,OAAA,6BAGA,SAAA,4DAEE,iHAGA,CAAA,KAAA,WAAA,qBAAA,KAEA,gIAGA,KAAA,WAAA,qBAAA,KAEA,mGAGF,cAAA,CACC,sDAEC,KAAA,WAAA,qBAAA,OACA,KAAA,WAAA,oBAAA,OACA,KAAA,WAAA,aAAA,OAGF,eAAA,CACC,OAAA,KAAA,uDAEC,oBAFD,IAMD,cAGA,qBAAA,CACC,MAAA,CACC,IAAA,uCACA,OAAA,iBAGA,YAAA,CAAA,EACA,KAAA,gBAEC,OAAAC,EAAA,IAAAC,IAAA,CACC,MAAAA,EAAA,OAAAA,EAAA,KACA,YAAAA,EAAA,iBAED,EAAA,CACD,2BAID,MAAA,CACC,IAAA,0CACA,YAAA,KAGF,cAAA,CACC,MAAA,CACC,IAAA,2GAGC,KAAA,KAAA,EACD,oCAID,MAAA,kDAEC,OAAA,CACC,KAAA,KAAA,KACA,YAAAC,EAAA,KAAA,MAAA,MAAA,YAAAA,EAAA,sCAGD,UAAAC,EAAA,iBAEE,UAAA,KAAA,aAAA,KAAA,oEAGD,KAAA,QAAA,KAAA,0BAEC,OAAA,8CAEC,GAAAA,CACD,CACD,CAAA,EAEA,KAAA,KAAA,EACD,EAEF,GAED,QAAA,eAEE,KAAA,aAAA,CACC,MAAA,GACA,MAAA,6BAGD,KAAA,WAAA,qBAAA,MAAA,CACD,CACD,CACD,WApJoD,MAAA,2BAQd,MAAA,2HAtDtC,WAAAC,EAAA,KAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,KAAAE,GAGG,QAAAC,EAAA,0JAC0L,SAAAC,EAAA,WAAA,qBAAA,MAAA,CAAAJ,EAAA,aAAA,2JAAmQ,GAAAK,GAAAP,EAAAM,EAAA,WAAA,sBAAA,YAAAN,EAAA,OAAA,MAAAO,EAAA,SAAuD,CAAAL,EAAA,aAAA,0GAAkK,OAAAA,EAAA,aAAA,2FA6B5oB,eAAAM,EAAA,IAAA,0DAET,MAAA,qBAIWF,EAAA,WAAA,oBAAA,KAAA,OAAA,kBACX,MAAA,gBACA,QAAA,UACA,KAAA,eACC,QAAAA,EAAA,WAAA,oBAAA,KA3CL,WAAAJ,EAAA,aAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,aAAAE,sCAAAK,EAAA,GAAA,EAAA,0CA8CGC,IAAAC,EAAA,MAAAC,EAAA,MA9CH,WAAAV,EAAA,eAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,eAAAE,GA+C8C,MAAA,6CAEzC,MAAA,8BACA,KAAA,WAlDL,WAAAF,EAAA,mBAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,mBAAAE,8BAAAK,EAAA,GAAA,EAAA,EAsDYJ,EAAA,SAAA,CAAAA,EAAA,2CAtDZI,EAAA,GAAA,EAAA,OAyDiB,MAAA,OAAc,QAAAJ,EAAA"}