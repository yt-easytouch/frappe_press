var m=(e,t,s)=>new Promise((r,i)=>{var l=o=>{try{d(s.next(o))}catch(u){i(u)}},c=o=>{try{d(s.throw(o))}catch(u){i(u)}},d=o=>o.done?r(o.value):Promise.resolve(o.value).then(l,c);d((s=s.apply(e,t)).next())});import{S as M}from"./StripeLogo-BRF2qIyd.js";import{x as k,r as A,q as _,o as h,u as b,j as n,A as a,aj as N,ag as C,ah as w,h as S,a9 as x,a8 as D,Y as g,t as E,w as I,X as V,n as $}from"./main-Dpl-JOF2.js";import{A as B}from"./AddressForm-Cz0XUJgF.js";import{l as F}from"./stripe.esm-D4yu_pm0.js";import"./Form-CIPLpg2e.js";(function(){try{var e=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},t=new Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="0c509540-4e2a-468d-ac3c-5098e45705fa",e._sentryDebugIdIdentifier="sentry-dbid-0c509540-4e2a-468d-ac3c-5098e45705fa")}catch(s){}})();{var p=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};p._sentryModuleMetadata=p._sentryModuleMetadata||{},p._sentryModuleMetadata[new Error().stack]=Object.assign({},p._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const j={name:"StripeCard",props:["withoutAddress"],emits:["complete"],components:{AddressForm:B,StripeLogo:M},data(){return{errorMessage:null,cardErrorMessage:null,ready:!1,setupIntent:null,billingInformation:{cardHolderName:"",country:"",gstin:""},gstNotApplicable:!1,addingCard:!1,tryingMicroCharge:!1}},mounted(){return m(this,null,function*(){this.setupCard();let{first_name:e,last_name:t=""}=this.$account.user,s=e+" "+t;this.billingInformation.cardHolderName=s.trimEnd()})},resources:{countryList:"press.api.account.country_list",billingAddress(){return{url:"press.api.account.get_billing_information",params:{timezone:this.browserTimezone},auto:!0,onSuccess(e){this.billingInformation.country=e==null?void 0:e.country,this.billingInformation.address=e==null?void 0:e.address_line1,this.billingInformation.city=e==null?void 0:e.city,this.billingInformation.state=e==null?void 0:e.state,this.billingInformation.postal_code=e==null?void 0:e.pincode}}}},methods:{setupCard(){return m(this,null,function*(){let e=yield this.$call("press.api.billing.get_publishable_key_and_setup_intent"),{publishable_key:t,setup_intent:s}=e;this.setupIntent=s,this.stripe=yield F(t),this.elements=this.stripe.elements();let r=this.$theme,i={base:{color:r.colors.black,fontFamily:r.fontFamily.sans.join(", "),fontSmoothing:"antialiased",fontSize:"13px","::placeholder":{color:r.colors.gray[400]}},invalid:{color:r.colors.red[600],iconColor:r.colors.red[600]}};this.card=this.elements.create("card",{hidePostalCode:!0,style:i,classes:{complete:"",focus:"bg-gray-100"}}),this.card.mount(this.$refs["card-element"]),this.card.addEventListener("change",l=>{var c;this.cardErrorMessage=((c=l.error)==null?void 0:c.message)||null}),this.card.addEventListener("ready",()=>{this.ready=!0})})},submit(){return m(this,null,function*(){this.addingCard=!0;let e;if(this.withoutAddress||(e=yield this.$refs["address-form"].validateValues()),e){this.errorMessage=e,this.addingCard=!1;return}else this.errorMessage=null;const{setupIntent:t,error:s}=yield this.stripe.confirmCardSetup(this.setupIntent.client_secret,{payment_method:{card:this.card,billing_details:{name:this.billingInformation.cardHolderName,address:{line1:this.billingInformation.address,city:this.billingInformation.city,state:this.billingInformation.state,postal_code:this.billingInformation.postal_code,country:this.getCountryCode(this.billingInformation.country)}}}});if(s){this.addingCard=!1;let r=s.message;r!="Your card number is incomplete."&&(this.errorMessage=r)}else if(t.status==="succeeded")try{const{payment_method_name:r}=yield this.$call("press.api.billing.setup_intent_success",{setup_intent:t,address:this.withoutAddress?null:this.billingInformation});yield this.verifyWithMicroChargeIfApplicable(r),this.addingCard=!1}catch(r){console.error(r),this.addingCard=!1,this.errorMessage=r.messages.join(`
`)}})},verifyWithMicroChargeIfApplicable(e){return m(this,null,function*(){const t=this.$account.team.currency,s=this.$account.feature_flags.verify_cards_with_micro_charge;s==="Both INR and USD"||s=="Only INR"&&t==="INR"||s==="Only USD"&&t==="USD"?yield this._verifyWithMicroCharge(e):this.$emit("complete")})},_verifyWithMicroCharge(e){return m(this,null,function*(){this.tryingMicroCharge=!0;const t=yield this.$call("press.api.billing.create_payment_intent_for_micro_debit",{payment_method_name:e});let{client_secret:s}=t;(yield this.stripe.confirmCardPayment(s,{payment_method:{card:this.card}})).paymentIntent.status==="succeeded"&&this.$emit("complete"),this.tryingMicroCharge=!1})},getCountryCode(e){return this.$resources.countryList.data.find(s=>s.name===e).code.toUpperCase()}},computed:{formattedMicroChargeAmount(){return this.$account.team.currency==="INR"?"â‚¹100":"$1"},browserTimezone(){return window.Intl?Intl.DateTimeFormat().resolvedOptions().timeZone:null}}},L={class:"relative"},R={key:0,class:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-8 transform"},T={class:"block"},U={class:"form-input mt-2 block h-[unset] w-full py-2 pl-3",ref:"card-element"},W={class:"mt-3"},z={class:"text-lg text-gray-800"},H={class:"mt-6 flex items-center justify-between"};function O(e,t,s,r,i,l){const c=N,d=x,o=D,u=A("AddressForm"),y=V,v=M;return h(),_("div",L,[i.ready?b("",!0):(h(),_("div",R,[a(c,{class:"h-5 w-5 text-gray-600"})])),n("div",{class:$({"opacity-0":!i.ready})},[C(n("div",null,[n("label",T,[t[2]||(t[2]=n("span",{class:"block text-xs text-gray-600"}," Credit or Debit Card ",-1)),n("div",U,null,512),a(d,{class:"mt-1",message:i.cardErrorMessage},null,8,["message"])]),a(o,{class:"mt-4",label:"Name on Card",type:"text",modelValue:i.billingInformation.cardHolderName,"onUpdate:modelValue":t[0]||(t[0]=f=>i.billingInformation.cardHolderName=f)},null,8,["modelValue"]),s.withoutAddress?b("",!0):(h(),S(u,{key:0,class:"mt-4",address:i.billingInformation,"onUpdate:address":t[1]||(t[1]=f=>i.billingInformation=f),ref:"address-form"},null,8,["address"]))],512),[[w,!i.tryingMicroCharge]]),C(n("div",W,[n("p",z,[t[3]||(t[3]=g(" We are attempting to charge your card with ")),n("strong",null,E(l.formattedMicroChargeAmount),1),t[4]||(t[4]=g(" to make sure the card works. This amount will be ")),t[5]||(t[5]=n("strong",null,"refunded",-1)),t[6]||(t[6]=g(" back to your account. "))]),a(y,{class:"mt-2",loading:!0},{default:I(()=>t[7]||(t[7]=[g("Attempting Test Charge")])),_:1})],512),[[w,i.tryingMicroCharge]]),a(d,{class:"mt-2",message:i.errorMessage},null,8,["message"]),n("div",H,[a(v),a(y,{variant:"solid",onClick:l.submit,loading:i.addingCard},{default:I(()=>t[8]||(t[8]=[g(" Save Card ")])),_:1},8,["onClick","loading"])])],2)])}const J=k(j,[["render",O]]);export{J as default};
//# sourceMappingURL=StripeCard-BRr8QCrN.js.map
