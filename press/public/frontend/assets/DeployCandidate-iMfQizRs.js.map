{"version":3,"file":"DeployCandidate-iMfQizRs.js","sources":["../../../../dashboard/src2/pages/DeployCandidate.vue"],"sourcesContent":["<template>\n\t<div class=\"p-5\" v-if=\"deploy\">\n\t\t<AlertAddressableError\n\t\t\tv-if=\"error\"\n\t\t\tclass=\"mb-5\"\n\t\t\t:name=\"error.name\"\n\t\t\t:title=\"error.title\"\n\t\t\t@done=\"$resources.errors.reload()\"\n\t\t/>\n\t\t<AlertBanner\n\t\t\tv-if=\"alertMessage && !error\"\n\t\t\t:title=\"alertMessage\"\n\t\t\ttype=\"warning\"\n\t\t\tclass=\"mb-5\"\n\t\t/>\n\t\t<Button :route=\"{ name: `${object.doctype} Detail Deploys` }\">\n\t\t\t<template #prefix>\n\t\t\t\t<i-lucide-arrow-left class=\"inline-block h-4 w-4\" />\n\t\t\t</template>\n\t\t\tAll deploys\n\t\t</Button>\n\n\t\t<div class=\"mt-3\">\n\t\t\t<div class=\"flex w-full items-center\">\n\t\t\t\t<h2 class=\"text-lg font-medium text-gray-900\">\n\t\t\t\t\t{{ deploy.deploy_candidate }}\n\t\t\t\t</h2>\n\t\t\t\t<Badge class=\"ml-2\" :label=\"deploy.status\" />\n\t\t\t\t<div class=\"ml-auto flex items-center space-x-2\">\n\t\t\t\t\t<Button\n\t\t\t\t\t\t@click=\"$resources.deploy.reload()\"\n\t\t\t\t\t\t:loading=\"$resources.deploy.get.loading\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<template #icon>\n\t\t\t\t\t\t\t<i-lucide-refresh-ccw class=\"h-4 w-4\" />\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</Button>\n\t\t\t\t\t<Dropdown v-if=\"dropdownOptions?.length\" :options=\"dropdownOptions\">\n\t\t\t\t\t\t<template v-slot=\"{ open }\">\n\t\t\t\t\t\t\t<Button>\n\t\t\t\t\t\t\t\t<template #icon>\n\t\t\t\t\t\t\t\t\t<i-lucide-more-horizontal class=\"h-4 w-4\" />\n\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</Dropdown>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t\t<div class=\"mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-5\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class=\"text-sm font-medium text-gray-500\">Creation</div>\n\t\t\t\t\t\t<div class=\"mt-2 text-sm text-gray-900\">\n\t\t\t\t\t\t\t{{ $format.date(deploy.creation, 'lll') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class=\"text-sm font-medium text-gray-500\">Creator</div>\n\t\t\t\t\t\t<div class=\"mt-2 text-sm text-gray-900\">\n\t\t\t\t\t\t\t{{ deploy.owner }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class=\"text-sm font-medium text-gray-500\">Duration</div>\n\t\t\t\t\t\t<div class=\"mt-2 text-sm text-gray-900\">\n\t\t\t\t\t\t\t{{\n\t\t\t\t\t\t\t\tdeploy.build_end ? $format.duration(deploy.build_duration) : '-'\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class=\"text-sm font-medium text-gray-500\">Start</div>\n\t\t\t\t\t\t<div class=\"mt-2 text-sm text-gray-900\">\n\t\t\t\t\t\t\t{{ $format.date(deploy.build_start, 'lll') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class=\"text-sm font-medium text-gray-500\">End</div>\n\t\t\t\t\t\t<div class=\"mt-2 text-sm text-gray-900\">\n\t\t\t\t\t\t\t{{\n\t\t\t\t\t\t\t\tdeploy.build_end ? $format.date(deploy.build_end, 'lll') : '-'\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<!-- Build Steps -->\n\t\t<div :class=\"deploy.build_error ? 'mt-4' : 'mt-8'\" class=\"space-y-4\">\n\t\t\t<JobStep\n\t\t\t\tv-for=\"step in deploy.build_steps\"\n\t\t\t\t:step=\"step\"\n\t\t\t\t:key=\"step.name\"\n\t\t\t/>\n\t\t\t<JobStep v-for=\"job in deploy.jobs\" :step=\"job\" :key=\"job.name\" />\n\t\t</div>\n\t</div>\n</template>\n<script>\nimport { createResource, getCachedDocumentResource } from 'frappe-ui';\nimport { getObject } from '../objects';\nimport JobStep from '../components/JobStep.vue';\nimport AlertAddressableError from '../components/AlertAddressableError.vue';\nimport AlertBanner from '../components/AlertBanner.vue';\nimport dayjs from 'dayjs';\nimport { toast } from 'vue-sonner';\n\nexport default {\n\tname: 'DeployCandidate',\n\tprops: ['id', 'objectType'],\n\tcomponents: {\n\t\tJobStep,\n\t\tAlertBanner,\n\t\tAlertAddressableError,\n\t},\n\tresources: {\n\t\tdeploy() {\n\t\t\treturn {\n\t\t\t\ttype: 'document',\n\t\t\t\tdoctype: 'Deploy Candidate Build',\n\t\t\t\tname: this.id,\n\t\t\t\ttransform: this.transformDeploy,\n\t\t\t};\n\t\t},\n\t\terrors() {\n\t\t\treturn {\n\t\t\t\ttype: 'list',\n\t\t\t\tcache: [\n\t\t\t\t\t'Press Notification',\n\t\t\t\t\t'Error',\n\t\t\t\t\t'Deploy Candidate Build',\n\t\t\t\t\tthis.id,\n\t\t\t\t],\n\t\t\t\tdoctype: 'Press Notification',\n\t\t\t\tauto: true,\n\t\t\t\tfields: ['title', 'name'],\n\t\t\t\tfilters: {\n\t\t\t\t\tdocument_type: 'Deploy Candidate Build',\n\t\t\t\t\tdocument_name: this.id,\n\t\t\t\t\tis_actionable: true,\n\t\t\t\t\tclass: 'Error',\n\t\t\t\t},\n\t\t\t\tlimit: 1,\n\t\t\t};\n\t\t},\n\t},\n\tmounted() {\n\t\tthis.$socket.emit('doc_subscribe', 'Deploy Candidate Build', this.id);\n\t\tthis.$socket.on(`bench_deploy:${this.id}:steps`, (data) => {\n\t\t\tif (data.name === this.id && this.$resources.deploy.doc) {\n\t\t\t\tthis.$resources.deploy.doc.build_steps = this.transformDeploy({\n\t\t\t\t\tbuild_steps: data.steps,\n\t\t\t\t})?.build_steps;\n\t\t\t}\n\t\t});\n\t\tthis.$socket.on(`bench_deploy:${this.id}:finished`, () => {\n\t\t\tconst rgDoc = getCachedDocumentResource(\n\t\t\t\t'Release Group',\n\t\t\t\tthis.$resources.deploy.doc?.group,\n\t\t\t);\n\t\t\tif (rgDoc) rgDoc.reload();\n\t\t\tthis.$resources.deploy.reload();\n\t\t\tthis.$resources.errors.reload();\n\t\t});\n\t},\n\tbeforeUnmount() {\n\t\tthis.$socket.emit('doc_unsubscribe', 'Deploy Candidate Build', this.id);\n\t\tthis.$socket.off(`bench_deploy:${this.id}:steps`);\n\t},\n\tcomputed: {\n\t\tdeploy() {\n\t\t\treturn this.$resources.deploy.doc;\n\t\t},\n\t\tobject() {\n\t\t\treturn getObject(this.objectType);\n\t\t},\n\t\terror() {\n\t\t\treturn this.$resources.errors?.data?.[0] ?? null;\n\t\t},\n\t\talertMessage() {\n\t\t\tif (!this.deploy) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif (this.deploy.retry_count > 0 && this.deploy.status === 'Scheduled') {\n\t\t\t\treturn 'Previous deploy failed, re-deploy will be attempted soon';\n\t\t\t}\n\t\t\treturn null;\n\t\t},\n\t\tdropdownOptions() {\n\t\t\treturn [\n\t\t\t\t{\n\t\t\t\t\tlabel: 'View in Desk',\n\t\t\t\t\ticon: 'external-link',\n\t\t\t\t\tcondition: () => this.$team?.doc?.is_desk_user,\n\t\t\t\t\tonClick: () => {\n\t\t\t\t\t\twindow.open(\n\t\t\t\t\t\t\t`${window.location.protocol}//${window.location.host}/app/deploy-candidate-build/${this.id}`,\n\t\t\t\t\t\t\t'_blank',\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlabel: 'Fail and Redeploy',\n\t\t\t\t\ticon: 'repeat',\n\t\t\t\t\tcondition: () => this.showFailAndRedeploy,\n\t\t\t\t\tonClick: () => this.failAndRedeploy(),\n\t\t\t\t},\n\t\t\t].filter((option) => option.condition?.() ?? true);\n\t\t},\n\t\tshowFailAndRedeploy() {\n\t\t\tif (!this.deploy || this.deploy.status !== 'Running') {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tconst start = dayjs(this.deploy.build_start);\n\t\t\tconst now = dayjs(new Date());\n\n\t\t\treturn now.diff(start, 'hours') > 2;\n\t\t},\n\t},\n\tmethods: {\n\t\ttransformDeploy(deploy) {\n\t\t\tfor (let step of deploy.build_steps) {\n\t\t\t\tif (step.status === 'Running') {\n\t\t\t\t\tstep.isOpen = true;\n\t\t\t\t} else {\n\t\t\t\t\tstep.isOpen = this.$resources.deploy?.doc?.build_steps?.find(\n\t\t\t\t\t\t(s) => s.name === step.name,\n\t\t\t\t\t)?.isOpen;\n\t\t\t\t}\n\t\t\t\tstep.title = `${step.stage} - ${step.step}`;\n\t\t\t\tstep.output =\n\t\t\t\t\tstep.command || step.output\n\t\t\t\t\t\t? `${step.command || ''}\\n${step.output || ''}`.trim()\n\t\t\t\t\t\t: '';\n\t\t\t\tstep.duration = ['Success', 'Failure'].includes(step.status)\n\t\t\t\t\t? step.cached\n\t\t\t\t\t\t? 'Cached'\n\t\t\t\t\t\t: `${step.duration}s`\n\t\t\t\t\t: null;\n\t\t\t}\n\t\t\treturn deploy;\n\t\t},\n\t\tfailAndRedeploy() {\n\t\t\tif (!this.deploy) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst group = this.deploy.group;\n\t\t\tconst onError = () => toast.error('Could not fail and redeploy');\n\t\t\tconst router = this.$router;\n\n\t\t\tcreateResource({\n\t\t\t\turl: 'press.api.bench.fail_and_redeploy',\n\t\t\t\tparams: { name: group, dc_name: this.deploy.name },\n\t\t\t\tonSuccess(name) {\n\t\t\t\t\tif (!name) {\n\t\t\t\t\t\tonError();\n\t\t\t\t\t} else {\n\t\t\t\t\t\trouter.push(`/groups/${group}/deploys/${name}`);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonError,\n\t\t\t}).fetch();\n\t\t},\n\t},\n};\n</script>\n"],"names":["_sfc_main","JobStep","AlertAddressableError","rgDoc","getCachedDocumentResource","_a","getObject","_c","_b","start","dayjs","step","deploy","createResource","group","name","onError","_hoisted_2","_hoisted_3","_hoisted_4","_hoisted_5","_hoisted_6","_hoisted_7","_hoisted_8","_hoisted_9","_hoisted_10","_hoisted_11","_openBlock","_createElementBlock","_hoisted_1","_cache","$event","_ctx","_createCommentVNode","$options","_withCtx","_createTextVNode","_createElementVNode","_toDisplayString","_normalizeClass","_Fragment","_renderList","job"],"mappings":"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"}