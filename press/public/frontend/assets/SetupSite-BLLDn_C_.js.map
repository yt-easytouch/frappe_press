{"version":3,"file":"SetupSite-BLLDn_C_.js","sources":["../../../../dashboard/src2/pages/saas/SetupSite.vue"],"sourcesContent":["<template>\n\t<div\n\t\tclass=\"flex h-screen w-screen items-center justify-center\"\n\t\tv-if=\"$resources.saasProduct.loading\"\n\t>\n\t\t<Spinner class=\"mr-2 w-4\" />\n\t\t<p class=\"text-gray-800\">Loading</p>\n\t</div>\n\t<div class=\"flex h-screen overflow-hidden sm:bg-gray-50\" v-else>\n\t\t<div class=\"w-full overflow-auto\">\n\t\t\t<LoginBox\n\t\t\t\tv-if=\"saasProduct\"\n\t\t\t\ttitle=\"Letâ€™s set up your site\"\n\t\t\t\t:logo=\"saasProduct?.logo\"\n\t\t\t>\n\t\t\t\t<template v-slot:logo v-if=\"saasProduct\">\n\t\t\t\t\t<div class=\"mx-auto flex items-center space-x-2\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tclass=\"inline-block h-7 w-7 rounded-sm\"\n\t\t\t\t\t\t\t:src=\"saasProduct?.logo\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tclass=\"select-none text-xl font-semibold tracking-tight text-gray-900\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{ saasProduct?.title }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t\t<template v-slot:default>\n\t\t\t\t\t<form class=\"w-full space-y-4\" @submit.prevent=\"createSite\">\n\t\t\t\t\t\t<div class=\"w-full space-y-1.5\">\n\t\t\t\t\t\t\t<label class=\"block text-xs text-ink-gray-5\">\n\t\t\t\t\t\t\t\tEnter subdomain for your site\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<div class=\"col-span-2 flex w-full\">\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tclass=\"dark:[color-scheme:dark] z-10 h-7 w-full rounded rounded-r-none border border-outline-gray-2 bg-surface-white py-1.5 pl-2 pr-2 text-base text-ink-gray-8 placeholder-ink-gray-4 transition-colors hover:border-outline-gray-3 hover:shadow-sm focus:border-outline-gray-4 focus:bg-surface-white focus:shadow-sm focus:ring-0 focus-visible:ring-2 focus-visible:ring-outline-gray-3\"\n\t\t\t\t\t\t\t\t\t:placeholder=\"`${saasProduct.name}-site`\"\n\t\t\t\t\t\t\t\t\tv-model=\"subdomain\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tclass=\"flex items-center rounded-r bg-gray-100 px-2 text-base\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t.{{ saasProduct.domain }}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"mt-1\">\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tv-if=\"$resources.subdomainExists.loading\"\n\t\t\t\t\t\t\t\t\tclass=\"text-sm text-gray-600\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tChecking...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<template\n\t\t\t\t\t\t\t\t\tv-else-if=\"\n\t\t\t\t\t\t\t\t\t\t!$resources.subdomainExists.error &&\n\t\t\t\t\t\t\t\t\t\t$resources.subdomainExists.fetched &&\n\t\t\t\t\t\t\t\t\t\tsubdomain\n\t\t\t\t\t\t\t\t\t\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tv-if=\"$resources.subdomainExists.data\"\n\t\t\t\t\t\t\t\t\t\tclass=\"text-sm text-green-600\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{{ subdomain }}.{{ saasProduct.domain }} is available\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div v-else class=\"text-sm text-red-600\">\n\t\t\t\t\t\t\t\t\t\t{{ subdomain }}.{{ saasProduct.domain }} is not available\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t<ErrorMessage :message=\"$resources.subdomainExists.error\" />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<FormControl\n\t\t\t\t\t\t\tlabel=\"Email address (will be your login ID)\"\n\t\t\t\t\t\t\t:modelValue=\"$team.doc.user\"\n\t\t\t\t\t\t\t:disabled=\"true\"\n\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t\tclass=\"mb-4\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<ErrorMessage\n\t\t\t\t\t\t\tclass=\"mt-2\"\n\t\t\t\t\t\t\t:message=\"$resources.createSite?.error\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tclass=\"mt-8 w-full\"\n\t\t\t\t\t\t\tvariant=\"solid\"\n\t\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t\t\t:disabled=\"\n\t\t\t\t\t\t\t\t!!$resources.subdomainExists.error ||\n\t\t\t\t\t\t\t\t!$resources.subdomainExists.data ||\n\t\t\t\t\t\t\t\t!subdomain.length\n\t\t\t\t\t\t\t\"\n\t\t\t\t\t\t\t:loading=\"findingClosestServer || $resources.createSite?.loading\"\n\t\t\t\t\t\t\tloadingText=\"Creating site...\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tNext\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</form>\n\t\t\t\t</template>\n\t\t\t\t<template v-slot:footer>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass=\"mt-2 flex w-full items-center justify-center text-sm text-gray-600\"\n\t\t\t\t\t>\n\t\t\t\t\t\tPowered by Easytouch Cloud\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</LoginBox>\n\t\t</div>\n\t</div>\n</template>\n<script>\nimport { toast } from 'vue-sonner';\nimport { debounce } from 'frappe-ui';\nimport LoginBox from '../../components/auth/LoginBox.vue';\nimport { validateSubdomain } from '../../utils/site';\nimport { DashboardError } from '../../utils/error';\n\nexport default {\n\tname: 'SignupSetup',\n\tprops: ['productId'],\n\tcomponents: {\n\t\tLoginBox,\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tprogressErrorCount: 0,\n\t\t\tfindingClosestServer: false,\n\t\t\tclosestCluster: null,\n\t\t\tsubdomain: '',\n\t\t};\n\t},\n\twatch: {\n\t\tsubdomain: {\n\t\t\thandler: debounce(function () {\n\t\t\t\tthis.$resources.subdomainExists.submit();\n\t\t\t}, 500),\n\t\t},\n\t},\n\tresources: {\n\t\tsiteRequest() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.product_trial.get_request',\n\t\t\t\tparams: {\n\t\t\t\t\tproduct: this.productId,\n\t\t\t\t\taccount_request: this.$team.doc.account_request,\n\t\t\t\t},\n\t\t\t\tauto: true,\n\t\t\t\tinitialData: {},\n\t\t\t\tonSuccess: (data) => {\n\t\t\t\t\tif (data?.status !== 'Pending') {\n\t\t\t\t\t\tthis.$router.push({\n\t\t\t\t\t\t\tname: 'SignupLoginToSite',\n\t\t\t\t\t\t\tparams: { productId: this.productId },\n\t\t\t\t\t\t\tquery: {\n\t\t\t\t\t\t\t\tproduct_trial_request: data.name,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonError(error) {\n\t\t\t\t\ttoast.error(error.messages.join('\\n'));\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tsaasProduct() {\n\t\t\treturn {\n\t\t\t\ttype: 'document',\n\t\t\t\tdoctype: 'Product Trial',\n\t\t\t\tname: this.productId,\n\t\t\t\tauto: true,\n\t\t\t};\n\t\t},\n\t\tsubdomainExists() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.exists',\n\t\t\t\tmakeParams() {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tdomain: this.saasProduct?.domain,\n\t\t\t\t\t\tsubdomain: this.subdomain,\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tvalidate() {\n\t\t\t\t\tconst error = validateSubdomain(this.subdomain);\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\tthrow new DashboardError(error);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\ttransform(data) {\n\t\t\t\t\treturn !Boolean(data);\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tcreateSite() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.client.run_doc_method',\n\t\t\t\tmakeParams: () => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tdt: 'Product Trial Request',\n\t\t\t\t\t\tdn: this.$resources.siteRequest.data.name,\n\t\t\t\t\t\tmethod: 'create_site',\n\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\tsubdomain: this.subdomain,\n\t\t\t\t\t\t\tcluster: this.closestCluster ?? 'Default',\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tauto: false,\n\t\t\t\tonSuccess: (data) => {\n\t\t\t\t\tthis.$router.push({\n\t\t\t\t\t\tname: 'SignupLoginToSite',\n\t\t\t\t\t\tparams: { productId: this.productId },\n\t\t\t\t\t\tquery: {\n\t\t\t\t\t\t\tproduct_trial_request: this.$resources.siteRequest.data.name,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t},\n\tcomputed: {\n\t\tsaasProduct() {\n\t\t\treturn this.$resources.saasProduct.doc;\n\t\t},\n\t},\n\tmethods: {\n\t\tasync createSite() {\n\t\t\tawait this.getClosestCluster();\n\t\t\treturn this.$resources.createSite.submit();\n\t\t},\n\t\tasync getClosestCluster() {\n\t\t\tif (this.closestCluster) return this.closestCluster;\n\t\t\tlet proxyServers = Object.keys(this.saasProduct.proxy_servers);\n\t\t\tif (proxyServers.length > 0) {\n\t\t\t\tthis.findingClosestServer = true;\n\t\t\t\tlet promises = proxyServers.map((server) => this.getPingTime(server));\n\t\t\t\tlet results = await Promise.allSettled(promises);\n\t\t\t\tlet fastestServer = results.reduce((a, b) =>\n\t\t\t\t\ta.value.pingTime < b.value.pingTime ? a : b,\n\t\t\t\t);\n\t\t\t\tlet closestServer = fastestServer.value.server;\n\t\t\t\tlet closestCluster = this.saasProduct.proxy_servers[closestServer];\n\t\t\t\tif (!this.closestCluster) {\n\t\t\t\t\tthis.closestCluster = closestCluster;\n\t\t\t\t}\n\t\t\t\tthis.findingClosestServer = false;\n\t\t\t}\n\t\t\treturn this.closestCluster;\n\t\t},\n\t\tasync getPingTime(server) {\n\t\t\tlet pingTime = 999999;\n\t\t\ttry {\n\t\t\t\tlet t1 = new Date().getTime();\n\t\t\t\tawait fetch(`https://${server}`);\n\t\t\t\tlet t2 = new Date().getTime();\n\t\t\t\tpingTime = t2 - t1;\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(error);\n\t\t\t}\n\t\t\treturn { server, pingTime };\n\t\t},\n\t\tredirectToLogin() {\n\t\t\tthis.$router.push({\n\t\t\t\tname: 'Login',\n\t\t\t});\n\t\t},\n\t},\n};\n</script>\n"],"names":["_sfc_main","LoginBox","data","error","toast","_a","validateSubdomain","__async","promises","proxyServers","server","closestServer","a","b","closestCluster","pingTime","t1","_hoisted_3","_hoisted_4","_hoisted_5","_hoisted_6","_hoisted_7","_hoisted_8","_hoisted_9","_hoisted_10","_hoisted_11","_openBlock","_createElementBlock","_hoisted_1","_cache","_createElementVNode","_hoisted_2","_createSlots","_withCtx","$event","$data","_toDisplayString","$options","_Fragment","_createCommentVNode","_ctx","_b","_createTextVNode"],"mappings":"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"}