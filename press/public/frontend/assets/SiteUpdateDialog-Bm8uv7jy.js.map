{"version":3,"file":"SiteUpdateDialog-Bm8uv7jy.js","sources":["../../../../dashboard/src2/components/SiteUpdateDialog.vue"],"sourcesContent":["<template>\n\t<Dialog\n\t\tv-model=\"show\"\n\t\t:options=\"{\n\t\t\ttitle: dialogTitle,\n\t\t\tsize: '2xl',\n\t\t}\"\n\t>\n\t\t<template #body-content>\n\t\t\t<template v-if=\"updatableApps.length > 0\">\n\t\t\t\t<GenericList :options=\"listOptions\" />\n\t\t\t\t<div class=\"mt-4 flex flex-col space-y-4\">\n\t\t\t\t\t<DateTimeControl v-model=\"scheduledTime\" label=\"Schedule Time\" />\n\t\t\t\t\t<div class=\"flex flex-col space-y-2\">\n\t\t\t\t\t\t<FormControl\n\t\t\t\t\t\t\tlabel=\"Skip failing patches if any\"\n\t\t\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\t\t\tv-model=\"skipFailingPatches\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<FormControl\n\t\t\t\t\t\t\tlabel=\"Skip taking backup for this update (If the update fails, rollback will not occur)\"\n\t\t\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\t\t\tv-model=\"skipBackups\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<div v-else class=\"text-center text-base text-gray-600\">\n\t\t\t\tNo apps to update\n\t\t\t</div>\n\t\t\t<ErrorMessage class=\"mt-4\" :message=\"$site.scheduleUpdate.error\" />\n\t\t</template>\n\t\t<template #actions>\n\t\t\t<Button\n\t\t\t\tv-if=\"existingUpdate\"\n\t\t\t\tclass=\"w-full\"\n\t\t\t\tvariant=\"solid\"\n\t\t\t\tlabel=\"Edit Update\"\n\t\t\t\t@click=\"editUpdate\"\n\t\t\t/>\n\t\t\t<Button\n\t\t\t\tv-else\n\t\t\t\tclass=\"w-full\"\n\t\t\t\tvariant=\"solid\"\n\t\t\t\t:loading=\"$site.scheduleUpdate.loading\"\n\t\t\t\t:label=\"`Update ${\n\t\t\t\t\tscheduledTime ? `at ${scheduledTimeInLocal}` : 'Now'\n\t\t\t\t}`\"\n\t\t\t\t@click=\"scheduleUpdate\"\n\t\t\t/>\n\t\t</template>\n\t</Dialog>\n</template>\n<script>\nimport { getCachedDocumentResource } from 'frappe-ui';\nimport DateTimeControl from './DateTimeControl.vue';\nimport GenericList from './GenericList.vue';\nimport dayjs, { dayjsIST } from '../utils/dayjs';\nimport { toast } from 'vue-sonner';\n\nexport default {\n\tname: 'SiteUpdateDialog',\n\tprops: {\n\t\tsite: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\texistingUpdate: String,\n\t},\n\tcomponents: {\n\t\tGenericList,\n\t\tDateTimeControl,\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tshow: true,\n\t\t\tskipFailingPatches: false,\n\t\t\tscheduledTime: '',\n\t\t\tskipBackups: false,\n\t\t};\n\t},\n\tresources: {\n\t\tsiteUpdate() {\n\t\t\treturn {\n\t\t\t\t// for some reason, type: document won't work after the first time\n\t\t\t\t// TODO: investigate why\n\t\t\t\turl: 'press.api.client.get',\n\t\t\t\tparams: {\n\t\t\t\t\tdoctype: 'Site Update',\n\t\t\t\t\tname: this.existingUpdate,\n\t\t\t\t},\n\t\t\t\tauto: !!this.existingUpdate,\n\t\t\t\tonSuccess: (doc) => {\n\t\t\t\t\tthis.initializeValues(doc);\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t},\n\tcomputed: {\n\t\tscheduledTimeInIST() {\n\t\t\tif (!this.scheduledTime) return;\n\t\t\treturn dayjsIST(this.scheduledTime).format('YYYY-MM-DDTHH:mm');\n\t\t},\n\t\tscheduledTimeInLocal() {\n\t\t\treturn dayjs(this.scheduledTime).format('lll');\n\t\t},\n\t\tlistOptions() {\n\t\t\treturn {\n\t\t\t\tdata: this.updatableApps.filter(\n\t\t\t\t\t(app) => app.current_hash !== app.next_hash,\n\t\t\t\t),\n\t\t\t\tcolumns: [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'App',\n\t\t\t\t\t\tfieldname: 'app',\n\t\t\t\t\t\tformat(value, row) {\n\t\t\t\t\t\t\treturn row.title || value;\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'Current Version',\n\t\t\t\t\t\ttype: 'Badge',\n\t\t\t\t\t\tformat(value, row) {\n\t\t\t\t\t\t\treturn row.will_branch_change\n\t\t\t\t\t\t\t\t? row.current_branch\n\t\t\t\t\t\t\t\t: row.current_tag || row.current_hash.slice(0, 7);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlink(value, row) {\n\t\t\t\t\t\t\tif (row.will_branch_change) {\n\t\t\t\t\t\t\t\treturn `${row.repository_url}/tree/${row.current_branch}`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (row.current_tag) {\n\t\t\t\t\t\t\t\treturn `${row.repository_url}/releases/tag/${row.current_tag}`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (row.current_hash) {\n\t\t\t\t\t\t\t\treturn `${row.repository_url}/commit/${row.current_hash}`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'Next Version',\n\t\t\t\t\t\ttype: 'Badge',\n\t\t\t\t\t\tformat(value, row) {\n\t\t\t\t\t\t\treturn row.will_branch_change\n\t\t\t\t\t\t\t\t? row.branch\n\t\t\t\t\t\t\t\t: row.next_tag || row.next_hash.slice(0, 7);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlink(value, row) {\n\t\t\t\t\t\t\tif (row.will_branch_change) {\n\t\t\t\t\t\t\t\treturn `${row.repository_url}/tree/${row.branch}`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (row.next_tag) {\n\t\t\t\t\t\t\t\treturn `${row.repository_url}/releases/tag/${row.next_tag}`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (row.next_hash) {\n\t\t\t\t\t\t\t\treturn `${row.repository_url}/commit/${row.next_hash}`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t};\n\t\t},\n\t\tupdatableApps() {\n\t\t\tif (!this.$site.doc.update_information.update_available) return [];\n\t\t\tlet installedApps = this.$site.doc.update_information.installed_apps.map(\n\t\t\t\t(d) => d.app,\n\t\t\t);\n\t\t\treturn this.$site.doc.update_information.apps.filter((app) =>\n\t\t\t\tinstalledApps.includes(app.app),\n\t\t\t);\n\t\t},\n\t\t$site() {\n\t\t\treturn getCachedDocumentResource('Site', this.site);\n\t\t},\n\t\tsiteUpdate() {\n\t\t\treturn this.$resources.siteUpdate;\n\t\t},\n\t\tdialogTitle() {\n\t\t\tif (this.existingUpdate) return 'Edit Scheduled Update';\n\t\t\telse return 'Updates Available';\n\t\t},\n\t},\n\tmethods: {\n\t\tscheduleUpdate() {\n\t\t\tthis.$site.scheduleUpdate.submit(\n\t\t\t\t{\n\t\t\t\t\tskip_failing_patches: this.skipFailingPatches,\n\t\t\t\t\tskip_backups: this.skipBackups,\n\t\t\t\t\tscheduled_time: this.scheduledTimeInIST,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tonSuccess: () => {\n\t\t\t\t\t\tthis.$site.reload();\n\t\t\t\t\t\tthis.show = false;\n\t\t\t\t\t\tthis.$router.push({ name: 'Site Detail Updates' });\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\t\t},\n\t\teditUpdate() {\n\t\t\ttoast.promise(\n\t\t\t\tthis.$site.editScheduledUpdate.submit({\n\t\t\t\t\tname: this.existingUpdate,\n\t\t\t\t\tskip_failing_patches: this.skipFailingPatches,\n\t\t\t\t\tskip_backups: this.skipBackups,\n\t\t\t\t\tscheduled_time: this.scheduledTimeInIST,\n\t\t\t\t}),\n\t\t\t\t{\n\t\t\t\t\tloading: 'Editing scheduled update...',\n\t\t\t\t\tsuccess: () => {\n\t\t\t\t\t\tthis.show = false;\n\t\t\t\t\t\tthis.$site.reload();\n\t\t\t\t\t\tthis.siteUpdate.reload();\n\t\t\t\t\t\treturn 'Scheduled update edited successfully';\n\t\t\t\t\t},\n\t\t\t\t\terror: (err) => {\n\t\t\t\t\t\treturn err.messages.length\n\t\t\t\t\t\t\t? err.messages[0]\n\t\t\t\t\t\t\t: err.message || 'Failed to edit scheduled update';\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\t\t},\n\t\tinitializeValues(doc) {\n\t\t\tthis.skipFailingPatches = doc.skipped_failing_patches;\n\t\t\tthis.skipBackups = doc.skipped_backups;\n\t\t\tthis.scheduledTime = dayjs(doc.scheduled_time).format('YYYY-MM-DDTHH:mm');\n\t\t},\n\t},\n};\n</script>\n"],"names":["_sfc_main","DateTimeControl","doc","dayjs","app","value","row","installedApps","err","_hoisted_1","_hoisted_2","$data","_cache","$event","_withCtx","$options","_openBlock","_createElementBlock","_Fragment","_createElementVNode"],"mappings":"44BA4DA,MAAAA,EAAA,yBAEC,MAAA,gCAKC,eAAA,kCAIA,gBAAAC,GAED,MAAA,CACC,MAAA,CACC,KAAA,yBAEA,cAAA,GACA,YAAA,6BAKA,MAAA,4BAIC,OAAA,CACC,QAAA,mEAID,UAAAC,GAAA,8BAMH,SAAA,CACC,oBAAA,uGAKC,OAAAC,EAAA,KAAA,aAAA,EAAA,OAAA,KAAA,iBAGA,MAAA,CACC,KAAA,KAAA,cAAA,OACCC,GAAAA,EAAA,eAAAA,EAAA,WAED,QAAA,CACC,aAEC,UAAA,MACA,OAAAC,EAAAC,EAAA,qBAID,sCAGC,OAAAD,EAAAC,EAAA,6BAEEA,EAAA,eACAA,EAAA,aAAAA,EAAA,aAAA,MAAA,EAAA,CAAA,GAEF,KAAAD,EAAAC,EAAA,8EAIC,GAAAA,EAAA,sEAGA,GAAAA,EAAA,oEAKF,CACC,MAAA,4BAEA,OAAAD,EAAAC,EAAA,sCAGEA,EAAA,UAAAA,EAAA,UAAA,MAAA,EAAA,CAAA,GAEF,KAAAD,EAAAC,EAAA,sEAIC,GAAAA,EAAA,gEAGA,GAAAA,EAAA,iEAQL,eAAA,CACC,GAAA,CAAA,KAAA,MAAA,IAAA,mBAAA,iBAAA,MAAA,CAAA,EACA,IAAAC,EAAA,KAAA,MAAA,IAAA,mBAAA,eAAA,sEAICA,EAAA,SAAAH,EAAA,GAAA,IAGF,OAAA,0CAIC,OAAA,KAAA,WAAA,mGAOF,QAAA,CACC,gBAAA,CACC,KAAA,MAAA,eAAA,OACC,CACC,qBAAA,KAAA,iDAEA,eAAA,KAAA,oBAED,CACC,UAAA,IAAA,CACC,KAAA,MAAA,OAAA,EACA,KAAA,KAAA,GACA,KAAA,QAAA,KAAA,CAAA,KAAA,qBAAA,CAAA,6BAOF,KAAA,MAAA,oBAAA,OAAA,0BAEC,qBAAA,KAAA,iDAEA,eAAA,KAAA,kBACD,CAAA,EACA,CACC,QAAA,2CAEC,KAAA,KAAA,GACA,KAAA,MAAA,OAAA,2BAEA,mEAICI,EAAA,SAAA,CAAA,EACAA,EAAA,SAAA,qCAKL,iBAAAN,EAAA,mDAEC,KAAA,YAAAA,EAAA,gBACA,KAAA,cAAAC,EAAAD,EAAA,cAAA,EAAA,OAAA,kBAAA,GAGH,EA1NSO,EAAA,CAAA,MAAA,8BAAA,EAECC,EAAA,CAAA,MAAA,yBAAA,WAcK,MAAA,+IA3Bf,WAAAC,EAAA,KAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,KAAAE,8CAQa,eAAAC,EAAA,IAAA,CACMC,EAAA,cAAA,OAAA,GAAhBC,EAAA,EAAAC,EAAAC,EAAA,CAAA,IAAA,CAAA,EAAA,iDAECC,EAAA,MAAAV,EAAA,MAXJ,WAAAE,EAAA,cAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,cAAAE,GAY8C,MAAA,wCACzCM,EAAA,MAAAT,EAAA,MAEE,MAAA,8BACA,KAAA,WAhBP,WAAAC,EAAA,mBAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,mBAAAE,gCAoBO,MAAA,oFACA,KAAA,WArBP,WAAAF,EAAA,YAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,YAAAE,iFA8BiB,MAAA,OAAc,QAAAE,EAAA,MAAA,eAAA,6BAElB,QAAAD,EAAA,IAAA,kCAGT,MAAA,SACA,QAAA,QACA,MAAA,cACC,QAAAC,EAAA,iDAID,MAAA,SACA,QAAA,QACC,QAAAA,EAAA,MAAA,eAAA,wBACuBJ,EAAA,cAAA,MAAAI,EAAA,oBAAA,GAAA,QAGvB,QAAAA,EAAA"}