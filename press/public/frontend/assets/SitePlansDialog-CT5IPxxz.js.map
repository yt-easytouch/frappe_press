{"version":3,"file":"SitePlansDialog-CT5IPxxz.js","sources":["../../../../dashboard/src/views/site/SitePlansDialog.vue"],"sourcesContent":["<template>\n\t<Dialog\n\t\t:options=\"{\n\t\t\ttitle: 'Change Plan',\n\t\t\tsize: '3xl',\n\t\t\tactions: [\n\t\t\t\t{\n\t\t\t\t\tlabel: 'Submit',\n\t\t\t\t\tvariant: 'solid',\n\t\t\t\t\tloading: $resources.changePlan.loading,\n\t\t\t\t\tonClick: () => $resources.changePlan.submit()\n\t\t\t\t}\n\t\t\t]\n\t\t}\"\n\t>\n\t\t<template v-slot:body-content>\n\t\t\t<Alert v-if=\"validationMessage\" class=\"mt-4\" type=\"warning\" icon=\"info\">\n\t\t\t\t{{ validationMessage }}\n\t\t\t</Alert>\n\t\t\t<SitePlansTable\n\t\t\t\tv-if=\"plans\"\n\t\t\t\tclass=\"mt-6\"\n\t\t\t\t:plans=\"plans\"\n\t\t\t\tv-model:selectedPlan=\"selectedPlan\"\n\t\t\t/>\n\t\t\t<ErrorMessage class=\"mt-4\" :message=\"$resources.changePlan.error\" />\n\t\t</template>\n\t</Dialog>\n</template>\n\n<script>\nimport SitePlansTable from '@/components/SitePlansTable.vue';\nimport { notify } from '@/utils/toast';\n\nexport default {\n\tname: 'SitePlansDialog',\n\tprops: ['site', 'plan'],\n\tcomponents: {\n\t\tSitePlansTable\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tselectedPlan: null,\n\t\t\tvalidationMessage: null\n\t\t};\n\t},\n\twatch: {\n\t\tasync selectedPlan(value) {\n\t\t\tif (!value) return;\n\n\t\t\ttry {\n\t\t\t\t// custom plan validation for frappe support\n\t\t\t\tlet result = await this.$call('validate_plan_change', {\n\t\t\t\t\tcurrent_plan: this.plan.current_plan,\n\t\t\t\t\tnew_plan: value,\n\t\t\t\t\tcurrency: this.$account.team.currency\n\t\t\t\t});\n\t\t\t\tthis.validationMessage = result;\n\t\t\t} catch (e) {\n\t\t\t\tthis.validationMessage = null;\n\t\t\t}\n\t\t}\n\t},\n\tresources: {\n\t\tplans() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.get_plans',\n\t\t\t\tparams: {\n\t\t\t\t\tname: this.site?.name\n\t\t\t\t},\n\t\t\t\tinitialData: [],\n\t\t\t\tauto: true\n\t\t\t};\n\t\t},\n\t\tchangePlan() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.site.change_plan',\n\t\t\t\tparams: {\n\t\t\t\t\tname: this.site?.name,\n\t\t\t\t\tplan: this.selectedPlan?.name\n\t\t\t\t},\n\t\t\t\tonSuccess() {\n\t\t\t\t\tnotify({\n\t\t\t\t\t\ttitle: `Plan changed to ${this.selectedPlan.plan_title}`,\n\t\t\t\t\t\ticon: 'check',\n\t\t\t\t\t\tcolor: 'green'\n\t\t\t\t\t});\n\t\t\t\t\tthis.showChangePlanDialog = false;\n\t\t\t\t\tthis.plan.current_plan = this.selectedPlan;\n\t\t\t\t\tthis.selectedPlan = null;\n\t\t\t\t\tthis.$resources.plans.reload();\n\t\t\t\t\tthis.$emit('plan-change');\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t},\n\tmethods: {\n\t\tbelowCurrentUsage(plan) {\n\t\t\treturn (\n\t\t\t\tthis.plan.total_storage_usage > plan.max_storage_usage ||\n\t\t\t\tthis.plan.total_database_usage > plan.max_database_usage\n\t\t\t);\n\t\t}\n\t},\n\tcomputed: {\n\t\tshowChangePlanDialog: {\n\t\t\tget() {\n\t\t\t\treturn this.modelValue;\n\t\t\t},\n\t\t\tset(value) {\n\t\t\t\tthis.$emit('update:modelValue', value);\n\t\t\t}\n\t\t},\n\t\tplans() {\n\t\t\tlet processedPlans = this.$resources.plans.data.map(plan => {\n\t\t\t\tif (!plan.dedicated_server_plan && this.belowCurrentUsage(plan)) {\n\t\t\t\t\tplan.disabled = true;\n\t\t\t\t}\n\n\t\t\t\tif (this.site.status === 'Suspended') {\n\t\t\t\t\treturn plan;\n\t\t\t\t}\n\n\t\t\t\t// If this `plan` is currently in use\n\t\t\t\tif (this.plan.current_plan.name === plan.name) {\n\t\t\t\t\tplan.disabled = true;\n\t\t\t\t}\n\n\t\t\t\treturn plan;\n\t\t\t});\n\n\t\t\tif (this.site.status === 'Suspended') {\n\t\t\t\tprocessedPlans = processedPlans.filter(p => !p.disabled);\n\t\t\t}\n\n\t\t\treturn processedPlans;\n\t\t}\n\t}\n};\n</script>\n"],"names":["_sfc_main","value","e","_a","notify","plan","processedPlans","_withCtx","_createTextVNode","_toDisplayString","$data","_createCommentVNode","$options","_cache","$event","_ctx"],"mappings":"qkCAkCA,MAAAA,EAAA,wBAEC,MAAA,CAAA,OAAA,MAAA,gCAIA,MAAA,CACC,MAAA,CACC,aAAA,KACA,kBAAA,OAGF,MAAA,gDAEE,GAAAC,EAEA,GAAA,gDAGE,aAAA,KAAA,KAAA,aACA,SAAAA,EACA,SAAA,KAAA,SAAA,KAAA,QACD,CAAA,0BAED,OAAAC,EAAA,4BAEA,CACD,gBAGA,OAAA,OACC,MAAA,CACC,IAAA,2BACA,OAAA,CACC,MAAAC,EAAA,KAAA,OAAA,YAAAA,EAAA,MAED,YAAA,CAAA,EACA,KAAA,0BAID,MAAA,CACC,IAAA,6BACA,OAAA,CACC,MAAAA,EAAA,KAAA,OAAA,YAAAA,EAAA,iEAIAC,EAAA,mFAIA,CAAA,EACA,KAAA,qBAAA,GACA,KAAA,KAAA,aAAA,KAAA,oCAEA,KAAA,WAAA,MAAA,OAAA,2BAED,EAEF,GAED,QAAA,sBAEE,6GAID,GAED,SAAA,CACC,qBAAA,OAEE,OAAA,KAAA,mBAGA,KAAA,MAAA,oBAAAH,CAAA,CACD,GAED,OAAA,gGAGGI,EAAA,SAAA,IAGD,KAAA,KAAA,SAAA,aAKA,KAAA,KAAA,aAAA,OAAAA,EAAA,OACCA,EAAA,SAAA,MAIF,EAEA,OAAA,KAAA,KAAA,SAAA,0CAIAC,CACD,CACD,CACD,2OA3HmB,eAAAC,EAAA,IAAA,qCACgB,MAAA,OAAa,KAAA,UAAe,KAAA,SAhB/D,QAAAA,EAAA,IAAA,CAAAC,EAAAC,EAAAC,EAAA,iBAAA,EAAA,CAAA,WAAAC,EAAA,GAAA,EAAA,0BAqBI,MAAA,OACC,MAAAC,EAAA,MACO,aAAAF,EAAA,aAvBZ,wBAAAG,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAJ,EAAA,aAAAI,sCAAAH,EAAA,GAAA,EAAA,OAyBiB,MAAA,OAAc,QAAAI,EAAA,WAAA,WAAA"}