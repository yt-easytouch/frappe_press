var V=Object.defineProperty,A=Object.defineProperties;var I=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var C=(s,e,a)=>e in s?V(s,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[e]=a,P=(s,e)=>{for(var a in e||(e={}))O.call(e,a)&&C(s,a,e[a]);if(k)for(var a of k(e))F.call(e,a)&&C(s,a,e[a]);return s},S=(s,e)=>A(s,I(e));var b=(s,e,a)=>new Promise((_,r)=>{var n=c=>{try{d(a.next(c))}catch(h){r(h)}},u=c=>{try{d(a.throw(c))}catch(h){r(h)}},d=c=>c.done?_(c.value):Promise.resolve(c.value).then(n,u);d((a=a.apply(s,e)).next())});import{x as G,b as M,r as x,q as l,o,A as m,j as t,w as D,t as p,u as g,Y as v,a8 as R,F as E,v as N,n as j,h as U,a5 as q,ag as z,au as H,a9 as L,X as J,ad as f,ay as T}from"./main-Dpl-JOF2.js";import{_ as K}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-CH7TZuXP.js";import{_ as W}from"./Header-BNMc-OFG.js";import{P as X}from"./PlansCards-CiqqQthx.js";import"./badge-check-DXteVc7W.js";(function(){try{var s=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="df609298-dc99-4ac3-8780-6c8656968ec6",s._sentryDebugIdIdentifier="sentry-dbid-df609298-dc99-4ac3-8780-6c8656968ec6")}catch(a){}})();{var y=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};y._sentryModuleMetadata=y._sentryModuleMetadata||{},y._sentryModuleMetadata[new Error().stack]=Object.assign({},y._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const Y={name:"InstallApp",props:{app:{type:String,required:!0}},pageMeta(){return{title:`Install ${this.appDoc.title} - Easytouch Cloud`}},components:{FBreadcrumbs:K,PlansCards:X,Header:W},data(){return{plan:"",subdomain:"",cluster:null,selectedPlan:null,selectedGroup:null,agreedToRegionConsent:!1,sitePlan:null,trial:!1}},watch:{subdomain:{handler:M(function(s){let e=T(s);this.$resources.subdomainExists.error=e,e||this.$resources.subdomainExists.submit()},500)}},resources:{app(){return{url:"press.api.marketplace.get",params:{app:this.app},auto:!0}},installAppOptions(){return{url:"press.api.marketplace.get_install_app_options",auto:!0,params:{marketplace_app:this.app},initialData:{domain:"",plans:[],clusters:[],private_groups:[]},onSuccess(){return b(this,null,function*(){var e;this.cluster=yield this.getClosestCluster(),((e=this.$resources.installAppOptions.data)==null?void 0:e.plans.length)>0&&(this.selectedPlan=this.$resources.installAppOptions.data.plans[0])})}}},subdomainExists(){return{url:"press.api.site.exists",makeParams(){var s;return{domain:(s=this.$resources.installAppOptions.data)==null?void 0:s.domain,subdomain:this.subdomain}},validate(){let s=T(this.subdomain);if(s)throw new f(s)},transform(s){return!s}}},getTrialPlan(){return{url:"press.api.site.get_trial_plan",auto:!0}},newSite(){if(this.options)return{url:"press.api.marketplace.create_site_for_app",makeParams(){var s,e;return this.sitePlan=this.selectedGroup?this.options.private_site_plan:this.options.public_site_plan,this.$team.doc.onboarding.site_created||(this.sitePlan=this.trialPlan,this.trial=!0),{subdomain:this.subdomain,site_plan:this.sitePlan,apps:[{app:"frappe"},{app:this.app,plan:(s=this.selectedPlan)==null?void 0:s.name}],cluster:this.cluster,group:(e=this.selectedGroup)==null?void 0:e.value,trial:this.trial}},validate(){if(!this.$team.doc.payment_mode&&(this.$team.doc.onboarding.site_created||!this.appDoc.show_for_new_site))throw new f("Please add a valid payment mode");if(!this.selectedPlan&&this.plans.length>0)throw new f("Please select a plan");if(!this.subdomain)throw new f("Please enter a subdomain");if(!this.agreedToRegionConsent)throw new f("Please agree to the above consent to create site")},onSuccess:s=>{s.doctype==="Site"?this.$router.push({name:"Site Jobs",params:{name:s.name}}):s.doctype==="Site Group Deploy"&&this.$router.push({name:"CreateSiteForMarketplaceApp",params:{app:this.app},query:{siteGroupDeployName:s.name}})}}}},methods:{getClosestCluster(){return b(this,null,function*(){if(this.closestCluster)return this.closestCluster;let s=this.options.clusters.flatMap(e=>e.proxy_server||[]).map(e=>e.name);if(s.length>0){this.findingClosestServer=!0;let e=s.map(u=>this.getPingTime(u)),r=(yield Promise.allSettled(e)).reduce((u,d)=>u.value.pingTime<d.value.pingTime?u:d).value.server,n=this.options.clusters.find(u=>{var d;return((d=u.proxy_server)==null?void 0:d.name)===r});this.closestCluster||(this.closestCluster=n.name),this.findingClosestServer=!1}else s.length===1&&(this.closestCluster=this.options.clusters[0].name);return this.closestCluster})},getPingTime(s){return b(this,null,function*(){let e=999999;try{let a=new Date().getTime(),_=yield fetch(`https://${s}`);e=new Date().getTime()-a}catch(a){console.warn(a)}return{server:s,pingTime:e}})}},computed:{appDoc(){return this.$resources.app.data||{}},options(){return this.$resources.installAppOptions.data},plans(){var s;return(s=this.$resources)!=null&&s.installAppOptions?this.options.plans.map(e=>S(P({},e),{label:e.price_inr===0||e.price_usd===0?"Free":`${this.$format.userCurrency(this.$team.doc.currency==="INR"?e.price_inr:e.price_usd)}/mo`,sublabel:" ",features:e.features.map(a=>({value:a,icon:"check-circle"}))})):[]},regions(){return this.selectedGroup?this.options.private_groups.find(s=>s.name===this.selectedGroup.value).clusters:this.options.clusters},trialPlan(){return this.$resources.getTrialPlan.data}}},Q={class:"top-0 z-10 shrink-0"},Z={class:"m-12 mx-auto max-w-2xl px-5"},ee={key:0,class:"py-4 text-base text-gray-600"},se={key:1,class:"space-y-6"},te={class:"mb-12 flex"},ae=["src","alt"],re={class:"my-1 ml-4 flex flex-col justify-between"},ie={class:"text-lg font-semibold"},ne={class:"text-sm text-gray-600"},oe={class:"space-y-12"},le={key:0},de={key:0},ue={class:"mt-2"},pe={key:1},ce={class:"mt-2 w-full space-y-2"},me={class:"mt-2 w-full space-y-2"},he={class:"grid grid-cols-2 gap-3"},ge=["onClick"],fe={class:"flex w-full items-center justify-between"},_e={class:"flex w-full items-center space-x-2"},be=["src"],ye={class:"text-sm font-medium"},ve={class:"mt-2 items-center"},xe={class:"col-span-2 flex w-full"},we={class:"flex items-center rounded-r bg-gray-100 px-4 text-base"},ke={class:"mt-1"},Ce={key:0,class:"text-sm text-gray-600"},Pe={key:0,class:"text-sm text-green-600"},Se={key:1,class:"text-sm text-red-600"},De={class:"flex flex-col space-y-4"},Ee={class:"flex space-x-1"},Te={class:"text-sm text-gray-600"};function $e(s,e,a,_,r,n){const u=x("FBreadcrumbs"),d=x("Header"),c=x("PlansCards"),h=R,$=q,w=L,B=J;return o(),l("div",Q,[m(d,null,{default:D(()=>[m(u,{items:[{label:"Create Site"}]})]),_:1}),t("div",Z,[s.$resources.installAppOptions.loading?(o(),l("div",ee," Loading... ")):(o(),l("div",se,[t("div",te,[t("img",{src:n.appDoc.image,class:"h-12 w-12 rounded-lg border",alt:n.appDoc.name},null,8,ae),t("div",re,[t("h1",ie,p(n.appDoc.title),1),t("p",ne,p(n.appDoc.description),1)])]),t("div",oe,[s.$team.doc.onboarding.site_created?(o(),l("div",le,[n.plans.length?(o(),l("div",de,[e[5]||(e[5]=t("div",{class:"flex items-center justify-between"},[t("h2",{class:"text-base font-medium leading-6 text-gray-900"}," Select Plan ")],-1)),t("div",ue,[m(c,{modelValue:r.selectedPlan,"onUpdate:modelValue":e[0]||(e[0]=i=>r.selectedPlan=i),plans:n.plans},null,8,["modelValue","plans"])])])):g("",!0),n.options.private_groups.length?(o(),l("div",pe,[e[6]||(e[6]=t("h2",{class:"text-base font-medium leading-6 text-gray-900"},[v(" Select Bench Group "),t("span",{class:"text-sm text-gray-500"}," (Optional) ")],-1)),t("div",ce,[m(h,{type:"autocomplete",options:n.options.private_groups.map(i=>({label:i.title,value:i.name})),modelValue:r.selectedGroup,"onUpdate:modelValue":e[1]||(e[1]=i=>r.selectedGroup=i)},null,8,["options","modelValue"])])])):g("",!0)])):g("",!0),t("div",null,[e[7]||(e[7]=t("h2",{class:"text-base font-medium leading-6 text-gray-900"}," Select Region ",-1)),t("div",me,[t("div",he,[(o(!0),l(E,null,N(n.regions,i=>(o(),l("button",{key:i.name,onClick:Be=>r.cluster=i.name,class:j([r.cluster===i.name?"border-gray-900 ring-1 ring-gray-900 hover:bg-gray-100":"bg-white text-gray-900  hover:bg-gray-50","flex w-full items-center rounded border p-3 text-left text-base text-gray-900"])},[t("div",fe,[t("div",_e,[t("img",{src:i.image,class:"h-5 w-5"},null,8,be),t("span",ye,p(i.title),1)]),i.beta?(o(),U($,{key:0,label:i.beta?"Beta":""},null,8,["label"])):g("",!0)])],10,ge))),128))])])]),t("div",null,[e[8]||(e[8]=t("h2",{class:"text-base font-medium leading-6 text-gray-900"}," Enter Subdomain ",-1)),t("div",ve,[t("div",xe,[z(t("input",{class:"dark:[color-scheme:dark] z-10 h-7 w-full flex-1 rounded rounded-r-none border border-[--surface-gray-2] bg-surface-gray-2 py-1.5 pl-2 pr-2 text-base text-ink-gray-8 placeholder-ink-gray-4 transition-colors hover:border-outline-gray-modals hover:bg-surface-gray-3 focus:border-outline-gray-4 focus:bg-surface-white focus:shadow-sm focus:ring-0 focus-visible:ring-2 focus-visible:ring-outline-gray-3",placeholder:"Subdomain","onUpdate:modelValue":e[2]||(e[2]=i=>r.subdomain=i)},null,512),[[H,r.subdomain]]),t("div",we," ."+p(n.options.domain),1)])]),t("div",ke,[m(w,{message:s.$resources.subdomainExists.error},null,8,["message"]),s.$resources.subdomainExists.loading?(o(),l("div",Ce," Checking... ")):!s.$resources.subdomainExists.error&&s.$resources.subdomainExists.data!=null?(o(),l(E,{key:1},[s.$resources.subdomainExists.data?(o(),l("div",Pe,p(r.subdomain)+"."+p(n.options.domain)+" is available ",1)):(o(),l("div",Se,p(r.subdomain)+"."+p(n.options.domain)+" is not available ",1))],64)):g("",!0)])]),t("div",De,[m(h,{class:"checkbox",type:"checkbox",modelValue:r.agreedToRegionConsent,"onUpdate:modelValue":e[3]||(e[3]=i=>r.agreedToRegionConsent=i),label:`I agree that the laws of the region selected by me ${this.cluster?`(${this.cluster})`:""} shall stand applicable to me and Easytouch.`},null,8,["modelValue","label"]),m(w,{class:"my-2",message:s.$resources.newSite.error},null,8,["message"]),m(B,{class:"w-full",variant:"solid",disabled:!r.agreedToRegionConsent||!s.$resources.subdomainExists.data,onClick:e[4]||(e[4]=i=>s.$resources.newSite.submit()),loading:s.$resources.newSite.loading},{default:D(()=>[v(" Create site and install "+p(n.appDoc.title),1)]),_:1},8,["disabled","loading"])])]),t("div",Ee,[t("div",Te,[e[9]||(e[9]=v(" Want to install ")),t("b",null,p(n.appDoc.title),1),e[10]||(e[10]=v(" on an existing Site or Bench Group? "))]),e[11]||(e[11]=t("a",{class:"text-sm underline",href:"https://easytouch.cloud/docs/installing-an-app",target:"_blank"}," Read documentation ",-1))])]))])])}const Me=G(Y,[["render",$e]]);export{Me as default};
//# sourceMappingURL=InstallApp-ujLWxixo.js.map
