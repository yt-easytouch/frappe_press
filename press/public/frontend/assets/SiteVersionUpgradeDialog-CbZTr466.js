import{x as T,r as C,h as p,o as i,a6 as D,w as y,u as l,A as m,X as x,j as g,q as h,Y as v,t as b,a8 as R,a9 as U,aA as B,V as k,av as I}from"./main-Dpl-JOF2.js";import{_ as H}from"./info-BXlf1Uhm.js";import{D as P}from"./DateTimeControl-DSJ0TMcX.js";(function(){try{var r=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},s=new Error().stack;s&&(r._sentryDebugIds=r._sentryDebugIds||{},r._sentryDebugIds[s]="976c4e16-d9ab-498e-81ea-464e6c821a3f",r._sentryDebugIdIdentifier="sentry-dbid-976c4e16-d9ab-498e-81ea-464e6c821a3f")}catch(a){}})();{var c=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};c._sentryModuleMetadata=c._sentryModuleMetadata||{},c._sentryModuleMetadata[new Error().stack]=Object.assign({},c._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const N={name:"SiteVersionUpgradeDialog",props:["site"],components:{DateTimeControl:P},data(){return{show:!0,targetDateTime:null,privateReleaseGroup:{value:"",label:""},skipBackups:!1,skipFailingPatches:!1,benchHasCommonServer:!1}},watch:{privateReleaseGroup:{handler(r){r!=null&&r.value&&this.$resources.validateGroupforUpgrade.submit({name:this.site,group_name:r.value})}}},computed:{nextVersion(){var s,a,o;const r=Number((s=this.$site.doc)==null?void 0:s.version.split(" ")[1]);return isNaN(r)||((a=this.$site.doc)==null?void 0:a.version)===((o=this.$site.doc)==null?void 0:o.latest_frappe_version)?null:`Version ${r+1}`},privateReleaseGroups(){return this.$resources.getPrivateGroups.data},message(){var r,s,a,o,t,e,u;return((r=this.$site.doc)==null?void 0:r.version)===((s=this.$site.doc)==null?void 0:s.latest_frappe_version)?"This site is already on the latest version.":((a=this.$site.doc)==null?void 0:a.version)==="Nightly"?"This site is on a nightly version and doesn't need to be upgraded.":!((o=this.$site.doc)!=null&&o.group_public)&&this.privateReleaseGroups.length===0?`Your team doesn't own any private bench groups available to upgrade this site to ${this.nextVersion}.`:(t=this.privateReleaseGroup)!=null&&t.value?!((e=this.$site.doc)!=null&&e.group_public)&&!this.benchHasCommonServer?"The selected bench group and your site doesn't have a common server. Please add site's server to the bench.":!((u=this.$site.doc)!=null&&u.group_public)&&this.benchHasCommonServer?`The selected bench group and your site have a common server. You can proceed with the upgrade to ${this.nextVersion}.`:"":""},datetimeInIST(){return this.targetDateTime?this.$dayjs(this.targetDateTime).format("YYYY-MM-DDTHH:mm"):null},errorMessage(){return this.$resources.versionUpgrade.error||this.$resources.validateGroupforUpgrade.error||this.$resources.addServerToReleaseGroup.error||this.$resources.getPrivateGroups.error},$site(){return I("Site",this.site)}},resources:{versionUpgrade(){return{url:"press.api.site.version_upgrade",params:{name:this.site,destination_group:this.privateReleaseGroup.value,skip_failing_patches:this.skipFailingPatches,skip_backups:this.skipBackups,scheduled_datetime:this.datetimeInIST},onSuccess(){k.success("Site's version upgrade has been scheduled."),this.show=!1}}},getPrivateGroups(){var r,s,a,o;return{url:"press.api.site.get_private_groups_for_upgrade",params:{name:this.site,version:(r=this.$site.doc)==null?void 0:r.version},auto:((s=this.$site.doc)==null?void 0:s.version)&&!((a=this.$site.doc)!=null&&a.group_public)&&((o=this.$site.doc)==null?void 0:o.version)!=="Nightly",transform(t){return t.map(e=>({label:e.title||e.name,description:e.name,value:e.name}))},initialData:[]}},addServerToReleaseGroup(){return{url:"press.api.site.add_server_to_release_group",params:{name:this.site,group_name:this.privateReleaseGroup.value},onSuccess(r){k.success("Server Added to the Bench Group",{description:`Added a server to ${this.privateReleaseGroup.value} bench. Please wait for the deploy to be completed.`}),this.$router.push({name:"Release Group Job",params:{name:this.privateReleaseGroup.value,id:r}}),this.resetValues(),this.show=!1}}},validateGroupforUpgrade(){return{url:"press.api.site.validate_group_for_upgrade",onSuccess(r){this.benchHasCommonServer=r}}}},methods:{resetValues(){this.targetDateTime=null,this.privateReleaseGroup={label:"",value:""},this.benchHasCommonServer=!1,this.$resources.getPrivateGroups.reset()}}},$={class:"space-y-4"},M={key:0,class:"text-base"},Y={key:5,class:"flex items-center rounded bg-gray-50 p-4 text-sm text-gray-700"},A={key:6,class:"text-sm text-gray-700"};function E(r,s,a,o,t,e){var _;const u=R,V=C("DateTimeControl"),S=H,w=U,f=x,G=B;return i(),p(G,{modelValue:t.show,"onUpdate:modelValue":s[6]||(s[6]=d=>t.show=d),onClose:e.resetValues,options:{title:"Upgrade Site Version"}},D({"body-content":y(()=>{var d;return[g("div",$,[(d=e.$site.doc)!=null&&d.group_public&&e.nextVersion?(i(),h("p",M,[s[7]||(s[7]=v(" The site ")),g("b",null,b(e.$site.doc.host_name),1),s[8]||(s[8]=v(" will be upgraded to ")),g("b",null,b(e.nextVersion),1)])):e.privateReleaseGroups.length>0&&e.nextVersion?(i(),p(u,{key:1,variant:"outline",label:`Please select a ${e.nextVersion} bench group to upgrade your site from ${e.$site.doc.version}`,class:"w-full",type:"autocomplete",options:e.privateReleaseGroups,modelValue:t.privateReleaseGroup,"onUpdate:modelValue":s[0]||(s[0]=n=>t.privateReleaseGroup=n)},null,8,["label","options","modelValue"])):l("",!0),e.$site.doc.group_public&&e.nextVersion||t.benchHasCommonServer?(i(),p(V,{key:2,modelValue:t.targetDateTime,"onUpdate:modelValue":s[1]||(s[1]=n=>t.targetDateTime=n),label:"Schedule Time"},null,8,["modelValue"])):l("",!0),e.$site.doc.group_public&&e.nextVersion||t.benchHasCommonServer?(i(),p(u,{key:3,label:"Skip failing patches if any",type:"checkbox",modelValue:t.skipFailingPatches,"onUpdate:modelValue":s[2]||(s[2]=n=>t.skipFailingPatches=n)},null,8,["modelValue"])):l("",!0),e.$site.doc.group_public&&e.nextVersion||t.benchHasCommonServer?(i(),p(u,{key:4,label:"Skip backups",type:"checkbox",modelValue:t.skipBackups,"onUpdate:modelValue":s[3]||(s[3]=n=>t.skipBackups=n),class:"ml-4"},null,8,["modelValue"])):l("",!0),t.skipBackups?(i(),h("div",Y,[m(S,{class:"mr-2 h-4 w-8"}),s[9]||(s[9]=v(" Backups will not be taken during the upgrade process and incase of any failure rollback will not be possible. "))])):l("",!0),e.message&&!e.errorMessage?(i(),h("p",A,b(e.message),1)):l("",!0),m(w,{message:e.errorMessage},null,8,["message"])])]}),_:2},[(_=e.$site.doc)!=null&&_.group_public||e.privateReleaseGroups.length?{name:"actions",fn:y(()=>[e.$site.doc.group_public?l("",!0):(i(),p(f,{key:0,class:"mb-2 w-full",disabled:t.benchHasCommonServer||!t.privateReleaseGroup.value||!e.nextVersion,label:"Add Server to Bench Group",onClick:s[4]||(s[4]=d=>r.$resources.addServerToReleaseGroup.submit()),loading:r.$resources.addServerToReleaseGroup.loading||r.$resources.validateGroupforUpgrade.loading},null,8,["disabled","loading"])),m(f,{class:"w-full",variant:"solid",label:"Upgrade",disabled:(!t.benchHasCommonServer||!t.privateReleaseGroup.value)&&!e.$site.doc.group_public||!e.nextVersion,loading:r.$resources.versionUpgrade.loading||r.$resources.validateGroupforUpgrade.loading,onClick:s[5]||(s[5]=d=>r.$resources.versionUpgrade.submit())},null,8,["disabled","loading"])]),key:"0"}:void 0]),1032,["modelValue","onClose"])}const J=T(N,[["render",E]]);export{J as default};
//# sourceMappingURL=SiteVersionUpgradeDialog-CbZTr466.js.map
