import b from"./CardWithDetails-8Q6clK2F.js";import{x as S,r as h,q as m,o as i,A as u,w as o,j as f,u as _,F as w,v as k,h as g,n as N,a5 as v,X as B,Y as L,a2 as I}from"./main-Dpl-JOF2.js";import{_ as x}from"./ListItem-CkkFcC1t.js";import{S as E}from"./StepsDetail-844EGZPD.js";import"./Card-BCzTSeNK.js";import"./CardDetails-BY8v0wfH.js";(function(){try{var e=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},s=new Error().stack;s&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[s]="0afec546-a696-4c76-bd0e-85f31383ff4a",e._sentryDebugIdIdentifier="sentry-dbid-0afec546-a696-4c76-bd0e-85f31383ff4a")}catch(n){}})();{var l=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};l._sentryModuleMetadata=l._sentryModuleMetadata||{},l._sentryModuleMetadata[new Error().stack]=Object.assign({},l._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const F={name:"BenchDeploys",props:["bench","benchName","candidateName"],components:{CardWithDetails:b,StepsDetail:E},resources:{candidates(){return{type:"list",doctype:"Deploy Candidate",url:"press.api.bench.candidates",filters:{group:this.benchName},start:0,auto:!0,pageLength:10}},selectedCandidate(){return{url:"press.api.bench.candidate",params:{name:this.candidateName},auto:!0}}},mounted(){var e;this.candidateName&&((e=this.selectedCandidate)==null?void 0:e.status)!="Success"&&(this.$socket.on(`bench_deploy:${this.candidateName}:steps`,this.onSteps),this.$socket.on(`bench_deploy:${this.candidateName}:finished`,this.onStopped))},unmounted(){this.$socket.off(`bench_deploy:${this.candidateName}:steps`,this.onSteps),this.$socket.off(`bench_deploy:${this.candidateName}:finished`,this.onStopped)},methods:{onSteps(e){var s;((s=this.$resources.selectedCandidate)==null?void 0:s.data.name)===e.name&&(this.$resources.selectedCandidate.data.build_steps=e.steps)},onStopped(){this.$resources.candidates.reload(),this.$resources.selectedCandidate.reload()},getSteps(e){if(!e)return[];let s=e.build_steps.map(t=>{let a=t.stage+" - "+t.step,c=t.command||t.output?`${t.command||""}
${t.output||""}`.trim():"",p=["Success","Failure"].includes(t.status)?t.cached?"Cached":`${t.duration} s`:null;return{name:a,output:c,status:t.status,duration:p,completed:t.status=="Success",running:t.status=="Running"}}),n=this.bench,r=e.jobs.map(t=>({name:`Deploy ${t.bench}`,output:t.status=="Success"?`Deploy completed in ${t.duration.split(".")[0]}`:null,status:t.status,completed:t.status=="Success",running:["Pending","Running"].includes(t.status),action:{render(){return I("Link",{props:{to:`/groups/${n==null?void 0:n.name}/jobs/${t.name}`},class:"text-sm"},"Job Log â†’")}}}));return[...s,...r]},itemSubtitle(e){return["frappe",...e.apps.filter(s=>s!=="frappe")].join(", ")}},computed:{selectedCandidate(){return this.$resources.selectedCandidate.data},subtitle(){var e,s;if(this.selectedCandidate&&this.selectedCandidate.status=="Success"){let n=this.formatDate(this.selectedCandidate.build_end,"relative"),r=this.$formatDuration(this.selectedCandidate.build_duration);return`Completed ${n} in ${r}`}else{if(((e=this.selectedCandidate)==null?void 0:e.status)==="Running")return`Started ${this.formatDate(this.selectedCandidate.build_start,"relative")}`;if(((s=this.selectedCandidate)==null?void 0:s.status)==="Failure")return`Failed ${this.formatDate(this.selectedCandidate.build_end,"relative")}`}},candidates(){return this.$resources.candidates.data||[]}}},T={key:0,class:"py-3"};function R(e,s,n,r,t,a){const c=v,p=x,y=h("router-link"),C=B,$=h("StepsDetail"),D=b;return i(),m("div",null,[u(D,{title:"Deploys",subtitle:a.candidates.length?"Deploys on your bench":"No deploys on your bench","show-details":a.selectedCandidate},{details:o(()=>[u($,{showDetails:a.selectedCandidate,loading:e.$resources.selectedCandidate.loading,steps:a.getSteps(a.selectedCandidate),title:"Build Log",subtitle:a.subtitle},null,8,["showDetails","loading","steps","subtitle"])]),default:o(()=>[f("div",null,[(i(!0),m(w,null,k(a.candidates,d=>(i(),g(y,{class:N(["block cursor-pointer rounded-md px-2.5",a.selectedCandidate&&a.selectedCandidate.name===d.name?"bg-gray-100":"hover:bg-gray-50"]),key:d.name,to:`/groups/${n.benchName}/deploys/${d.name}`},{default:o(()=>[u(p,{title:`Deploy on ${e.formatDate(d.creation,"DATETIME_SHORT")}`,subtitle:a.itemSubtitle(d)},{actions:o(()=>[d.status!="Success"?(i(),g(c,{key:0,label:d.status},null,8,["label"])):_("",!0)]),_:2},1032,["title","subtitle"]),s[1]||(s[1]=f("div",{class:"border-b"},null,-1))]),_:2},1032,["class","to"]))),128)),e.$resources.candidates.hasNextPage?(i(),m("div",T,[u(C,{loading:e.$resources.candidates.list.loading,loadingText:"Loading...",onClick:s[0]||(s[0]=d=>e.$resources.candidates.next())},{default:o(()=>s[2]||(s[2]=[L(" Load more ")])),_:1},8,["loading"])])):_("",!0)])]),_:1},8,["subtitle","show-details"])])}const q=S(F,[["render",R]]);export{q as default};
//# sourceMappingURL=BenchDeploys-CAey-tFi.js.map
