{"version":3,"file":"BenchDeploys-CAey-tFi.js","sources":["../../../../dashboard/src/views/bench/BenchDeploys.vue"],"sourcesContent":["<template>\n\t<div>\n\t\t<CardWithDetails\n\t\t\ttitle=\"Deploys\"\n\t\t\t:subtitle=\"\n\t\t\t\tcandidates.length ? 'Deploys on your bench' : 'No deploys on your bench'\n\t\t\t\"\n\t\t\t:show-details=\"selectedCandidate\"\n\t\t>\n\t\t\t<div>\n\t\t\t\t<router-link\n\t\t\t\t\tv-for=\"candidate in candidates\"\n\t\t\t\t\tclass=\"block cursor-pointer rounded-md px-2.5\"\n\t\t\t\t\t:class=\"\n\t\t\t\t\t\tselectedCandidate && selectedCandidate.name === candidate.name\n\t\t\t\t\t\t\t? 'bg-gray-100'\n\t\t\t\t\t\t\t: 'hover:bg-gray-50'\n\t\t\t\t\t\"\n\t\t\t\t\t:key=\"candidate.name\"\n\t\t\t\t\t:to=\"`/groups/${benchName}/deploys/${candidate.name}`\"\n\t\t\t\t>\n\t\t\t\t\t<ListItem\n\t\t\t\t\t\t:title=\"`Deploy on ${formatDate(\n\t\t\t\t\t\t\tcandidate.creation,\n\t\t\t\t\t\t\t'DATETIME_SHORT'\n\t\t\t\t\t\t)}`\"\n\t\t\t\t\t\t:subtitle=\"itemSubtitle(candidate)\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<template #actions>\n\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\tv-if=\"candidate.status != 'Success'\"\n\t\t\t\t\t\t\t\t:label=\"candidate.status\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</Badge>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</ListItem>\n\t\t\t\t\t<div class=\"border-b\"></div>\n\t\t\t\t</router-link>\n\t\t\t\t<div class=\"py-3\" v-if=\"$resources.candidates.hasNextPage\">\n\t\t\t\t\t<Button\n\t\t\t\t\t\t:loading=\"$resources.candidates.list.loading\"\n\t\t\t\t\t\tloadingText=\"Loading...\"\n\t\t\t\t\t\t@click=\"$resources.candidates.next()\"\n\t\t\t\t\t>\n\t\t\t\t\t\tLoad more\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<template #details>\n\t\t\t\t<StepsDetail\n\t\t\t\t\t:showDetails=\"selectedCandidate\"\n\t\t\t\t\t:loading=\"$resources.selectedCandidate.loading\"\n\t\t\t\t\t:steps=\"getSteps(selectedCandidate)\"\n\t\t\t\t\ttitle=\"Build Log\"\n\t\t\t\t\t:subtitle=\"subtitle\"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t</CardWithDetails>\n\t</div>\n</template>\n\n<script>\nimport { h } from 'vue';\nimport StepsDetail from '@/views/general/StepsDetail.vue';\nimport CardWithDetails from '@/components/CardWithDetails.vue';\n\nexport default {\n\tname: 'BenchDeploys',\n\tprops: ['bench', 'benchName', 'candidateName'],\n\tcomponents: {\n\t\tCardWithDetails,\n\t\tStepsDetail\n\t},\n\tresources: {\n\t\tcandidates() {\n\t\t\treturn {\n\t\t\t\ttype: 'list',\n\t\t\t\tdoctype: 'Deploy Candidate',\n\t\t\t\turl: 'press.api.bench.candidates',\n\t\t\t\tfilters: {\n\t\t\t\t\tgroup: this.benchName\n\t\t\t\t},\n\t\t\t\tstart: 0,\n\t\t\t\tauto: true,\n\t\t\t\tpageLength: 10\n\t\t\t};\n\t\t},\n\t\tselectedCandidate() {\n\t\t\treturn {\n\t\t\t\turl: 'press.api.bench.candidate',\n\t\t\t\tparams: {\n\t\t\t\t\tname: this.candidateName\n\t\t\t\t},\n\t\t\t\tauto: true\n\t\t\t};\n\t\t}\n\t},\n\tmounted() {\n\t\tif (this.candidateName && this.selectedCandidate?.status != 'Success') {\n\t\t\tthis.$socket.on(`bench_deploy:${this.candidateName}:steps`, this.onSteps);\n\t\t\tthis.$socket.on(\n\t\t\t\t`bench_deploy:${this.candidateName}:finished`,\n\t\t\t\tthis.onStopped\n\t\t\t);\n\t\t}\n\t},\n\tunmounted() {\n\t\tthis.$socket.off(`bench_deploy:${this.candidateName}:steps`, this.onSteps);\n\t\tthis.$socket.off(\n\t\t\t`bench_deploy:${this.candidateName}:finished`,\n\t\t\tthis.onStopped\n\t\t);\n\t},\n\tmethods: {\n\t\tonSteps(data) {\n\t\t\tif (this.$resources.selectedCandidate?.data.name === data.name) {\n\t\t\t\tthis.$resources.selectedCandidate.data.build_steps = data.steps;\n\t\t\t}\n\t\t},\n\t\tonStopped() {\n\t\t\tthis.$resources.candidates.reload();\n\t\t\tthis.$resources.selectedCandidate.reload();\n\t\t},\n\t\tgetSteps(candidate) {\n\t\t\tif (!candidate) return [];\n\t\t\tlet steps = candidate.build_steps.map(step => {\n\t\t\t\tlet name = step.stage + ' - ' + step.step;\n\t\t\t\tlet output =\n\t\t\t\t\tstep.command || step.output\n\t\t\t\t\t\t? `${step.command || ''}\\n${step.output || ''}`.trim()\n\t\t\t\t\t\t: '';\n\t\t\t\tlet duration = ['Success', 'Failure'].includes(step.status)\n\t\t\t\t\t? step.cached\n\t\t\t\t\t\t? 'Cached'\n\t\t\t\t\t\t: `${step.duration} s`\n\t\t\t\t\t: null;\n\t\t\t\treturn {\n\t\t\t\t\tname,\n\t\t\t\t\toutput,\n\t\t\t\t\tstatus: step.status,\n\t\t\t\t\tduration,\n\t\t\t\t\tcompleted: step.status == 'Success',\n\t\t\t\t\trunning: step.status == 'Running'\n\t\t\t\t};\n\t\t\t});\n\n\t\t\tlet bench = this.bench;\n\t\t\tlet jobs = candidate.jobs.map(job => {\n\t\t\t\treturn {\n\t\t\t\t\tname: `Deploy ${job.bench}`,\n\t\t\t\t\toutput:\n\t\t\t\t\t\tjob.status == 'Success'\n\t\t\t\t\t\t\t? `Deploy completed in ${job.duration.split('.')[0]}`\n\t\t\t\t\t\t\t: null,\n\t\t\t\t\tstatus: job.status,\n\t\t\t\t\tcompleted: job.status == 'Success',\n\t\t\t\t\trunning: ['Pending', 'Running'].includes(job.status),\n\t\t\t\t\taction: {\n\t\t\t\t\t\trender() {\n\t\t\t\t\t\t\treturn h(\n\t\t\t\t\t\t\t\t'Link',\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tprops: { to: `/groups/${bench?.name}/jobs/${job.name}` },\n\t\t\t\t\t\t\t\t\tclass: 'text-sm'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t'Job Log â†’'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t});\n\t\t\treturn [...steps, ...jobs];\n\t\t},\n\t\titemSubtitle(candidate) {\n\t\t\treturn ['frappe', ...candidate.apps.filter(d => d !== 'frappe')].join(\n\t\t\t\t', '\n\t\t\t);\n\t\t}\n\t},\n\tcomputed: {\n\t\tselectedCandidate() {\n\t\t\treturn this.$resources.selectedCandidate.data;\n\t\t},\n\t\tsubtitle() {\n\t\t\tif (\n\t\t\t\tthis.selectedCandidate &&\n\t\t\t\tthis.selectedCandidate.status == 'Success'\n\t\t\t) {\n\t\t\t\tlet when = this.formatDate(\n\t\t\t\t\tthis.selectedCandidate.build_end,\n\t\t\t\t\t'relative'\n\t\t\t\t);\n\t\t\t\tlet duration = this.$formatDuration(\n\t\t\t\t\tthis.selectedCandidate.build_duration\n\t\t\t\t);\n\t\t\t\treturn `Completed ${when} in ${duration}`;\n\t\t\t} else if (this.selectedCandidate?.status === 'Running') {\n\t\t\t\tconst when = this.formatDate(\n\t\t\t\t\tthis.selectedCandidate.build_start,\n\t\t\t\t\t'relative'\n\t\t\t\t);\n\t\t\t\treturn `Started ${when}`;\n\t\t\t} else if (this.selectedCandidate?.status === 'Failure') {\n\t\t\t\tconst when = this.formatDate(\n\t\t\t\t\tthis.selectedCandidate.build_end,\n\t\t\t\t\t'relative'\n\t\t\t\t);\n\t\t\t\treturn `Failed ${when}`;\n\t\t\t}\n\t\t},\n\t\tcandidates() {\n\t\t\treturn this.$resources.candidates.data || [];\n\t\t}\n\t}\n};\n</script>\n"],"names":["_sfc_main","CardWithDetails","_a","candidate","steps","step","name","output","duration","bench","jobs","job","h","d","when","$options","_withCtx","_ctx","_openBlock","_createElementBlock","_Fragment","_renderList","$props","_createCommentVNode","_hoisted_1","_cache","$event","_createTextVNode"],"mappings":"o+BAkEA,MAAAA,EAAA,CACC,KAAA,eACA,MAAA,CAAA,QAAA,YAAA,eAAA,cAEC,gBAAAC,yCAKC,MAAA,wCAGC,IAAA,6BACA,QAAA,CACC,MAAA,KAAA,WAED,MAAA,EACA,KAAA,mBAIF,mBAAA,CACC,MAAA,CACC,IAAA,4BACA,OAAA,0BAGA,KAAA,GAEF,GAED,SAAA,OACC,KAAA,iBAAAC,EAAA,KAAA,oBAAA,YAAAA,EAAA,SAAA,YACC,KAAA,QAAA,GAAA,gBAAA,KAAA,aAAA,SAAA,KAAA,OAAA,EACA,KAAA,QAAA,GACC,gBAAA,KAAA,aAAA,0CAMF,KAAA,QAAA,IAAA,gBAAA,KAAA,aAAA,SAAA,KAAA,OAAA,EACA,KAAA,QAAA,IACC,gBAAA,KAAA,aAAA,6BAIF,QAAA,uKAOE,KAAA,WAAA,WAAA,OAAA,EACA,KAAA,WAAA,kBAAA,OAAA,GAED,SAAAC,EAAA,gBAEC,IAAAC,EAAAD,EAAA,YAAA,IAAAE,GAAA,CACC,IAAAC,EAAAD,EAAA,MAAA,MAAAA,EAAA,KACAE;wBAGE,uDAGA,SACA,GAAAF,EAAA,QAAA,UAEF,MAAA,QAEC,OAAAE,EACA,OAAAF,EAAA,OACA,SAAAG,EACA,UAAAH,EAAA,QAAA,sCAGF,CAAA,EAEAI,EAAA,KAAA,MACAC,EAAAP,EAAA,KAAA,IAAAQ,IACC,0BAEC,OACCA,EAAA,QAAA,iEAGD,OAAAA,EAAA,OACA,UAAAA,EAAA,QAAA,2DAEA,OAAA,CACC,QAAA,CACC,OAAAC,EACC,OACA,8DAEC,MAAA,WAED,YAEF,CACD,GAEF,qCAIA,MAAA,CAAA,SAAA,GAAAT,EAAA,KAAA,OAAAU,GAAAA,IAAA,QAAA,CAAA,EAAA,KACC,KAEF,GAED,SAAA,CACC,mBAAA,CACC,OAAA,KAAA,WAAA,kBAAA,yBAGA,2BAEC,KAAA,kBAAA,QAAA,iCAGC,KAAA,kBAAA,UACA,YAEDL,EAAA,KAAA,gBACC,KAAA,kBAAA,gBAED,MAAA,aAAAM,CAAA,OAAAN,CAAA,2GAGC,KAAA,kBAAA,YACA,gFAQD,MAAA,0BAHC,KAAA,kBAAA,UACA,WAED,kBAID,OAAA,KAAA,WAAA,WAAA,MAAA,CAAA,CACD,CACD,CACD,WAhLS,MAAA,0HAnCN,MAAA,mBACgBO,EAAA,WAAA,OAAA,wBAAA,2BAGf,eAAAA,EAAA,oBAyCU,QAAAC,EAAA,IAAA,MAER,YAAAD,EAAA,kBACA,QAAAE,EAAA,WAAA,kBAAA,8CAED,MAAA,YACC,SAAAF,EAAA,iEAtDN,QAAAC,EAAA,IAAA,gBAUIE,EAAA,EAAA,EAAAC,EAAAC,EAAA,KAAAC,EAAAN,EAAA,WAAAZ,+DAGgBY,EAAA,mBAAAA,EAAA,kBAAA,OAAAZ,EAAA,mDAMd,GAAA,WAAAmB,EAAA,SAAA,YAAAnB,EAAA,IAAA,KAnBN,QAAAa,EAAA,IAAA,MAsBO,MAAA,aAAAC,EAAA,WAAuCd,EAAA,0DAM7B,QAAAa,EAAA,IAAA,CAEHb,EAAA,QAAA,6DA9BdoB,EAAA,GAAA,EAAA,8JAsCIL,IAAAC,EAAA,MAAAK,EAAA,MAEG,QAAAP,EAAA,WAAA,WAAA,KAAA,QACD,YAAA,aACC,QAAAQ,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAT,EAAA,WAAA,WAAA,KAAA,KA1CP,QAAAD,EAAA,IAAAS,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAA,CAAAE,EAAA,aAAA,4BAAAJ,EAAA,GAAA,EAAA"}