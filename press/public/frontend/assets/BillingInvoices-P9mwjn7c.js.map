{"version":3,"file":"BillingInvoices-P9mwjn7c.js","sources":["../../../../dashboard/src2/pages/BillingInvoices.vue"],"sourcesContent":["<template>\n\t<div class=\"p-5\">\n\t\t<ObjectList :options=\"options\" />\n\t\t<Dialog\n\t\t\tv-model=\"invoiceDialog\"\n\t\t\t:options=\"{ size: '3xl', title: showInvoice?.name }\"\n\t\t>\n\t\t\t<template #body-content>\n\t\t\t\t<template v-if=\"showInvoice\">\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if=\"showInvoice.status === 'Empty'\"\n\t\t\t\t\t\tclass=\"text-base text-gray-600\"\n\t\t\t\t\t>\n\t\t\t\t\t\tNothing to show\n\t\t\t\t\t</div>\n\t\t\t\t\t<InvoiceTable v-else :invoiceId=\"showInvoice.name\" />\n\t\t\t\t</template>\n\t\t\t</template>\n\t\t</Dialog>\n\t\t<AddPrepaidCreditsDialog\n\t\t\tv-if=\"showBuyPrepaidCreditsDialog\"\n\t\t\tv-model=\"showBuyPrepaidCreditsDialog\"\n\t\t\t:minimumAmount=\"minimumAmount\"\n\t\t\t@success=\"\n\t\t\t\t() => {\n\t\t\t\t\tshowBuyPrepaidCreditsDialog = false;\n\t\t\t\t}\n\t\t\t\"\n\t\t/>\n\t</div>\n</template>\n<script>\nimport { h } from 'vue';\nimport { Button } from 'frappe-ui';\nimport ObjectList from '../components/ObjectList.vue';\nimport InvoiceTable from '../components/InvoiceTable.vue';\nimport { userCurrency, date } from '../utils/format';\nimport { confirmDialog, icon, renderInDialog } from '../utils/components';\nimport AddPrepaidCreditsDialog from '../components/billing/AddPrepaidCreditsDialog.vue';\nimport { dayjsLocal } from '../utils/dayjs';\nimport router from '../router';\n\nexport default {\n\tname: 'BillingInvoices',\n\tprops: ['tab'],\n\tcomponents: {\n\t\tObjectList,\n\t\tInvoiceTable,\n\t\tAddPrepaidCreditsDialog,\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tinvoiceDialog: false,\n\t\t\tshowInvoice: null,\n\t\t\tshowBuyPrepaidCreditsDialog: false,\n\t\t\tminimumAmount: 0,\n\t\t};\n\t},\n\tcomputed: {\n\t\toptions() {\n\t\t\treturn {\n\t\t\t\tdoctype: 'Invoice',\n\t\t\t\tfields: [\n\t\t\t\t\t'type',\n\t\t\t\t\t'invoice_pdf',\n\t\t\t\t\t'payment_mode',\n\t\t\t\t\t'stripe_invoice_url',\n\t\t\t\t\t'due_date',\n\t\t\t\t\t'period_start',\n\t\t\t\t\t'period_end',\n\t\t\t\t\t'mpesa_invoice',\n\t\t\t\t\t'mpesa_invoice_pdf',\n\t\t\t\t],\n\t\t\t\tfilterControls: () => {\n\t\t\t\t\treturn [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'select',\n\t\t\t\t\t\t\tlabel: 'Type',\n\t\t\t\t\t\t\tclass: !this.$isMobile ? 'w-36' : '',\n\t\t\t\t\t\t\tfieldname: 'type',\n\t\t\t\t\t\t\toptions: ['', 'Subscription', 'Prepaid Credits'],\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'select',\n\t\t\t\t\t\t\tlabel: 'Status',\n\t\t\t\t\t\t\tclass: !this.$isMobile ? 'w-36' : '',\n\t\t\t\t\t\t\tfieldname: 'status',\n\t\t\t\t\t\t\toptions: [\n\t\t\t\t\t\t\t\t'',\n\t\t\t\t\t\t\t\t'Draft',\n\t\t\t\t\t\t\t\t'Invoice Created',\n\t\t\t\t\t\t\t\t'Unpaid',\n\t\t\t\t\t\t\t\t'Paid',\n\t\t\t\t\t\t\t\t'Refunded',\n\t\t\t\t\t\t\t\t'Uncollectible',\n\t\t\t\t\t\t\t\t'Collected',\n\t\t\t\t\t\t\t\t'Empty',\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t},\n\t\t\t\t\t];\n\t\t\t\t},\n\t\t\t\tcolumns: [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'Invoice',\n\t\t\t\t\t\tfieldname: 'name',\n\t\t\t\t\t\tclass: 'font-medium',\n\t\t\t\t\t\tformat(value, row) {\n\t\t\t\t\t\t\tif (row.type == 'Subscription') {\n\t\t\t\t\t\t\t\tlet end = dayjsLocal(row.period_end);\n\t\t\t\t\t\t\t\treturn end.format('MMMM YYYY');\n\t\t\t\t\t\t\t} else if (row.type == 'Partnership Fees') {\n\t\t\t\t\t\t\t\treturn 'Partnership Fees';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn 'Prepaid Credits';\n\t\t\t\t\t\t},\n\t\t\t\t\t\twidth: 0.8,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'Status',\n\t\t\t\t\t\tfieldname: 'status',\n\t\t\t\t\t\ttype: 'Badge',\n\t\t\t\t\t\twidth: '150px',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'Date',\n\t\t\t\t\t\tfieldname: 'due_date',\n\t\t\t\t\t\tformat(value, row) {\n\t\t\t\t\t\t\tif (row.type == 'Subscription') {\n\t\t\t\t\t\t\t\tlet start = dayjsLocal(row.period_start);\n\t\t\t\t\t\t\t\tlet end = dayjsLocal(row.period_end);\n\t\t\t\t\t\t\t\tlet sameYear = start.year() === end.year();\n\t\t\t\t\t\t\t\tlet formattedStart = sameYear\n\t\t\t\t\t\t\t\t\t? start.format('MMM D')\n\t\t\t\t\t\t\t\t\t: start.format('ll');\n\t\t\t\t\t\t\t\treturn `${formattedStart} - ${end.format('ll')}`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn date(value, 'll');\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'Total',\n\t\t\t\t\t\tfieldname: 'total',\n\t\t\t\t\t\tformat: this.formatCurrency,\n\t\t\t\t\t\talign: 'right',\n\t\t\t\t\t\twidth: 0.6,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'Amount Paid',\n\t\t\t\t\t\tfieldname: 'amount_paid',\n\t\t\t\t\t\tformat: this.formatCurrency,\n\t\t\t\t\t\talign: 'right',\n\t\t\t\t\t\twidth: 0.6,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'Amount Due',\n\t\t\t\t\t\tfieldname: 'amount_due',\n\t\t\t\t\t\tformat: this.formatCurrency,\n\t\t\t\t\t\talign: 'right',\n\t\t\t\t\t\twidth: 0.6,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: '',\n\t\t\t\t\t\ttype: 'Button',\n\t\t\t\t\t\talign: 'right',\n\t\t\t\t\t\tButton: ({ row }) => {\n\t\t\t\t\t\t\tif (row.invoice_pdf || row.mpesa_invoice_pdf) {\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\tlabel: 'Download Invoice',\n\t\t\t\t\t\t\t\t\tslots: {\n\t\t\t\t\t\t\t\t\t\tprefix: icon('download'),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tonClick: () => {\n\t\t\t\t\t\t\t\t\t\tif (row.mpesa_invoice_pdf) {\n\t\t\t\t\t\t\t\t\t\t\twindow.open(row.mpesa_invoice_pdf);\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\twindow.open(row.invoice_pdf);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (row.status === 'Unpaid' && row.amount_due > 0) {\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\tlabel: 'Pay Now',\n\t\t\t\t\t\t\t\t\tslots: {\n\t\t\t\t\t\t\t\t\t\tprefix: icon('external-link'),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tonClick: (e) => {\n\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\tif (row.stripe_invoice_url && row.payment_mode == 'Card') {\n\t\t\t\t\t\t\t\t\t\t\twindow.open(\n\t\t\t\t\t\t\t\t\t\t\t\t`/api/method/press.api.client.run_doc_method?dt=Invoice&dn=${row.name}&method=stripe_payment_url`,\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\tthis.showBuyPrepaidCreditsDialog = true;\n\t\t\t\t\t\t\t\t\t\t\tthis.minimumAmount = row.amount_due;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tprefix(row) {\n\t\t\t\t\t\t\tif (row.stripe_payment_failed && row.status !== 'Paid') {\n\t\t\t\t\t\t\t\treturn h(Button, {\n\t\t\t\t\t\t\t\t\tvariant: 'ghost',\n\t\t\t\t\t\t\t\t\ttheme: 'red',\n\t\t\t\t\t\t\t\t\ticon: 'alert-circle',\n\t\t\t\t\t\t\t\t\tonClick(e) {\n\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\tconfirmDialog({\n\t\t\t\t\t\t\t\t\t\t\ttitle: 'Payment Failed',\n\t\t\t\t\t\t\t\t\t\t\tmessage: `<div class=\"space-y-4\"><p class=\"text-base\">Your payment with the card ending <strong>${row.stripe_payment_failed_card}</strong> failed for this invoice due to the following reason:</p><div class=\"text-sm font-mono text-gray-600 rounded p-2 bg-gray-100\">${row.stripe_payment_error}</div><p class=\"text-base\">Please change your payment method to pay this invoice.</p></div>`,\n\t\t\t\t\t\t\t\t\t\t\tprimaryAction: {\n\t\t\t\t\t\t\t\t\t\t\t\tlabel: 'Change Payment Method',\n\t\t\t\t\t\t\t\t\t\t\t\tvariant: 'solid',\n\t\t\t\t\t\t\t\t\t\t\t\tonClick: ({ hide }) => {\n\t\t\t\t\t\t\t\t\t\t\t\t\thide();\n\t\t\t\t\t\t\t\t\t\t\t\t\trouter.push({\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tname: 'BillingPaymentMethods',\n\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\torderBy: 'due_date desc, creation desc',\n\t\t\t\tonRowClick: (row) => {\n\t\t\t\t\tthis.showInvoice = row;\n\t\t\t\t\tthis.invoiceDialog = true;\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t},\n\tmethods: {\n\t\tformatCurrency(value) {\n\t\t\tif (value === 0) {\n\t\t\t\treturn '';\n\t\t\t}\n\t\t\treturn userCurrency(value);\n\t\t},\n\t},\n};\n</script>\n"],"names":["_sfc_main","value","row","dayjsLocal","start","end","e","h","Button","confirmDialog","hide","_hoisted_1","_openBlock","_createElementBlock","$data","_cache","$event","_withCtx","_Fragment","_createCommentVNode"],"mappings":"ghCA0CA,MAAAA,EAAA,yGAQC,MAAA,CACC,MAAA,CACC,cAAA,GACA,YAAA,KACA,4BAAA,GACA,cAAA,IAGF,SAAA,CACC,SAAA,CACC,MAAA,CACC,QAAA,UACA,OAAA,CACC,qBAEA,eACA,gCAEA,4BAEA,gBACA,qBAED,eAAA,IACC,CACC,4BAGC,MAAA,KAAA,UAAA,GAAA,OACA,UAAA,OACA,QAAA,CAAA,GAAA,eAAA,iBAAA,GAED,eAEC,MAAA,SACA,MAAA,KAAA,UAAA,GAAA,OACA,UAAA,SACA,QAAA,CACC,GACA,QACA,kBACA,SACA,kBAEA,4BAEA,WAKJ,QAAA,CACC,CACC,MAAA,UACA,UAAA,OACA,MAAA,cACA,OAAAC,EAAAC,EAAA,+BAEEC,EAAAD,EAAA,UAAA,sBAEDA,EAAA,MAAA,yDAKD,MAAA,IAED,CACC,MAAA,SACA,UAAA,qCAID,cAEC,UAAA,WACA,OAAAD,EAAAC,EAAA,4BAEE,IAAAE,EAAAD,EAAAD,EAAA,YAAA,EACAG,EAAAF,EAAAD,EAAA,UAAA,EAKA,MAAA,GAJAE,EAAA,KAAA,IAAAC,EAAA,KAAA,EAECD,EAAA,OAAA,OAAA,EACAA,EAAA,OAAA,IAAA,CACD,MAAAC,EAAA,OAAA,IAAA,CAAA,EACD,oBAIF,eAEC,UAAA,iDAGA,MAAA,IAED,CACC,MAAA,+EAIA,MAAA,IAED,CACC,MAAA,6EAIA,MAAA,IAED,CACC,MAAA,+BAGA,OAAA,CAAA,CAAA,IAAAH,KAAA,CACC,GAAAA,EAAA,aAAAA,EAAA,kBACC,MAAA,0BAEC,MAAA,wDAKE,OAAA,KAAAA,EAAA,iBAAA,+BAOJ,GAAAA,EAAA,SAAA,UAAAA,EAAA,WAAA,EACC,MAAA,CACC,MAAA,UACA,MAAA,wCAICI,EAAA,gBAAA,6JAMC,KAAA,4BAAA,GACA,KAAA,cAAAJ,EAAA,uEAQH,OAAAK,EAAAC,EAAA,CACC,QAAA,oBAEA,KAAA,0BAECF,EAAA,gBAAA,EACAG,EAAA,CACC,MAAA,iBACA,QAAA,yFAAAP,EAAA,0BAAA,0IAAAA,EAAA,oBAAA,8FACA,cAAA,+BAEC,QAAA,QACA,QAAA,CAAA,CAAA,KAAAQ,KAAA,CACCA,EAAA,sCAGA,CAAA,GAGH,CAAA,EAEF,CAAA,KAKJ,QAAA,+BACA,WAAAR,GAAA,CACC,KAAA,YAAAA,4BAMJ,QAAA,CACC,eAAAD,EAAA,cAEE,SAKJ,EAnPMU,EAAA,CAAA,MAAA,KAAA,WAUA,MAAA,wIAVL,OAAAC,EAAA,EAAAC,EAAA,MAAAF,EAAA,kDADD,WAAAG,EAAA,cAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,cAAAE,sEAOc,eAAAC,EAAA,IAAA,gBACVL,EAAA,EAAAC,EAAAK,EAAA,CAAA,IAAA,CAAA,EAAA,CAEQJ,EAAA,YAAA,SAAA,wHAVZK,EAAA,GAAA,EAAA,mFAAA,WAAAL,EAAA,4BAAA,sBAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAF,EAAA,4BAAAE,GAsBI,cAAAF,EAAA,qHAtBJK,EAAA,GAAA,EAAA"}