{"version":3,"file":"RolePermissions-CBBMOpms.js","sources":["../../../../dashboard/src2/components/settings/RolePermissions.vue"],"sourcesContent":["<template>\n\t<div class=\"mb-5 flex items-center gap-2\">\n\t\t<Tooltip text=\"All Roles\">\n\t\t\t<Button :route=\"{ name: 'SettingsPermissionRoles' }\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<i-lucide-arrow-left class=\"h-4 w-4 text-gray-700\" />\n\t\t\t\t</template>\n\t\t\t</Button>\n\t\t</Tooltip>\n\t\t<h3 class=\"text-lg font-medium text-gray-900\">\n\t\t\t{{ role.doc?.title }}\n\t\t</h3>\n\t\t<Tooltip text=\"Admin Role\" v-if=\"role.doc?.admin_access\">\n\t\t\t<FeatherIcon name=\"shield\" class=\"h-5 w-5 text-gray-700\" />\n\t\t</Tooltip>\n\t</div>\n\t<ObjectList\n\t\t:options=\"rolePermissions\"\n\t\t@update:selections=\"(e) => (selectedItems = e)\"\n\t>\n\t\t<template #header-left=\"{ listResource }\">\n\t\t\t<Dropdown :options=\"getDropdownOptions(listResource)\">\n\t\t\t\t<Button>\n\t\t\t\t\t<template #prefix>\n\t\t\t\t\t\t<LucideAppWindow class=\"h-4 w-4 text-gray-500\" />\n\t\t\t\t\t</template>\n\t\t\t\t\t{{ currentDropdownOption.label }}\n\t\t\t\t\t<template #suffix>\n\t\t\t\t\t\t<FeatherIcon name=\"chevron-down\" class=\"h-4 w-4 text-gray-500\" />\n\t\t\t\t\t</template>\n\t\t\t\t</Button>\n\t\t\t</Dropdown>\n\t\t</template>\n\t</ObjectList>\n</template>\n\n<script setup>\nimport {\n\tButton,\n\tDropdown,\n\tcreateDocumentResource,\n\tcreateResource,\n} from 'frappe-ui';\nimport { computed, h, ref } from 'vue';\nimport LucideAppWindow from '~icons/lucide/app-window';\nimport ObjectList from '../ObjectList.vue';\nimport { toast } from 'vue-sonner';\nimport { getToastErrorMessage } from '../../utils/toast';\nimport { confirmDialog, icon, renderDialog } from '../../utils/components';\nimport RoleConfigureDialog from './RoleConfigureDialog.vue';\n\nlet selectedItems = ref(new Set());\n\nconst props = defineProps({\n\troleId: { type: String, required: true },\n});\n\nconst role = createDocumentResource({\n\tdoctype: 'Press Role',\n\tname: props.roleId,\n\tauto: true,\n\twhitelistedMethods: {\n\t\taddUser: 'add_user',\n\t\tremoveUser: 'remove_user',\n\t\tbulkDelete: 'delete_permissions',\n\t},\n});\n\nconst docInsert = createResource({\n\turl: 'press.api.client.insert',\n});\n\nconst dropdownOptions = [\n\t{ label: 'Allowed Sites', doctype: 'Site', fieldname: 'site' },\n\t{\n\t\tlabel: 'Allowed Bench Groups',\n\t\tdoctype: 'Release Group',\n\t\tfieldname: 'release_group',\n\t},\n\t{ label: 'Allowed Servers', doctype: 'Server', fieldname: 'server' },\n];\nconst currentDropdownOption = ref(dropdownOptions[0]);\nfunction getDropdownOptions(listResource) {\n\treturn dropdownOptions.map((option) => {\n\t\treturn {\n\t\t\t...option,\n\t\t\tonClick: () => {\n\t\t\t\tcurrentDropdownOption.value = option;\n\t\t\t\tlet filters = {\n\t\t\t\t\trole: props.roleId,\n\t\t\t\t};\n\t\t\t\tif (option.doctype === 'Site') {\n\t\t\t\t\tfilters.site = ['is', 'set'];\n\t\t\t\t}\n\t\t\t\tif (option.doctype === 'Release Group') {\n\t\t\t\t\tfilters.release_group = ['is', 'set'];\n\t\t\t\t}\n\t\t\t\tif (option.doctype === 'Server') {\n\t\t\t\t\tfilters.server = ['is', 'set'];\n\t\t\t\t}\n\t\t\t\tlistResource.update({ filters });\n\t\t\t\tlistResource.reload();\n\t\t\t},\n\t\t};\n\t});\n}\n\nconst rolePermissions = ref({\n\tdoctype: 'Press Role Permission',\n\tfields: [\n\t\t'site',\n\t\t'site.host_name as site_host_name',\n\t\t'release_group',\n\t\t'release_group.title as release_group_title',\n\t\t'server',\n\t\t'server.title as server_title',\n\t],\n\tfilters: {\n\t\trole: props.roleId,\n\t\tsite: ['is', 'set'],\n\t},\n\tselectable: true,\n\tcolumns: [\n\t\t{\n\t\t\tlabel: computed(() =>\n\t\t\t\tcurrentDropdownOption.value.doctype.replace(\n\t\t\t\t\t'Release Group',\n\t\t\t\t\t'Bench Group',\n\t\t\t\t),\n\t\t\t),\n\t\t\tformat(_value, row) {\n\t\t\t\treturn (\n\t\t\t\t\trow.site_host_name ||\n\t\t\t\t\trow.site ||\n\t\t\t\t\trow.release_group_title ||\n\t\t\t\t\trow.server_title\n\t\t\t\t);\n\t\t\t},\n\t\t},\n\t],\n\tactions({ listResource: permissions }) {\n\t\treturn [\n\t\t\t{\n\t\t\t\tlabel: 'Configure',\n\t\t\t\tslots: {\n\t\t\t\t\tprefix: icon('settings'),\n\t\t\t\t},\n\t\t\t\tonClick() {\n\t\t\t\t\trenderDialog(h(RoleConfigureDialog, { roleId: props.roleId }));\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\tlabel: 'Delete',\n\t\t\t\tslots: {\n\t\t\t\t\tprefix: icon('trash-2'),\n\t\t\t\t},\n\t\t\t\tcondition: () => selectedItems.value.size > 0,\n\t\t\t\tonClick() {\n\t\t\t\t\trole.bulkDelete.submit(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpermissions: Array.from(selectedItems.value),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tonSuccess: () => {\n\t\t\t\t\t\t\t\ttoast.success('Items deleted successfully');\n\t\t\t\t\t\t\t\tselectedItems.value.clear();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\tlabel: 'Add',\n\t\t\t\tslots: {\n\t\t\t\t\tprefix: icon('plus'),\n\t\t\t\t},\n\t\t\t\tonClick() {\n\t\t\t\t\tconfirmDialog({\n\t\t\t\t\t\ttitle: 'Add Permission',\n\t\t\t\t\t\tmessage: '',\n\t\t\t\t\t\tfields: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlabel: `Select ${currentDropdownOption.value.doctype.replace(\n\t\t\t\t\t\t\t\t\t'Release Group',\n\t\t\t\t\t\t\t\t\t'Bench Group',\n\t\t\t\t\t\t\t\t)}`,\n\t\t\t\t\t\t\t\ttype: 'link',\n\t\t\t\t\t\t\t\tfieldname: 'document_name',\n\t\t\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\t\t\tdoctype: currentDropdownOption.value.doctype,\n\t\t\t\t\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\t\t\t\tname: [\n\t\t\t\t\t\t\t\t\t\t\t'not in',\n\t\t\t\t\t\t\t\t\t\t\tpermissions.data.map(\n\t\t\t\t\t\t\t\t\t\t\t\t(p) => p[currentDropdownOption.value.fieldname],\n\t\t\t\t\t\t\t\t\t\t\t) || '',\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\tstatus: ['!=', 'Archived'],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t\tprimaryAction: {\n\t\t\t\t\t\t\tlabel: 'Add',\n\t\t\t\t\t\t\tonClick({ values }) {\n\t\t\t\t\t\t\t\tlet key = currentDropdownOption.value.fieldname;\n\n\t\t\t\t\t\t\t\ttoast.promise(\n\t\t\t\t\t\t\t\t\tdocInsert.submit({\n\t\t\t\t\t\t\t\t\t\tdoc: {\n\t\t\t\t\t\t\t\t\t\t\tdoctype: 'Press Role Permission',\n\t\t\t\t\t\t\t\t\t\t\trole: props.roleId,\n\t\t\t\t\t\t\t\t\t\t\t[key]: values.document_name,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tloading: 'Adding permission...',\n\t\t\t\t\t\t\t\t\t\tsuccess() {\n\t\t\t\t\t\t\t\t\t\t\tpermissions.reload();\n\t\t\t\t\t\t\t\t\t\t\treturn 'Permission added successfully';\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\terror: (e) => getToastErrorMessage(e),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t].filter((action) => (action.condition ? action.condition() : true));\n\t},\n});\n</script>\n"],"names":["selectedItems","ref","props","__props","role","createDocumentResource","docInsert","createResource","dropdownOptions","currentDropdownOption","getDropdownOptions","listResource","option","__spreadProps","__spreadValues","filters","rolePermissions","computed","_value","row","permissions","icon","renderDialog","h","RoleConfigureDialog","toast","confirmDialog","p","values","key","e","getToastErrorMessage","action"],"mappings":"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"}