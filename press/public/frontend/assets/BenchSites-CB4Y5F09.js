var N=(e,s,p)=>new Promise((A,o)=>{var u=c=>{try{g(p.next(c))}catch(_){o(_)}},w=c=>{try{g(p.throw(c))}catch(_){o(_)}},g=c=>c.done?A(c.value):Promise.resolve(c.value).then(u,w);g((p=p.apply(e,s)).next())});import{_ as M}from"./ClickToCopyField-DpU9Eau5.js";import{x as E,h as m,o as t,w as d,j as n,ag as oe,au as ie,t as h,q as l,u as b,A as a,a9 as U,aA as j,r as re,ae,F as y,v as C,Y as S,a5 as le,X as ce,C as de,B as ue,n as me,y as he,a7 as pe,a8 as be,a6 as ge}from"./main-Dpl-JOF2.js";import{_ as _e}from"./ListItem-CkkFcC1t.js";import{_ as z}from"./CommitTag-C7m6nG0N.js";import{_ as P,a as q,b as O,c as W}from"./TableHeader-DvqcS5cY.js";import{l as fe}from"./loginAsAdmin-BAeVrwth.js";import{n as H}from"./toast-Dk0nDfLL.js";(function(){try{var e=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},s=new Error().stack;s&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[s]="191ea6a6-8fe8-41f1-9267-abe7d79af5dd",e._sentryDebugIdIdentifier="sentry-dbid-191ea6a6-8fe8-41f1-9267-abe7d79af5dd")}catch(p){}})();{var x=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};x._sentryModuleMetadata=x._sentryModuleMetadata||{},x._sentryModuleMetadata[new Error().stack]=Object.assign({},x._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:press-dashboard":!0})}const ve={name:"CreateCodeServerDialog",props:["version","show"],data(){return{dialogOpen:!0,modelValue:"",errorMessage:null,domain:"frappe.space",subdomain:"",subdomainAvailable:!1}},methods:{subdomainChange(e){return N(this,null,function*(){this.subdomain=e.target.value,this.subdomainAvailable=!1;let s=this.validateSubdomain(this.subdomain);s||((yield this.$call("press.api.spaces.exists",{subdomain:this.subdomain,domain:this.domain}))?s=`${this.subdomain}.${this.domain} already exists.`:this.subdomainAvailable=!0),this.errorMessage=s,this.$emit("error",s)})},validateSubdomain(e){return e?e.length<5?"Subdomain too short. Use 5 or more characters":e.length>32?"Subdomain too long. Use 32 or less characters":e.match(/^[a-z0-9][a-z0-9-]*[a-z0-9]$/)?null:"Subdomain contains invalid characters. Use lowercase characters, numbers and hyphens":"Subdomain cannot be empty"}},resources:{newCodeServer(){return{url:"press.api.spaces.create_code_server",params:{subdomain:this.subdomain,bench:this.version,domain:this.domain},onSuccess(e){this.$router.replace(`/codeservers/${e}/jobs`)},onError(e){this.errorMessage=e.message}}}}},ye={class:"mt-4 flex"},we={class:"flex items-center rounded-r bg-gray-100 px-4 text-base"},Ce={class:"mt-1"},xe={key:0,class:"text-sm text-green-600",role:"alert"};function Se(e,s,p,A,o,u){const w=U,g=j;return t(),m(g,{options:{title:"Create Code Server",actions:[{label:"Create",variant:"solid",loading:e.$resources.newCodeServer.loading,onClick:()=>e.$resources.newCodeServer.submit()}]},modelValue:p.show,onAfterLeave:s[2]||(s[2]=()=>{e.$emit("close",!0)})},{"body-content":d(()=>[s[3]||(s[3]=n("p",{class:"text-base text-gray-700"}," Give your code server a unique name. It can only contain alphanumeric characters and dashes. ",-1)),n("div",ye,[oe(n("input",{class:"form-input z-10 w-full rounded-r-none",type:"text","onUpdate:modelValue":s[0]||(s[0]=c=>o.modelValue=c),placeholder:"subdomain",onChange:s[1]||(s[1]=(...c)=>u.subdomainChange&&u.subdomainChange(...c))},null,544),[[ie,o.modelValue]]),n("div",we," ."+h(o.domain),1)]),n("div",Ce,[o.subdomainAvailable?(t(),l("div",xe,h(o.modelValue)+"."+h(o.domain)+" is available ",1)):b("",!0),a(w,{message:o.errorMessage},null,8,["message"])])]),_:1},8,["options","modelValue"])}const Ae=E(ve,[["render",Se]]),ke={name:"BenchSites",props:["bench","benchName"],components:{Table:W,TableHeader:O,TableRow:q,TableCell:P,ClickToCopyField:M,CommitTag:z,CodeServer:Ae},data(){return{reasonForAdminLogin:"",errorMessage:null,selectedVersionIndex:0,showSSHDialog:!1,showCodeServerDialog:!1,showAppsDialog:!1,showReasonForAdminLoginDialog:!1,siteForLogin:null}},resources:{versions(){return{url:"press.api.bench.versions",params:{name:this.benchName},auto:!0}},versionApps(){return{url:"press.api.bench.get_installed_apps_in_version"}},loginAsAdmin(){return fe("placeholderSite")},getCertificate(){return{url:"press.api.bench.certificate",params:{name:this.benchName},auto:!0}},generateCertificate(){var e;return{url:"press.api.bench.generate_certificate",params:{name:(e=this.bench)==null?void 0:e.name},onSuccess(){this.$resources.getCertificate.reload()}}},restartBench(){var e;return{url:"press.api.bench.restart",params:{name:(e=this.versions[this.selectedVersionIndex])==null?void 0:e.name}}},rebuildBench(){var e;return{url:"press.api.bench.rebuild",params:{name:(e=this.versions[this.selectedVersionIndex])==null?void 0:e.name}}},updateAllSites(){return{url:"press.api.bench.update",onSuccess(){var e;H({title:"Site update scheduled successfully",message:`All sites in ${(e=this.versions[this.selectedVersionIndex])==null?void 0:e.name} will be updated to the latest version`,icon:"check",color:"green"})},onError(e){H({title:"Error",message:e.messages.join(", "),icon:"x",color:"red"})}}}},methods:{dropdownItems(e){return[{label:"Visit Site",onClick:()=>{window.open(`https://${e.name}/apps`,"_blank")}},{label:"Login As Admin",onClick:()=>{if(this.$account.team.name===e.team)return this.$resources.loginAsAdmin.submit({name:e.name});this.siteForLogin=e.name,this.showReasonForAdminLoginDialog=!0}}]},benchDropdownItems(e){return[{label:"View in Desk",onClick:()=>{window.open(`${window.location.protocol}//${window.location.host}/app/bench/${this.versions[e].name}`,"_blank")},condition:()=>this.$account.user.user_type==="System User"},{label:"SSH Access",onClick:()=>{this.selectedVersionIndex=e,this.showSSHDialog=!0},condition:()=>this.versions[e].status==="Active"&&this.$account.ssh_key&&this.versions[e].is_ssh_proxy_setup&&this.permissions.sshAccess},{label:"View Logs",onClick:()=>{this.$router.push(`/groups/${this.bench.name}/logs/${this.versions[e].name}/`)},condition:()=>this.versions[e].status==="Active"},{label:"Update All Sites",onClick:()=>{var s;this.$resources.updateAllSites.submit({name:(s=this.versions[e])==null?void 0:s.name})},condition:()=>this.versions[e].status==="Active"&&e>0&&this.versions[e].sites.length>0},{label:"Restart Bench",onClick:()=>{this.selectedVersionIndex=e,this.confirmRestart()},condition:()=>this.versions[e].status==="Active"&&this.permissions.restartBench},{label:"Build Assets",onClick:()=>{this.selectedVersionIndex=e,this.confirmRebuild()},condition:()=>this.versions[e].status==="Active"&&(+(this.versions[e].version.split(" ")[1]>13)||this.versions[e].version==="Nightly")&&this.permissions.rebuildBench},{label:"Create Code Server",onClick:()=>{this.selectedVersionIndex=e,this.showCodeServerDialog=!0},condition:()=>this.$account.team.code_servers_enabled}].filter(s=>s.condition?s.condition():!0)},proceedWithLoginAsAdmin(){if(this.errorMessage="",!this.reasonForAdminLogin.trim()){this.errorMessage="Reason is required";return}this.$resources.loginAsAdmin.submit({name:this.siteForLogin,reason:this.reasonForAdminLogin}),this.showReasonForAdminLoginDialog=!1},confirmRestart(){this.$confirm({title:"Restart Bench",message:`
					<b>bench restart</b> command will be executed on your bench. This will temporarily stop all web and backgound workers. Are you sure
					you want to run this command?
				`,actionLabel:"Restart Bench",actionColor:"red",action:e=>{this.$resources.restartBench.submit(),e()}})},confirmRebuild(){this.$confirm({title:"Build Assets",message:`
					<b>bench build</b> command will be executed on your bench. This will regenerate all static assets. Are you sure
					you want to run this command?
				`,actionLabel:"Build Assets",actionColor:"red",action:e=>{this.$resources.rebuildBench.submit(),e()}})}},computed:{permissions(){return{restartBench:this.$account.hasPermission(this.benchName,"press.api.bench.restart"),rebuildBench:this.$account.hasPermission(this.benchName,"press.api.bench.rebuild"),sshAccess:this.$account.hasPermission(this.benchName,"press.api.bench.generate_certificate")}},versions(){if(!this.$resources.versions.data)return[];for(let e of this.$resources.versions.data)for(let s of e.sites)s.route={name:"SiteOverview",params:{siteName:s.name}};return this.$resources.versions.data},certificate(){return this.$resources.getCertificate.data},sshCommand(){var e,s;return this.versions[this.selectedVersionIndex]?`ssh ${(e=this.versions[this.selectedVersionIndex])==null?void 0:e.name}@${(s=this.versions[this.selectedVersionIndex])==null?void 0:s.proxy_server} -p 2222`:null},certificateCommand(){var e;return this.certificate?`echo '${(e=this.certificate.ssh_certificate)==null?void 0:e.trim()}' > ~/.ssh/id_${this.certificate.key_type}-cert.pub`:null}}},$e={class:"space-y-8"},Ve={class:"flex items-center justify-center"},De={key:1,class:"mt-8"},Te={class:"flex w-full items-center justify-between rounded-t bg-gray-50 px-3 py-2 text-base"},Ie=["title"],Be={class:"flex items-center space-x-2"},Le={key:0,class:"flex items-center justify-center border-b py-4.5"},Fe={key:1,class:"hidden space-x-1 sm:flex"},Re={key:2,class:"hidden sm:block"},Ne={key:3,class:"hidden sm:block"},He=["src","alt","title"],Me={key:1,class:"text-base text-gray-700"},Ee={key:4,class:"w-full text-right"},Ue={key:5},je={class:"mt-1 flex items-center space-x-2 text-gray-600"},ze={class:"truncate text-base hover:text-clip"},Pe={key:0,class:"space-y-4",style:{"max-width":"29rem"}},qe={class:"space-y-2"},Oe={class:"space-y-1"},We={class:"space-y-2"},Ye={class:"space-y-1"},Ke={key:1};function Xe(e,s,p,A,o,u){var B;const w=O,g=ae,c=le,_=ce,V=ue,D=de,Y=he,K=P,X=q,J=W,Q=z,Z=_e,k=j,G=be,T=U,I=M,ee=re("CodeServer");return t(),l(y,null,[n("div",$e,[a(J,{columns:[{label:"Site Name",name:"name",width:2},{label:"Status",name:"status"},{label:"Region",name:"region"},{label:"Tags",name:"tags"},{label:"Plan",name:"plan"},{label:"",name:"actions",width:.5}],rows:u.versions},{default:d(({rows:i,columns:se})=>[i.length!==0?(t(),m(w,{key:0,class:"mb-4 hidden sm:grid"})):b("",!0),n("div",Ve,[e.$resources.versions.loading?(t(),m(g,{key:0,class:"mt-8"})):i.length===0?(t(),l("div",De,s[7]||(s[7]=[n("div",{class:"text-base text-gray-700"},"No Sites",-1)]))):b("",!0)]),(t(!0),l(y,null,C(i,(f,te)=>{var L;return t(),l("div",{key:f.name,class:"mb-4 rounded border"},[n("div",Te,[n("span",{class:"cursor-default font-semibold text-gray-900",title:f.deployed_on?"Deployed on "+e.formatDate(f.deployed_on,"DATETIME_SHORT",!0):""},[S(h(f.name)+" ",1),a(c,{label:f.status,class:"ml-2"},null,8,["label"])],8,Ie),n("div",Be,[a(_,{variant:"ghost",label:"Show Apps",onClick:r=>{e.$resources.versionApps.submit({name:f.name}),o.showAppsDialog=!0}},null,8,["onClick"]),a(D,{options:u.benchDropdownItems(te)},{default:d(({open:r})=>[a(_,{variant:"ghost"},{icon:d(()=>[a(V,{name:"more-horizontal",class:"h-4 w-4"})]),_:1})]),_:2},1032,["options"])])]),(L=f.sites)!=null&&L.length?b("",!0):(t(),l("div",Le,s[8]||(s[8]=[n("div",{class:"text-base text-gray-600"},"No Sites",-1)]))),(t(!0),l(y,null,C(f.sites,(r,ne)=>(t(),m(X,{key:r.name,row:r,class:me(ne===0?"rounded-b":"rounded")},{default:d(()=>[(t(!0),l(y,null,C(se,v=>(t(),m(K,null,{default:d(()=>{var F,R;return[v.name==="status"?(t(),m(c,{key:0,label:e.$siteStatus(r)},null,8,["label"])):v.name==="tags"&&r.tags?(t(),l("div",Fe,[(t(!0),l(y,null,C(r.tags.slice(0,1),$=>(t(),m(c,{theme:"blue",label:$},null,8,["label"]))),256)),r.tags.length>1?(t(),m(Y,{key:0,text:r.tags.slice(1).join(", ")},{default:d(()=>[r.tags.length>1?(t(),m(c,{key:0,label:`+${r.tags.length-1}`},null,8,["label"])):b("",!0)]),_:2},1032,["text"])):b("",!0)])):v.name==="plan"?(t(),l("span",Re,h(r.plan?`${e.$planTitle(r.plan)}${r.plan.price_usd>0?"/mo":""}`:""),1)):v.name==="region"?(t(),l("div",Ne,[(F=r.server_region_info)!=null&&F.image?(t(),l("img",{key:0,class:"h-4",src:r.server_region_info.image,alt:`Flag of ${r.server_region_info.title}`,title:r.server_region_info.title},null,8,He)):(t(),l("span",Me,h((R=r.server_region_info)==null?void 0:R.title),1))])):v.name=="actions"?(t(),l("div",Ee,[a(D,{onClick:s[0]||(s[0]=pe(()=>{},["prevent"])),options:u.dropdownItems(r)},{default:d(({open:$})=>[a(_,{variant:$?"subtle":"ghost",icon:"more-horizontal"},null,8,["variant"])]),_:2},1032,["options"])])):(t(),l("span",Ue,h(r[v.name]||""),1))]}),_:2},1024))),256))]),_:2},1032,["row","class"]))),128))])}),128))]),_:1},8,["rows"])]),a(k,{options:{title:"Apps",size:"xl"},modelValue:o.showAppsDialog,"onUpdate:modelValue":s[1]||(s[1]=i=>o.showAppsDialog=i)},{"body-content":d(()=>[(t(!0),l(y,null,C(e.$resources.versionApps.data,i=>(t(),m(Z,{class:"mb-3 flex items-center rounded-md border px-4 py-3 shadow ring-1 ring-gray-300",key:i.app,title:i.app},{subtitle:d(()=>[n("div",je,[a(V,{name:"git-branch",class:"h-4 w-4"}),n("div",ze,h(i.repository_owner)+"/"+h(i.repository)+":"+h(i.branch),1)])]),actions:d(()=>[a(Q,{tag:i.tag||i.hash.substr(0,7),class:"ml-2",link:`${i.repository_url}/commit/${i.hash}`},null,8,["tag","link"])]),_:2},1032,["title"]))),128)),e.$resources.versionApps.loading?(t(),m(g,{key:0,class:"justify-center"})):b("",!0)]),_:1},8,["modelValue"]),a(k,{options:{title:"Login As Administrator",actions:[{label:"Proceed",variant:"solid",onClick:u.proceedWithLoginAsAdmin}]},modelValue:o.showReasonForAdminLoginDialog,"onUpdate:modelValue":s[3]||(s[3]=i=>o.showReasonForAdminLoginDialog=i)},{"body-content":d(()=>[a(G,{label:"Reason for logging in as Administrator",type:"textarea",modelValue:o.reasonForAdminLogin,"onUpdate:modelValue":s[2]||(s[2]=i=>o.reasonForAdminLogin=i),required:""},null,8,["modelValue"]),a(T,{class:"mt-3",message:o.errorMessage},null,8,["message"])]),_:1},8,["options","modelValue"]),a(k,{options:{title:"SSH Access"},modelValue:o.showSSHDialog,"onUpdate:modelValue":s[5]||(s[5]=i=>o.showSSHDialog=i)},ge({"body-content":d(()=>[u.certificate?(t(),l("div",Pe,[n("div",qe,[s[10]||(s[10]=n("h4",{class:"text-base font-semibold text-gray-700"},"Step 1",-1)),n("div",Oe,[s[9]||(s[9]=n("p",{class:"text-base"}," Execute the following shell command to store the SSH certificate locally. ",-1)),a(I,{textContent:u.certificateCommand},null,8,["textContent"])])]),n("div",We,[s[12]||(s[12]=n("h4",{class:"text-base font-semibold text-gray-700"},"Step 2",-1)),n("div",Ye,[s[11]||(s[11]=n("p",{class:"text-base"}," Execute the following shell command to SSH into your bench ",-1)),a(I,{textContent:u.sshCommand},null,8,["textContent"])])])])):b("",!0),u.certificate?b("",!0):(t(),l("div",Ke,s[13]||(s[13]=[n("p",{class:"mb-4 text-base"}," You will need an SSH certificate to get SSH access to your bench. This certificate will work only with your public-private key pair and will be valid for 6 hours. ",-1),n("p",{class:"text-base"},[S(" Please refer to the "),n("a",{href:"/docs/benches/ssh",class:"underline"},"SSH Access documentation"),S(" for more details. ")],-1)])))]),default:d(()=>[a(T,{class:"mt-3",message:e.$resources.generateCertificate.error},null,8,["message"])]),_:2},[u.certificate?void 0:{name:"actions",fn:d(()=>[a(_,{loading:e.$resources.generateCertificate.loading,onClick:s[4]||(s[4]=i=>e.$resources.generateCertificate.fetch()),variant:"solid",class:"w-full"},{default:d(()=>s[14]||(s[14]=[S("Generate SSH Certificate")])),_:1},8,["loading"])]),key:"0"}]),1032,["modelValue"]),a(ee,{show:o.showCodeServerDialog,onClose:s[6]||(s[6]=i=>o.showCodeServerDialog=!1),version:(B=u.versions[o.selectedVersionIndex])==null?void 0:B.name},null,8,["show","version"])],64)}const os=E(ke,[["render",Xe]]);export{os as default};
//# sourceMappingURL=BenchSites-CB4Y5F09.js.map
